<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>RUM: rum_src/mac_route.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>rum_src/mac_route.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) 2008  ATMEL Corporation</span>
<a name="l00002"></a>00002 <span class="comment">   All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">   Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment">   modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">   * Redistributions of source code must retain the above copyright</span>
<a name="l00008"></a>00008 <span class="comment">     notice, this list of conditions and the following disclaimer.</span>
<a name="l00009"></a>00009 <span class="comment">   * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00010"></a>00010 <span class="comment">     notice, this list of conditions and the following disclaimer in</span>
<a name="l00011"></a>00011 <span class="comment">     the documentation and/or other materials provided with the</span>
<a name="l00012"></a>00012 <span class="comment">     distribution.</span>
<a name="l00013"></a>00013 <span class="comment">   * Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment">     contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment">     from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span>
<a name="l00018"></a>00018 <span class="comment">  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00019"></a>00019 <span class="comment">  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00020"></a>00020 <span class="comment">  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="l00021"></a>00021 <span class="comment">  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00022"></a>00022 <span class="comment">  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00023"></a>00023 <span class="comment">  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00024"></a>00024 <span class="comment">  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00025"></a>00025 <span class="comment">  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00026"></a>00026 <span class="comment">  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00027"></a>00027 <span class="comment">  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00028"></a>00028 <span class="comment">*/</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include "mac.h"</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include "mac_associate.h"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include "mac_data.h"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "timer.h"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "radio.h"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "hal.h"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "mac_route.h"</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00048"></a><a class="code" href="group__mac.html#g88d7808a53f2a5b65445f782c75c61e6">00048</a> <span class="keywordtype">void</span> <a class="code" href="group__mac.html#g88d7808a53f2a5b65445f782c75c61e6" title="Send routing packet down the chain, removing own address from the list of addresses...">macForwardRoutingPacket</a>(<span class="keywordtype">void</span>)
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g5794c1a5f0eedfe85aea59330c25848a" title="Router node.">ROUTER</a>)
<a name="l00051"></a>00051     {
<a name="l00052"></a>00052         u8 payloadLength = ((<a class="code" href="structrx__frame__t.html" title="This struct defines the rx data container.">rx_frame_t</a>*)<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>)-&gt;length - <span class="keyword">sizeof</span>(<a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a>);
<a name="l00053"></a>00053         <a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a> *frame = (<a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a>*)(<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>+1);
<a name="l00054"></a>00054         u16 *p;  <span class="comment">// pointer to list of addresses in incoming routing packet</span>
<a name="l00055"></a>00055         u8 hopCount = payloadLength/2; <span class="comment">// convert from bytes to words</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         <span class="comment">// Copy rx to tx, since we are forwarding packet</span>
<a name="l00058"></a>00058         macCopyRxToTx();
<a name="l00059"></a>00059 
<a name="l00060"></a>00060         <span class="comment">// Don't send packets unless we have a valid short address</span>
<a name="l00061"></a>00061         <span class="keywordflow">if</span> (!<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b90d9d43eb3ae9d98e9cd556272bf464" title="Is this node associated with a network?">associated</a>)
<a name="l00062"></a>00062             <span class="keywordflow">return</span>;
<a name="l00063"></a>00063 
<a name="l00064"></a>00064         <span class="comment">// set pointer to first address</span>
<a name="l00065"></a>00065         p = &amp;frame-&gt;<a class="code" href="structftRouting.html#cb69197a8e661b50d8c4681972b13f90" title="First of a list of short addresses that describe the route.">shortAddr</a>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="comment">// set last route address in MAC</span>
<a name="l00068"></a>00068         <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a> = p[hopCount-1];
<a name="l00069"></a>00069 
<a name="l00070"></a>00070         debugMsgStr(<span class="stringliteral">"\r\nSet route="</span>);
<a name="l00071"></a>00071         debugMsgHex(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a>);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <span class="keywordflow">if</span> (hopCount &gt; 1)
<a name="l00074"></a>00074         {
<a name="l00075"></a>00075             <span class="comment">// must forward to next address in chain</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077             <span class="comment">// remove last address from list</span>
<a name="l00078"></a>00078             hopCount--;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080             frame-&gt;<a class="code" href="structftRouting.html#327cea1b90eb5b8a4b87d740b7b0d133" title="Frame Control Field, see FCF_ROUTE.">fcf</a> = <a class="code" href="group__mac.html#gf9ba84abf7a2b6c682027c7ab28d1b90" title="Routing frame, short src and dest, ack, MAC frame.">FCF_ROUTE</a>;
<a name="l00081"></a>00081             frame-&gt;<a class="code" href="structftRouting.html#49bd4f680bc2960eda8eec459fb70467" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00082"></a>00082             frame-&gt;<a class="code" href="structftRouting.html#22158de9096a1a35361e33d6ab6685b6" title="Short address of receiving node.">destAddr</a> = p[hopCount];
<a name="l00083"></a>00083             frame-&gt;<a class="code" href="structftRouting.html#178b8337f5bf13af0e2fa8df398ccc34" title="Short address of sending node.">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00084"></a>00084             frame-&gt;<a class="code" href="structftRouting.html#573b8f21b52ef3e6b045c389a9e8904a" title="MAC command byte, see ROUTING_PACKET.">cmd</a> = <a class="code" href="group__mac.html#g1bad177d49cd2ab85b180af9e34fe24a" title="Routing packet MAC type.">ROUTING_PACKET</a>;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086             <span class="comment">// send out routing packet</span>
<a name="l00087"></a>00087             <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a>) + (hopCount-1)*2, (u8*)frame);
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="keywordtype">void</span> macRouteAssociateResponse(<span class="keywordtype">void</span>)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <span class="comment">// Send the mac packet down the chain</span>
<a name="l00096"></a>00096     <span class="comment">// The incoming packet is not for this node, therefore</span>
<a name="l00097"></a>00097     <span class="comment">// the incoming packet is an indirect packet.</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g5794c1a5f0eedfe85aea59330c25848a" title="Router node.">ROUTER</a>)
<a name="l00100"></a>00100     {
<a name="l00101"></a>00101         <span class="comment">// find out if we are sending to the endnode.</span>
<a name="l00102"></a>00102         <a class="code" href="structftAssocRespIndirect.html" title="Indirect association response frame, sent from the coordinator and (possibly) forwarded...">ftAssocRespIndirect</a>* inputFrame = (<a class="code" href="structftAssocRespIndirect.html" title="Indirect association response frame, sent from the coordinator and (possibly) forwarded...">ftAssocRespIndirect</a>*) (<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>+1);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="comment">// Don't send packets unless we have a valid short address</span>
<a name="l00105"></a>00105         <span class="keywordflow">if</span> (!<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b90d9d43eb3ae9d98e9cd556272bf464" title="Is this node associated with a network?">associated</a>)
<a name="l00106"></a>00106             <span class="keywordflow">return</span>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="keywordflow">if</span> (inputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#b35d58f7cf8feb99c21d1931eaf2e202" title="Short address of new node&amp;#39;s parent.">parentAddr</a> == <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>)
<a name="l00109"></a>00109         {
<a name="l00110"></a>00110             <span class="comment">// This frame is being sent from me (a router) to the newly</span>
<a name="l00111"></a>00111             <span class="comment">// associated node. We have to translate from indirect to</span>
<a name="l00112"></a>00112             <span class="comment">// direct frame format</span>
<a name="l00113"></a>00113             <a class="code" href="structftAssocRespDirect.html" title="Direct association response frame, sent from the new parent (coordinator or router)...">ftAssocRespDirect</a> *outputFrame = (<a class="code" href="structftAssocRespDirect.html" title="Direct association response frame, sent from the new parent (coordinator or router)...">ftAssocRespDirect</a>*) <a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#9828594de45905f57a0fb207b8513a23" title="Frame Control Field, see FCF_ASSOC_RESP_DIRECT.">fcf</a> = <a class="code" href="group__mac.html#g58b9c080c01f495671fb859eb86217cd" title="Direct association response, short src, long dest, ack, MAC frame.">FCF_ASSOC_RESP_DIRECT</a>;
<a name="l00116"></a>00116             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#78289360ff2be58f18c957702788f69c" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00117"></a>00117             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#91a85ae39b82cde37382a94c15560b8d" title="The PAN ID for the network.">panid</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>;
<a name="l00118"></a>00118             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#e41ca473a0e1149621592a7c5945af7a" title="Long MAC address of new node.">dstAddr</a> = inputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#305207d2a4da60c59125150788c0863d" title="Long MAC address of new node.">macAddr</a>;
<a name="l00119"></a>00119             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#427f736866eb04591dcc02f17d8b5019" title="Sender (new parent)&amp;#39;s short address.">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00120"></a>00120             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#7ae3d32b036eeab65a266f7689b57459" title="MAC command byte, see ASSOCIATION_RESPONSE.">cmd</a> = <a class="code" href="group__mac.html#g5e527382f4db88d62ce9aba61fe0b75b" title="Association response.">ASSOCIATION_RESPONSE</a>;
<a name="l00121"></a>00121             outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#de48bef764b8c3455bf7395ba46f58ce" title="Newly-assigned short address for newly-associated node.">shortAddr</a> = inputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#31fce7df621f2703f50367fec4ea07b7" title="Newly-assigned short address for newly-associated node.">shortAddr</a>;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123             <span class="comment">// Add this new node to child table</span>
<a name="l00124"></a>00124             <a class="code" href="group__mac__associate.html#g3ac1cb22fa29ec5180f1c0d3eaaf7839" title="Add a newly-associated node to this router&amp;#39;s child table.">macAddChild</a>(outputFrame-&gt;<a class="code" href="structftAssocRespDirect.html#de48bef764b8c3455bf7395ba46f58ce" title="Newly-assigned short address for newly-associated node.">shortAddr</a>);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126             <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftAssocRespDirect.html" title="Direct association response frame, sent from the new parent (coordinator or router)...">ftAssocRespDirect</a>),(u8*)outputFrame);
<a name="l00127"></a>00127         }
<a name="l00128"></a>00128         <span class="keywordflow">else</span>
<a name="l00129"></a>00129         {
<a name="l00130"></a>00130             <span class="comment">// This frame is being forwarded to a downstream router, not an</span>
<a name="l00131"></a>00131             <span class="comment">// end node.  Just re-use the input packet, and change the</span>
<a name="l00132"></a>00132             <span class="comment">// addresses for src/dest.</span>
<a name="l00133"></a>00133             <a class="code" href="structftAssocRespIndirect.html" title="Indirect association response frame, sent from the coordinator and (possibly) forwarded...">ftAssocRespIndirect</a> *outputFrame = (<a class="code" href="structftAssocRespIndirect.html" title="Indirect association response frame, sent from the coordinator and (possibly) forwarded...">ftAssocRespIndirect</a>*) (<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>+1);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135             macCopyRxToTx();
<a name="l00136"></a>00136             outputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#c179af5daf5e38bd37331975e0a4c499" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00137"></a>00137             outputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#3f281f5e5b57c09f916681268e865421" title="Short address of node receiving this packet.">dstAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a>;
<a name="l00138"></a>00138             outputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#1eee9a8688e3581084a31a0324bf4448" title="Short address of node sending this packet.">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140             <span class="comment">// Also, check to see if the parent of the new node is one of my</span>
<a name="l00141"></a>00141             <span class="comment">// children.  This is needed because the routing packet mechanism</span>
<a name="l00142"></a>00142             <span class="comment">// doesn't work properly for a three-hop route.</span>
<a name="l00143"></a>00143             <span class="keywordflow">if</span> (<a class="code" href="group__mac__associate.html#ged6df4ec4a8b1f717d6591f7bc73627a" title="Determine if a given node is a child if this node.">macIsChild</a>(outputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#b35d58f7cf8feb99c21d1931eaf2e202" title="Short address of new node&amp;#39;s parent.">parentAddr</a>))
<a name="l00144"></a>00144                 outputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#3f281f5e5b57c09f916681268e865421" title="Short address of node receiving this packet.">dstAddr</a> = outputFrame-&gt;<a class="code" href="structftAssocRespIndirect.html#b35d58f7cf8feb99c21d1931eaf2e202" title="Short address of new node&amp;#39;s parent.">parentAddr</a>;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146             <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftAssocRespIndirect.html" title="Indirect association response frame, sent from the coordinator and (possibly) forwarded...">ftAssocRespIndirect</a>),(u8*)outputFrame);
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="keywordtype">void</span> macRouteAssociateRequest(<span class="keywordtype">void</span>)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="comment">// This router node has received an association request packet.  We must</span>
<a name="l00154"></a>00154     <span class="comment">// Send this packet along, and if the packet came from a MAC address, then</span>
<a name="l00155"></a>00155     <span class="comment">// we must translate from a direct packet to an indirect packet.</span>
<a name="l00156"></a>00156     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g5794c1a5f0eedfe85aea59330c25848a" title="Router node.">ROUTER</a>)
<a name="l00157"></a>00157     {
<a name="l00158"></a>00158         <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>[2] == (<a class="code" href="group__mac.html#g8554c6f65951e156a8385590d36debfd" title="Direct association request, long src, short dest, ack, MAC frame.">FCF_ASSOC_REQ_DIRECT</a> &gt;&gt; 8)) <span class="comment">// Direct from MAC addr?</span>
<a name="l00159"></a>00159         {
<a name="l00160"></a>00160             <span class="comment">// translate from direct to indirect</span>
<a name="l00161"></a>00161             <a class="code" href="structftAssocReqDirect.html" title="Direct association request frame, sent by a new node trying to join the nework, to...">ftAssocReqDirect</a> *input = (<a class="code" href="structftAssocReqDirect.html" title="Direct association request frame, sent by a new node trying to join the nework, to...">ftAssocReqDirect</a>*)(<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>+1);
<a name="l00162"></a>00162             <a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a> output;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164             output.<a class="code" href="structftAssocReqIndirect.html#097195f2f03bea89ff0785c6cd9f26bf" title="Frame Control Field, see FCF_ASSOC_REQ_IND.">fcf</a> = <a class="code" href="group__mac.html#gd77e5ed839d20939420f3d50a121cb61" title="Indirect association response, short src and dest, ack, MAC frame.">FCF_ASSOC_RESP_IND</a>;
<a name="l00165"></a>00165             output.<a class="code" href="structftAssocReqIndirect.html#f32bb1cea4000279198cb562d1b83a8a" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00166"></a>00166             output.<a class="code" href="structftAssocReqIndirect.html#60d8cba8404e5ed8928a7c15ddbcba0d" title="The PAN ID for the network.">panid</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>;
<a name="l00167"></a>00167             output.<a class="code" href="structftAssocReqIndirect.html#47187631bba691eeea075b496f3247c5" title="Short address of receiving node.">destAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a>; <span class="comment">// send to parent</span>
<a name="l00168"></a>00168             output.<a class="code" href="structftAssocReqIndirect.html#f719bf328252d626edd11841015c6b08" title="Short address of sending node.">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00169"></a>00169             output.<a class="code" href="structftAssocReqIndirect.html#19bdcf798f335040b59a06661dc70006" title="MAC command byte, see ASSOCIATION_REQUEST.">cmd</a> = <a class="code" href="group__mac.html#gf98b7750709737ead9ddde34b4ae4633" title="Association request.">ASSOCIATION_REQUEST</a>;
<a name="l00170"></a>00170             output.<a class="code" href="structftAssocReqIndirect.html#ddb8cdf1327bec57d9ccf168048f638d" title="Short address of new parent.">parentAddr</a> = input-&gt;<a class="code" href="structftAssocReqDirect.html#3f1fb16110e3a78586a8890d28313cec" title="Short address of new parent (should also be srcAddr).">parentAddr</a>;
<a name="l00171"></a>00171             output.<a class="code" href="structftAssocReqIndirect.html#aff17d1efc753cba4145e7a03b08c09e" title="Long MAC address of new node.">macAddr</a> = input-&gt;<a class="code" href="structftAssocReqDirect.html#12c77c6a8478010354e46b5759ce2461" title="Long MAC address of new node, sending this packet.">srcAddr</a>;
<a name="l00172"></a>00172             output.<a class="code" href="structftAssocReqIndirect.html#0ade59e671fb4d9c28470b2b977d1d9a" title="Node type of new node, see NODETYPE.">type</a> = input-&gt;<a class="code" href="structftAssocReqDirect.html#6d47e8e9b43d159828bb8bad40f6c949" title="Node type of new node, see NODETYPE.">type</a>;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174             <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a>), (u8*)&amp;output);
<a name="l00175"></a>00175             debugMsgStr(<span class="stringliteral">"\r\nReceived assoc req"</span>);
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177         <span class="keywordflow">else</span>
<a name="l00178"></a>00178         {
<a name="l00179"></a>00179             <span class="comment">// input frame is indirect, output frame is indirect, just copy</span>
<a name="l00180"></a>00180             <a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a> *input = (<a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a>*)(<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>+1);
<a name="l00181"></a>00181             <a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a> *output = (<a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a>*)<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183             output-&gt;<a class="code" href="structftAssocReqIndirect.html#097195f2f03bea89ff0785c6cd9f26bf" title="Frame Control Field, see FCF_ASSOC_REQ_IND.">fcf</a> = <a class="code" href="group__mac.html#gd77e5ed839d20939420f3d50a121cb61" title="Indirect association response, short src and dest, ack, MAC frame.">FCF_ASSOC_RESP_IND</a>;
<a name="l00184"></a>00184             output-&gt;<a class="code" href="structftAssocReqIndirect.html#f32bb1cea4000279198cb562d1b83a8a" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00185"></a>00185             output-&gt;<a class="code" href="structftAssocReqIndirect.html#60d8cba8404e5ed8928a7c15ddbcba0d" title="The PAN ID for the network.">panid</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>;
<a name="l00186"></a>00186             output-&gt;<a class="code" href="structftAssocReqIndirect.html#47187631bba691eeea075b496f3247c5" title="Short address of receiving node.">destAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a>;  <span class="comment">// send all packets to parent</span>
<a name="l00187"></a>00187             output-&gt;<a class="code" href="structftAssocReqIndirect.html#f719bf328252d626edd11841015c6b08" title="Short address of sending node.">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00188"></a>00188             output-&gt;<a class="code" href="structftAssocReqIndirect.html#19bdcf798f335040b59a06661dc70006" title="MAC command byte, see ASSOCIATION_REQUEST.">cmd</a> = <a class="code" href="group__mac.html#gf98b7750709737ead9ddde34b4ae4633" title="Association request.">ASSOCIATION_REQUEST</a>;
<a name="l00189"></a>00189             output-&gt;<a class="code" href="structftAssocReqIndirect.html#ddb8cdf1327bec57d9ccf168048f638d" title="Short address of new parent.">parentAddr</a> = input-&gt;<a class="code" href="structftAssocReqIndirect.html#ddb8cdf1327bec57d9ccf168048f638d" title="Short address of new parent.">parentAddr</a>;
<a name="l00190"></a>00190             output-&gt;<a class="code" href="structftAssocReqIndirect.html#aff17d1efc753cba4145e7a03b08c09e" title="Long MAC address of new node.">macAddr</a> = input-&gt;<a class="code" href="structftAssocReqIndirect.html#aff17d1efc753cba4145e7a03b08c09e" title="Long MAC address of new node.">macAddr</a>;
<a name="l00191"></a>00191             output-&gt;<a class="code" href="structftAssocReqIndirect.html#0ade59e671fb4d9c28470b2b977d1d9a" title="Node type of new node, see NODETYPE.">type</a> = input-&gt;<a class="code" href="structftAssocReqIndirect.html#0ade59e671fb4d9c28470b2b977d1d9a" title="Node type of new node, see NODETYPE.">type</a>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193             <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftAssocReqIndirect.html" title="Indirect association request frame, forwarded from a router on up to the coordinator...">ftAssocReqIndirect</a>), (u8*)output);
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="keywordtype">void</span> mrd(<span class="keywordtype">void</span>)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200     <span class="comment">// Send packet after routing packet was sent</span>
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203         <span class="comment">// Packet has already been created, just send it.</span>
<a name="l00204"></a>00204         <a class="code" href="structftData.html" title="Data packet, used for data and some MAC functions (see type element).">ftData</a> *frame = (<a class="code" href="structftData.html" title="Data packet, used for data and some MAC functions (see type element).">ftData</a> *)(<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>+1);
<a name="l00205"></a>00205         <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftData.html" title="Data packet, used for data and some MAC functions (see type element).">ftData</a>), (u8 *)frame);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="keywordtype">void</span> ledoff1(<span class="keywordtype">void</span>);
<a name="l00210"></a>00210 
<a name="l00225"></a><a class="code" href="group__mac.html#g38eb0657916430780d598411fa5ce9d3">00225</a> <span class="keywordtype">void</span> <a class="code" href="group__mac.html#g38eb0657916430780d598411fa5ce9d3" title="Route a data packet.">macRouteData</a>(<span class="keywordtype">void</span>)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g5794c1a5f0eedfe85aea59330c25848a" title="Router node.">ROUTER</a> || <a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00228"></a>00228     {
<a name="l00229"></a>00229         <a class="code" href="structftData.html" title="Data packet, used for data and some MAC functions (see type element).">ftData</a> *frame = (<a class="code" href="structftData.html" title="Data packet, used for data and some MAC functions (see type element).">ftData</a> *)(<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>+1);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="comment">// Copy RX to TX buffer</span>
<a name="l00232"></a>00232         macCopyRxToTx();
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         LED_ON(1);
<a name="l00235"></a>00235         <a class="code" href="group__timer__module.html#g0155e5192956b3cd498751d8652f7773" title="Sets a general purpose timer.">macSetAlarm</a>(<a class="code" href="group__mac.html#g12a46d6ff86950784521c2446d84b2fc" title="mSec to wait before turning off LED">LED_DELAY</a>,ledoff1);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237         <span class="comment">// See if this frame is in the child table</span>
<a name="l00238"></a>00238         <span class="keywordflow">if</span> (<a class="code" href="group__mac__associate.html#ged6df4ec4a8b1f717d6591f7bc73627a" title="Determine if a given node is a child if this node.">macIsChild</a>(frame-&gt;<a class="code" href="structftData.html#d47ec2a56c800526476b1c2dfd89954d" title="Short address of the final destination node.">finalDestAddr</a>))
<a name="l00239"></a>00239         {
<a name="l00240"></a>00240             <span class="comment">// send frame to child</span>
<a name="l00241"></a>00241             frame-&gt;<a class="code" href="structftData.html#49dea86dab7c99aacbfd89cb8b7a271c" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00242"></a>00242             frame-&gt;<a class="code" href="structftData.html#5e15ea770e8c891e8cf64c7f2bb307b9" title="Short address of receiving node.">destAddr</a> = frame-&gt;<a class="code" href="structftData.html#d47ec2a56c800526476b1c2dfd89954d" title="Short address of the final destination node.">finalDestAddr</a>;
<a name="l00243"></a>00243             frame-&gt;<a class="code" href="structftData.html#5c7461f9411b7fa5e9389c1de167ea38" title="Short address of sending node (next hop).">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00244"></a>00244             debugMsgStr(<span class="stringliteral">"\r\nRoute data to child"</span>);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246             <span class="comment">// See if the child is sleeping</span>
<a name="l00247"></a>00247             <span class="keywordflow">if</span> (<a class="code" href="group__app.html#g7a52419b3bc2a1c7763ace68f3f172fb" title="Enable or disable the sleep function by setting this macro to 1 (on) or 0 (off).">RUMSLEEP</a> &amp;&amp; <a class="code" href="group__mac__associate.html#gbca0fd11d3bc8ac2f608958459d0279e" title="Determine if a given node is a sleeping child of this node.">macIsChildSleeping</a>(frame-&gt;<a class="code" href="structftData.html#d47ec2a56c800526476b1c2dfd89954d" title="Short address of the final destination node.">finalDestAddr</a>))
<a name="l00248"></a>00248                 <span class="comment">// Send it later, after child is awake</span>
<a name="l00249"></a>00249                 <a class="code" href="group__mac__data.html#g20399e489f449bd2026daec4606fc048" title="Save a frame for transmission later.">macHoldFrame</a>(frame-&gt;<a class="code" href="structftData.html#d47ec2a56c800526476b1c2dfd89954d" title="Short address of the final destination node.">finalDestAddr</a>, (u8*)frame, (u8)*<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a> - 2);
<a name="l00250"></a>00250             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame-&gt;destAddr != <a class="code" href="group__mac.html#g6717875b0df9fdee5523c2f251f73810" title="The broadcast address, which all nodes receive. See IEEE802.15.4.">BROADCASTADDR</a>)
<a name="l00251"></a>00251                 <span class="comment">// Send the frame along (subtract 2 bytes from length for checksum length)</span>
<a name="l00252"></a>00252                 <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(*<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a> - 2, (u8*)frame);
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254         <span class="keywordflow">else</span> <span class="comment">// Not child node, send up or down the chain</span>
<a name="l00255"></a>00255         {
<a name="l00256"></a>00256             <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00257"></a>00257             {
<a name="l00258"></a>00258                 <span class="comment">// Send down the chain</span>
<a name="l00259"></a>00259                 frame-&gt;<a class="code" href="structftData.html#49dea86dab7c99aacbfd89cb8b7a271c" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00260"></a>00260                 frame-&gt;<a class="code" href="structftData.html#5e15ea770e8c891e8cf64c7f2bb307b9" title="Short address of receiving node.">destAddr</a> = <a class="code" href="group__mac__associate.html#gea0193b13c0f497ce8561762e1611dc0" title="Find the &amp;quot;topmost&amp;quot; parent for a node (the one connected to the coord).">macGetTopParent</a>(frame-&gt;<a class="code" href="structftData.html#d47ec2a56c800526476b1c2dfd89954d" title="Short address of the final destination node.">finalDestAddr</a>);
<a name="l00261"></a>00261                 frame-&gt;<a class="code" href="structftData.html#5c7461f9411b7fa5e9389c1de167ea38" title="Short address of sending node (next hop).">srcAddr</a> = <a class="code" href="group__mac.html#gd24d249b0f426b8bd98a2180564531dc" title="The coordinator&amp;#39;s short address, always zero.">DEFAULT_COORD_ADDR</a>;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263                 debugMsgStr(<span class="stringliteral">"\r\nRoute data from Coord"</span>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265                 <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g2809f7f1254ef0b25b95136d2aff6b06" title="Create and send a routing packet, returns non-zero if packet was sent.">macSendRoutingPacket</a>(frame-&gt;<a class="code" href="structftData.html#d47ec2a56c800526476b1c2dfd89954d" title="Short address of the final destination node.">finalDestAddr</a>))
<a name="l00266"></a>00266                 {
<a name="l00267"></a>00267                     <a class="code" href="group__timer__module.html#g0155e5192956b3cd498751d8652f7773" title="Sets a general purpose timer.">macSetAlarm</a>(<a class="code" href="group__mac.html#gcba298b503d8f965ac02682ef80d92f1" title="mSec to wait after sending a routing packet, before sending data">MAC_RP_DELAY</a>, mrd);
<a name="l00268"></a>00268                     <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#41e5b4ad93b57a3da564efa92e72a909" title="Is the mac busy? Used to protect mac_buffer_tx.">busy</a> = <span class="keyword">true</span>;
<a name="l00269"></a>00269                     <span class="comment">// will send packet later, get out now</span>
<a name="l00270"></a>00270                     <span class="keywordflow">return</span>;
<a name="l00271"></a>00271                 }
<a name="l00272"></a>00272             }
<a name="l00273"></a>00273             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g5794c1a5f0eedfe85aea59330c25848a" title="Router node.">ROUTER</a>)
<a name="l00274"></a>00274             {
<a name="l00275"></a>00275                 <span class="comment">// See if we should route up or down</span>
<a name="l00276"></a>00276                 <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structftData.html#5c7461f9411b7fa5e9389c1de167ea38" title="Short address of sending node (next hop).">srcAddr</a> == <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a>)
<a name="l00277"></a>00277                 {
<a name="l00278"></a>00278                     <span class="comment">// this frame is from parent, send it down default route</span>
<a name="l00279"></a>00279                     frame-&gt;<a class="code" href="structftData.html#49dea86dab7c99aacbfd89cb8b7a271c" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00280"></a>00280                     frame-&gt;<a class="code" href="structftData.html#5e15ea770e8c891e8cf64c7f2bb307b9" title="Short address of receiving node.">destAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a>;
<a name="l00281"></a>00281                     frame-&gt;<a class="code" href="structftData.html#5c7461f9411b7fa5e9389c1de167ea38" title="Short address of sending node (next hop).">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00282"></a>00282                     debugMsgStr(<span class="stringliteral">"Route data down to "</span>);
<a name="l00283"></a>00283                     debugMsgHex(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a>);
<a name="l00284"></a>00284                 }
<a name="l00285"></a>00285                 <span class="keywordflow">else</span>
<a name="l00286"></a>00286                 {
<a name="l00287"></a>00287                     <span class="comment">// this frame is from child, send up the chain</span>
<a name="l00288"></a>00288                     frame-&gt;<a class="code" href="structftData.html#49dea86dab7c99aacbfd89cb8b7a271c" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00289"></a>00289                     frame-&gt;<a class="code" href="structftData.html#5e15ea770e8c891e8cf64c7f2bb307b9" title="Short address of receiving node.">destAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a>;
<a name="l00290"></a>00290                     frame-&gt;<a class="code" href="structftData.html#5c7461f9411b7fa5e9389c1de167ea38" title="Short address of sending node (next hop).">srcAddr</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>;
<a name="l00291"></a>00291                     debugMsgStr(<span class="stringliteral">"\r\nRoute data up"</span>);
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293             }
<a name="l00294"></a>00294             <span class="comment">// Make sure we're not broadcasting frames</span>
<a name="l00295"></a>00295             <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structftData.html#5e15ea770e8c891e8cf64c7f2bb307b9" title="Short address of receiving node.">destAddr</a> != <a class="code" href="group__mac.html#g6717875b0df9fdee5523c2f251f73810" title="The broadcast address, which all nodes receive. See IEEE802.15.4.">BROADCASTADDR</a>)
<a name="l00296"></a>00296                 <span class="comment">// Send the frame along (subtract 2 bytes from length for checksum length)</span>
<a name="l00297"></a>00297                 <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(*<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a> - 2, (u8*)frame);
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00312"></a><a class="code" href="group__mac.html#g2809f7f1254ef0b25b95136d2aff6b06">00312</a> u8 <a class="code" href="group__mac.html#g2809f7f1254ef0b25b95136d2aff6b06" title="Create and send a routing packet, returns non-zero if packet was sent.">macSendRoutingPacket</a>(u16 shortAddr)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00315"></a>00315     {
<a name="l00316"></a>00316         <span class="keyword">volatile</span> u16 topParent; <span class="comment">// Return to caller</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         u8 buf[128];
<a name="l00319"></a>00319         <a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a> *frame = (<a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a> *)buf;
<a name="l00320"></a>00320         u8 hops; <span class="comment">// Number of router-to-router hops</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         <span class="comment">// Calculate the routing portion of the routing packet</span>
<a name="l00323"></a>00323         hops = <a class="code" href="group__mac__associate.html#g4a6a372f2dd95a1cd7d0a3cb635bc4eb" title="Create a routing packet.">macCreateRoute</a>(shortAddr, frame);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <span class="keywordflow">if</span> (hops &lt; 3)
<a name="l00326"></a>00326             <span class="comment">// Could not create routing packet, or no packet needed</span>
<a name="l00327"></a>00327             <span class="keywordflow">return</span> 0;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         frame-&gt;<a class="code" href="structftRouting.html#327cea1b90eb5b8a4b87d740b7b0d133" title="Frame Control Field, see FCF_ROUTE.">fcf</a> = <a class="code" href="group__mac.html#gf9ba84abf7a2b6c682027c7ab28d1b90" title="Routing frame, short src and dest, ack, MAC frame.">FCF_ROUTE</a>;
<a name="l00330"></a>00330         frame-&gt;<a class="code" href="structftRouting.html#49bd4f680bc2960eda8eec459fb70467" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#fb9014afdb5667d061457b1720a4d512" title="Data sequence number, incremented each time a data frame is sent.">dsn</a>++;
<a name="l00331"></a>00331         frame-&gt;<a class="code" href="structftRouting.html#9f215bd4212fe269473dfd16d57a78fc" title="The PAN ID for the network.">panid</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>;
<a name="l00332"></a>00332         frame-&gt;<a class="code" href="structftRouting.html#178b8337f5bf13af0e2fa8df398ccc34" title="Short address of sending node.">srcAddr</a> = <a class="code" href="group__mac.html#gd24d249b0f426b8bd98a2180564531dc" title="The coordinator&amp;#39;s short address, always zero.">DEFAULT_COORD_ADDR</a>;
<a name="l00333"></a>00333         frame-&gt;<a class="code" href="structftRouting.html#573b8f21b52ef3e6b045c389a9e8904a" title="MAC command byte, see ROUTING_PACKET.">cmd</a> = <a class="code" href="group__mac.html#g1bad177d49cd2ab85b180af9e34fe24a" title="Routing packet MAC type.">ROUTING_PACKET</a>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         topParent = frame-&gt;<a class="code" href="structftRouting.html#22158de9096a1a35361e33d6ab6685b6" title="Short address of receiving node.">destAddr</a>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="comment">// See if we can skip routing because the last packet went there.</span>
<a name="l00338"></a>00338         <span class="keywordflow">if</span> (<a class="code" href="group__mac__associate.html#gcfefe3f998d94f694b004a72b8b777fb" title="Get the last routed address of one of the router nodes in the network.">macGetLastRoute</a>(topParent) == frame-&gt;<a class="code" href="structftRouting.html#cb69197a8e661b50d8c4681972b13f90" title="First of a list of short addresses that describe the route.">shortAddr</a>)
<a name="l00339"></a>00339             <span class="keywordflow">return</span> 0;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">// Save route for this child router</span>
<a name="l00342"></a>00342         <a class="code" href="group__mac__associate.html#geac81ec5acd0fa702167c9f8b0ce29b2" title="Sets the last routed address for a router node.">macSetLastRoute</a>(topParent, frame-&gt;<a class="code" href="structftRouting.html#cb69197a8e661b50d8c4681972b13f90" title="First of a list of short addresses that describe the route.">shortAddr</a>);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         <span class="comment">// And finally send the packet over the air</span>
<a name="l00345"></a>00345         <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a>) + (hops-3)*2,(u8*)frame);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="comment">// Set the flag to say we sent a routing packet.</span>
<a name="l00348"></a>00348         <span class="keywordflow">return</span> 1;
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     <span class="keywordflow">return</span> 0;
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jun 8 18:38:19 2009 for RUM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
