<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>RUM: rum_src/mac_scan.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>rum_src/mac_scan.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) 2008  ATMEL Corporation</span>
<a name="l00002"></a>00002 <span class="comment">   All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">   Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment">   modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">   * Redistributions of source code must retain the above copyright</span>
<a name="l00008"></a>00008 <span class="comment">     notice, this list of conditions and the following disclaimer.</span>
<a name="l00009"></a>00009 <span class="comment">   * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00010"></a>00010 <span class="comment">     notice, this list of conditions and the following disclaimer in</span>
<a name="l00011"></a>00011 <span class="comment">     the documentation and/or other materials provided with the</span>
<a name="l00012"></a>00012 <span class="comment">     distribution.</span>
<a name="l00013"></a>00013 <span class="comment">   * Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment">     contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment">     from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span>
<a name="l00018"></a>00018 <span class="comment">  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00019"></a>00019 <span class="comment">  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00020"></a>00020 <span class="comment">  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="l00021"></a>00021 <span class="comment">  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00022"></a>00022 <span class="comment">  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00023"></a>00023 <span class="comment">  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00024"></a>00024 <span class="comment">  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00025"></a>00025 <span class="comment">  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00026"></a>00026 <span class="comment">  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00027"></a>00027 <span class="comment">  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00028"></a>00028 <span class="comment"> */</span>
<a name="l00029"></a>00029 <span class="comment">/*</span>
<a name="l00030"></a>00030 <span class="comment">  $Id: mac_scan.c,v 1.3 2009/05/28 22:52:13 bleverett Exp $</span>
<a name="l00031"></a>00031 <span class="comment">*/</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">// Includes</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "radio.h"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "mac.h"</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "timer.h"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "mac_scan.h"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "system.h"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "sleep.h"</span>
<a name="l00041"></a>00041 
<a name="l00092"></a>00092 <span class="comment">//Globals</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00096"></a><a class="code" href="group__mac__scan.html#g963e3745ba8bbe555f09a099c8566102">00096</a> <a class="code" href="structpanDescriptor__t.html" title="Defines the PAN descriptor for a received beacon frame.">panDescriptor_t</a> <a class="code" href="group__mac__scan.html#g963e3745ba8bbe555f09a099c8566102" title="PAN Descriptor structure,.">panDescriptor</a>;
<a name="l00097"></a>00097 
<a name="l00099"></a><a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76">00099</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a>;
<a name="l00100"></a>00100 <span class="preprocessor">#define ALL_CHANNELS (0x80)</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="keyword">static</span> u8 scanChannel=ALL_CHANNELS;
<a name="l00102"></a>00102 
<a name="l00108"></a><a class="code" href="structenergy__t.html">00108</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>{
<a name="l00109"></a><a class="code" href="structenergy__t.html#bd300efacdb0abdbde107ab53f7b49ff">00109</a>     u8 currentChannel;    
<a name="l00110"></a><a class="code" href="structenergy__t.html#caade4c83697816c65b44f8ec64338e0">00110</a>     u8 timerID;           
<a name="l00111"></a><a class="code" href="structenergy__t.html#2c2c3e6b0ecf1f2d5fe8fb5f558f0728">00111</a>     u8 randomVal;         
<a name="l00112"></a><a class="code" href="structenergy__t.html#b6283f4115d8b11fbd4b5d242e389843">00112</a>     u16 <a class="code" href="group__mac__scan.html#g9f65cb46245fa74d0b62f308570ae95d" title="Energy accumulation structure.">energy</a>[MAX_CHANNEL+1]; 
<a name="l00113"></a>00113 } __attribute__((packed)) <a class="code" href="structenergy__t.html" title="Structure used to keep track of how much energy is received on each scanned channel...">energy_t</a>;
<a name="l00114"></a>00114 
<a name="l00116"></a><a class="code" href="group__mac__scan.html#g9f65cb46245fa74d0b62f308570ae95d">00116</a> static energy_t <a class="code" href="group__mac__scan.html#g9f65cb46245fa74d0b62f308570ae95d" title="Energy accumulation structure.">energy</a>;
<a name="l00117"></a>00117 
<a name="l00119"></a><a class="code" href="group__mac__scan.html#g4c1c323d6bc3387b2c3fab879cf4d87e">00119</a> <span class="preprocessor">#define SCANDURATION (20 + (100*(BAND==BAND900)))  // Time (mSec) to scan one channel</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="group__mac__scan.html#g83c6e91d2cdbf552eb7c82ad6f610a81">00122</a> <span class="preprocessor">#define SCAN_SLEEP_TIME 2</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00124"></a>00124 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f" title="This will store the actual beacon data into the pan descriptor list after the appropriate...">store_pandescriptors</a>(<span class="keywordtype">void</span>);
<a name="l00125"></a>00125 
<a name="l00132"></a><a class="code" href="group__mac__scan.html#g92f5262200ca45d25313feb542d9c30b">00132</a> u8 <a class="code" href="group__mac__scan.html#g92f5262200ca45d25313feb542d9c30b" title="Reports whether the MAC is currently scanning.">macIsScanning</a>(<span class="keywordtype">void</span>)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <span class="keywordflow">return</span> <a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a>;
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00145"></a><a class="code" href="group__mac__scan.html#g0e398021c1df780ccc9a85785507f1e0">00145</a> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#g0e398021c1df780ccc9a85785507f1e0" title="Sets a specific single channel to scan, or all channels.">macSetScanChannel</a>(u8 channel)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     scanChannel = channel;
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00155"></a><a class="code" href="group__mac__scan.html#g1b6cb559b6f7dfb18d178766cb0dd1ad">00155</a> u8 <a class="code" href="group__mac__scan.html#g1b6cb559b6f7dfb18d178766cb0dd1ad" title="Returns the channel set by macSetScanChannel().">macGetScanChannel</a>(<span class="keywordtype">void</span>)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157     <span class="keywordflow">return</span> scanChannel;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00165"></a><a class="code" href="group__mac__scan.html#ge0a3ffbab485718432db4a80c86c87db">00165</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#ge0a3ffbab485718432db4a80c86c87db" title="Send a beacon request frame.">sendBeaconRequest</a>(<span class="keywordtype">void</span>)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167     <span class="comment">// Create a struct pointer to the global variable...</span>
<a name="l00168"></a>00168     <a class="code" href="structftBeaconReq.html" title="Beacon request frame, sent from new node into the ether.">ftBeaconReq</a>* brFrame = (<a class="code" href="structftBeaconReq.html" title="Beacon request frame, sent from new node into the ether.">ftBeaconReq</a>*)(<a class="code" href="group__mac.html#g1773cb730c85757b4c51da29304072e1" title="A global buffer to hold frames.">mac_buffer_tx</a>+1);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">// Fill in beacon request frame</span>
<a name="l00171"></a>00171     brFrame-&gt;<a class="code" href="structftBeaconReq.html#dc5f63e693c95e3a127e9adc20b01657" title="Frame Control Field, see FCF_BEACONREQ.">fcf</a> = <a class="code" href="group__mac.html#gdb8686066c076d5d45024d1375535b1f" title="Beacon request, no src, short dest, no ack, MAC frame.">FCF_BEACONREQ</a>;
<a name="l00172"></a>00172     brFrame-&gt;<a class="code" href="structftBeaconReq.html#0865bfb5f3724ff31234a5c76e384ae4" title="Frame sequence number.">seq</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#9750cc2733253feb73398e68dd1fa0cb" title="Beacon sequence number, incremented each time a beacon is sent.">bsn</a>++;
<a name="l00173"></a>00173     brFrame-&gt;<a class="code" href="structftBeaconReq.html#8ac4542260fb4da516144217e4fdb755" title="The PAN ID for the network, which is the broadcast PAN ID for this frame.">panid</a> = <a class="code" href="group__mac__associate.html#g30931c9744e3a05a13e7c0f36ef20255" title="PANID used for the PAN ID.">PAN_ID</a>;
<a name="l00174"></a>00174     brFrame-&gt;<a class="code" href="structftBeaconReq.html#e76fc3eab9ff62a94519fb457019aad7" title="The destination address for the frame, which is the broadcast address for this frame...">broadcastAddr</a> = <a class="code" href="group__mac.html#g6717875b0df9fdee5523c2f251f73810" title="The broadcast address, which all nodes receive. See IEEE802.15.4.">BROADCASTADDR</a>;
<a name="l00175"></a>00175     brFrame-&gt;<a class="code" href="structftBeaconReq.html#b3ab68e015b74b9373fd6da7b7abe772" title="MAC command byte, see BEACON_REQUEST.">cmd</a> = <a class="code" href="group__mac.html#ge347f8ccf54462acfcd2f0cd92c8bf60" title="Beacon request.">BEACON_REQUEST</a>;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">// Send the frame via radio</span>
<a name="l00178"></a>00178     <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(<span class="keyword">sizeof</span>(<a class="code" href="structftBeaconReq.html" title="Beacon request frame, sent from new node into the ether.">ftBeaconReq</a>), (u8*)brFrame);
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00193"></a><a class="code" href="group__mac__scan.html#g9b962c94bc13ed89a2d2a8590ed487f4">00193</a> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#g9b962c94bc13ed89a2d2a8590ed487f4" title="Scan channels for coordinators.">macScan</a>(<span class="keywordtype">void</span>)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     <span class="comment">// Check for fixed channel</span>
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (<a class="code" href="group__mac__associate.html#g339b747fe4e5bb7e7f252ba56727e3f5" title="Channel used for the PAN.">PAN_CHANNEL</a> != CHANNEL255)
<a name="l00197"></a>00197         <a class="code" href="group__mac__scan.html#g0e398021c1df780ccc9a85785507f1e0" title="Sets a specific single channel to scan, or all channels.">macSetScanChannel</a>(<a class="code" href="group__mac__associate.html#g339b747fe4e5bb7e7f252ba56727e3f5" title="Channel used for the PAN.">PAN_CHANNEL</a>);
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="comment">// Set up some varibles on the initial call to macScan()</span>
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (0xFF == <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a>)
<a name="l00201"></a>00201     {
<a name="l00202"></a>00202         <a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a> = <span class="keyword">true</span>;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204         <span class="comment">// Reset the variables.</span>
<a name="l00205"></a>00205         memset(&amp;panDescriptor, 0, <span class="keyword">sizeof</span>(<a class="code" href="structpanDescriptor__t.html" title="Defines the PAN descriptor for a received beacon frame.">panDescriptor_t</a>));
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <span class="comment">// logicalChannel is used as flag to show that we received a valid beacon</span>
<a name="l00208"></a>00208         panDescriptor.<a class="code" href="structpanDescriptor__t.html#b88b47c58d2b004636b25fb75557b32a" title="Channel that the PAN operates on.">logicalChannel</a> = 0xff;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a> = MIN_CHANNEL; <span class="comment">// First possible channel for RF23x</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="comment">// Check for a single pre-defined channel to scan.</span>
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (scanChannel != ALL_CHANNELS)
<a name="l00214"></a>00214             <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a> = scanChannel;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <span class="comment">// Display the channel if it's a fixed channel</span>
<a name="l00217"></a>00217         <span class="keywordflow">if</span> (<a class="code" href="group__mac__associate.html#g339b747fe4e5bb7e7f252ba56727e3f5" title="Channel used for the PAN.">PAN_CHANNEL</a> != CHANNEL255)
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219             debugMsgStr(<span class="stringliteral">"Ch=0x"</span>);
<a name="l00220"></a>00220             debugMsgInt(<a class="code" href="group__mac__associate.html#g339b747fe4e5bb7e7f252ba56727e3f5" title="Channel used for the PAN.">PAN_CHANNEL</a>);
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222     }
<a name="l00223"></a>00223     <span class="keywordflow">else</span>
<a name="l00224"></a>00224         <span class="comment">// Not first time through, must sleep very low power nodes.</span>
<a name="l00225"></a>00225         <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g129500a5752ba8bc8abba3844efe45f6" title="Flag to signify a &amp;quot;very low power&amp;quot; (VLP) node.">VLP</a> &amp;&amp; (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#gfa11cf93bface598cd7a0fa88a71285c" title="End node.">ENDDEVICE</a>))
<a name="l00226"></a>00226             <a class="code" href="group__sleep.html#g93b5cdc0c2f6e617c9e63fac53cc8271" title="Put the node to sleep.">nodeSleep</a>(<a class="code" href="group__mac__scan.html#g83c6e91d2cdbf552eb7c82ad6f610a81" title="Time to sleep between each channel scan (10ths of a second).">SCAN_SLEEP_TIME</a>);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <span class="comment">// See if we're done scanning</span>
<a name="l00229"></a>00229     <span class="keywordflow">if</span>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a> &gt; (<a class="code" href="group__mac.html#g036a88551664cfe893bc3f51a64ba179" title="When CHINA_MODE is set, there are only 4 channels (1-4).">CHINA_MODE</a> ? 4 : MAX_CHANNEL) ||
<a name="l00230"></a>00230        <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a> == scanChannel + 1)
<a name="l00231"></a>00231         {
<a name="l00232"></a>00232             <span class="comment">// done scanning</span>
<a name="l00233"></a>00233             <a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a> = <span class="keyword">false</span>;
<a name="l00234"></a>00234             <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a> = 0xFF;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236             <a class="code" href="group__mac__scan.html#gfd144874c6383422c68edcf57d581b06" title="Trigger a call to appScanConfirm(), since the scanning process is done.">mac_scanConfirm</a>();
<a name="l00237"></a>00237             <span class="keywordflow">return</span>;
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="comment">// Set the channel.</span>
<a name="l00241"></a>00241     <a class="code" href="group__mac.html#g62d975ef98590e2c23229df7b6d041c6" title="Set the radio&amp;#39;s operating channel, and saves that channel to the MAC&amp;#39;s global...">macSetOperatingChannel</a>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a>);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">// Send the beacon request</span>
<a name="l00244"></a>00244     <a class="code" href="group__mac__scan.html#ge0a3ffbab485718432db4a80c86c87db" title="Send a beacon request frame.">sendBeaconRequest</a>();
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="comment">// Beacon was send, increment channel to prepare for the next one.</span>
<a name="l00247"></a>00247     <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a>++;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">// Set the scan duration timer.</span>
<a name="l00250"></a>00250     <a class="code" href="group__timer__module.html#g0155e5192956b3cd498751d8652f7773" title="Sets a general purpose timer.">macSetAlarm</a>(<a class="code" href="group__mac__scan.html#g4c1c323d6bc3387b2c3fab879cf4d87e" title="Duration of scanning for each channel, in mSec.">SCANDURATION</a>, <a class="code" href="group__mac__scan.html#g9b962c94bc13ed89a2d2a8590ed487f4" title="Scan channels for coordinators.">macScan</a>);
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00268"></a><a class="code" href="group__mac__scan.html#gf084f7bb7346b0573dc67e4dea576d6e">00268</a> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#gf084f7bb7346b0573dc67e4dea576d6e" title="Record the pan description data from a received beacon frame in the global panDescriptor...">mac_logPanDescriptors</a>(<span class="keywordtype">void</span>)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     <a class="code" href="structftBeacon.html" title="Beacon frame, sent by coordinator/router in response to a beacon request.">ftBeacon</a> *frame = (<a class="code" href="structftBeacon.html" title="Beacon frame, sent by coordinator/router in response to a beacon request.">ftBeacon</a> *)(<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>+1);
<a name="l00271"></a>00271     u8 lqi = ((<a class="code" href="structrx__frame__t.html" title="This struct defines the rx data container.">rx_frame_t</a> *)<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>)-&gt;lqi;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (!<a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a>)
<a name="l00274"></a>00274         <span class="keywordflow">return</span>;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00277"></a>00277     {
<a name="l00278"></a>00278         <span class="comment">// Energy scan, mark that this channel has a lot of interference</span>
<a name="l00279"></a>00279         energy.energy[energy.currentChannel] += 500;
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281     <span class="keywordflow">else</span>  <span class="comment">// Router and end nodes</span>
<a name="l00282"></a>00282     {
<a name="l00283"></a>00283         <span class="comment">// Check the Beacon frame Superframe spec value.</span>
<a name="l00284"></a>00284         u16 previous_superframe = panDescriptor.<a class="code" href="structpanDescriptor__t.html#eb2c678646a5ecdae6df991641f1df8d" title="Superframe spec of the beacon frame.">superFrameSpec</a>.<a class="code" href="unionsuperframe__t.html#574f703cce97b72f35208db9a30caf64">superframe_data</a>;
<a name="l00285"></a>00285         panDescriptor.<a class="code" href="structpanDescriptor__t.html#eb2c678646a5ecdae6df991641f1df8d" title="Superframe spec of the beacon frame.">superFrameSpec</a>.<a class="code" href="unionsuperframe__t.html#574f703cce97b72f35208db9a30caf64">superframe_data</a> = frame-&gt;<a class="code" href="structftBeacon.html#0d64606f31ef108ccc3989f8e07eec37" title="Superframe specification, see superframe_spec_t.">superFrame</a>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="comment">// Determine if association permit is true. We're looking for false.</span>
<a name="l00288"></a>00288         <span class="keywordflow">if</span>(panDescriptor.<a class="code" href="structpanDescriptor__t.html#eb2c678646a5ecdae6df991641f1df8d" title="Superframe spec of the beacon frame.">superFrameSpec</a>.<a class="code" href="unionsuperframe__t.html#426a0253a66917c11e6d9233dc413a3f">superframe_struct</a>.<a class="code" href="structsuperframe__spec__t.html#1152d66af9298e5e0e1baca09e5193de">association_permit</a>)
<a name="l00289"></a>00289         {
<a name="l00290"></a>00290             panDescriptor.<a class="code" href="structpanDescriptor__t.html#eb2c678646a5ecdae6df991641f1df8d" title="Superframe spec of the beacon frame.">superFrameSpec</a>.<a class="code" href="unionsuperframe__t.html#574f703cce97b72f35208db9a30caf64">superframe_data</a> = previous_superframe;
<a name="l00291"></a>00291             <span class="keywordflow">return</span>;
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         <span class="keywordflow">if</span>(<a class="code" href="group__app.html#gd5c46706b38c7dc7ebb32e964a24fd13" title="The global demo flag.">DEMO</a>)
<a name="l00295"></a>00295         {
<a name="l00296"></a>00296             <span class="comment">// Demo mode, just pick closest node</span>
<a name="l00297"></a>00297             <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g8a4202486f04e061df72ec19973be447" title="Retrieves the saved RSSI (Received Signal Strength Indication) value.">radioGetSavedRssiValue</a>() &gt; panDescriptor.<a class="code" href="structpanDescriptor__t.html#499cf9b0ccf26b3d655f8730530f2740" title="Received Signal Strength Indication for the received beacon frame.">rssi</a>)
<a name="l00298"></a>00298             {
<a name="l00299"></a>00299                 <a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f" title="This will store the actual beacon data into the pan descriptor list after the appropriate...">store_pandescriptors</a>();
<a name="l00300"></a>00300             }
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         <span class="keywordflow">else</span>
<a name="l00303"></a>00303         {
<a name="l00304"></a>00304             <span class="comment">// Determine if the Beacon LQI value is stronger than the previous scan.</span>
<a name="l00305"></a>00305             <span class="keywordflow">if</span>(panDescriptor.<a class="code" href="structpanDescriptor__t.html#90b5b071347b891ad39a795a060020c4" title="Link Quality Indicator for the received beacon frame.">lqi</a> &lt; lqi)
<a name="l00306"></a>00306             {
<a name="l00307"></a>00307                 <a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f" title="This will store the actual beacon data into the pan descriptor list after the appropriate...">store_pandescriptors</a>();
<a name="l00308"></a>00308             }
<a name="l00309"></a>00309             <span class="comment">// If LQI is equal to previous stored, check for the least amount of hops to the coord.</span>
<a name="l00310"></a>00310             <span class="keywordflow">else</span> <span class="keywordflow">if</span>((panDescriptor.<a class="code" href="structpanDescriptor__t.html#90b5b071347b891ad39a795a060020c4" title="Link Quality Indicator for the received beacon frame.">lqi</a> == lqi)
<a name="l00311"></a>00311                     &amp;&amp; (panDescriptor.<a class="code" href="structpanDescriptor__t.html#8ceeebc221ca893c3a7e322c84f8f19b" title="Number of hops from the beaconing node to the coordinator.">hopsToCoord</a> &gt; frame-&gt;<a class="code" href="structftBeacon.html#afc9040e05786f77ddb8d87f3a006e8e">hops</a>))
<a name="l00312"></a>00312             {
<a name="l00313"></a>00313                 <a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f" title="This will store the actual beacon data into the pan descriptor list after the appropriate...">store_pandescriptors</a>();
<a name="l00314"></a>00314             }
<a name="l00315"></a>00315             <span class="comment">// If LQI and hops are equal to the previous stored, check for the best RSSI value.</span>
<a name="l00316"></a>00316             <span class="keywordflow">else</span> <span class="keywordflow">if</span>((panDescriptor.<a class="code" href="structpanDescriptor__t.html#90b5b071347b891ad39a795a060020c4" title="Link Quality Indicator for the received beacon frame.">lqi</a> == lqi)
<a name="l00317"></a>00317                     &amp;&amp; (panDescriptor.<a class="code" href="structpanDescriptor__t.html#8ceeebc221ca893c3a7e322c84f8f19b" title="Number of hops from the beaconing node to the coordinator.">hopsToCoord</a> == frame-&gt;<a class="code" href="structftBeacon.html#afc9040e05786f77ddb8d87f3a006e8e">hops</a>)
<a name="l00318"></a>00318                     &amp;&amp; (panDescriptor.<a class="code" href="structpanDescriptor__t.html#499cf9b0ccf26b3d655f8730530f2740" title="Received Signal Strength Indication for the received beacon frame.">rssi</a> &lt; <a class="code" href="group__radio.html#g8a4202486f04e061df72ec19973be447" title="Retrieves the saved RSSI (Received Signal Strength Indication) value.">radioGetSavedRssiValue</a>()))
<a name="l00319"></a>00319             {
<a name="l00320"></a>00320                 <a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f" title="This will store the actual beacon data into the pan descriptor list after the appropriate...">store_pandescriptors</a>();
<a name="l00321"></a>00321             }
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00331"></a><a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f">00331</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#gae50bf8d2984eaa38f63903f67ecee2f" title="This will store the actual beacon data into the pan descriptor list after the appropriate...">store_pandescriptors</a>(<span class="keywordtype">void</span>)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <a class="code" href="structftBeacon.html" title="Beacon frame, sent by coordinator/router in response to a beacon request.">ftBeacon</a> *frame = (<a class="code" href="structftBeacon.html" title="Beacon frame, sent by coordinator/router in response to a beacon request.">ftBeacon</a> *)(<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>+1);
<a name="l00334"></a>00334     u8 lqi = ((<a class="code" href="structrx__frame__t.html" title="This struct defines the rx data container.">rx_frame_t</a> *)<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>)-&gt;lqi;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="comment">// Gather the pan descriptor data and retain the strongest link in the scan process.</span>
<a name="l00337"></a>00337     panDescriptor.<a class="code" href="structpanDescriptor__t.html#ee31ca1aa3d106325774d35f33bf11bb" title="Addressing modes from the beacon FCF.">coorAddrMode</a> = frame-&gt;<a class="code" href="structftBeacon.html#ef8b20bba70707de7874201ecda08d6e" title="Frame Control Field, see FCF_BEACON.">fcf</a> &gt;&gt; 14;
<a name="l00338"></a>00338     panDescriptor.<a class="code" href="structpanDescriptor__t.html#e5e6733835d7a7422dba04e8aed655cc" title="PAN ID for the coordinator.">coorPANId</a> = frame-&gt;<a class="code" href="structftBeacon.html#ef2e8dac9de6ba0950450a1a99392064" title="The PAN ID for the network.">panid</a>;
<a name="l00339"></a>00339     panDescriptor.<a class="code" href="structpanDescriptor__t.html#ef9073f37c69898f538332fba8052d03" title="Short address of the node that sent the beacon.">coordAddr</a> = frame-&gt;<a class="code" href="structftBeacon.html#ad6de87143635dd7de5428e667e75a91" title="Source address, which is short address of the node sending the beacon.">addr</a>;
<a name="l00340"></a>00340     panDescriptor.<a class="code" href="structpanDescriptor__t.html#8ceeebc221ca893c3a7e322c84f8f19b" title="Number of hops from the beaconing node to the coordinator.">hopsToCoord</a> = frame-&gt;<a class="code" href="structftBeacon.html#afc9040e05786f77ddb8d87f3a006e8e">hops</a>;
<a name="l00341"></a>00341     panDescriptor.<a class="code" href="structpanDescriptor__t.html#b88b47c58d2b004636b25fb75557b32a" title="Channel that the PAN operates on.">logicalChannel</a> = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a> - 1;
<a name="l00342"></a>00342     panDescriptor.<a class="code" href="structpanDescriptor__t.html#2f55c3c8baa4e0af0950fd434830b108" title="Channel page used by the PAN.">channelPage</a> = CHANNEL_PAGE_0;
<a name="l00343"></a>00343     panDescriptor.<a class="code" href="structpanDescriptor__t.html#90b5b071347b891ad39a795a060020c4" title="Link Quality Indicator for the received beacon frame.">lqi</a> = lqi;
<a name="l00344"></a>00344     panDescriptor.<a class="code" href="structpanDescriptor__t.html#499cf9b0ccf26b3d655f8730530f2740" title="Received Signal Strength Indication for the received beacon frame.">rssi</a> = <a class="code" href="group__radio.html#g8a4202486f04e061df72ec19973be447" title="Retrieves the saved RSSI (Received Signal Strength Indication) value.">radioGetSavedRssiValue</a>();
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00352"></a><a class="code" href="group__mac__scan.html#gfd144874c6383422c68edcf57d581b06">00352</a> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#gfd144874c6383422c68edcf57d581b06" title="Trigger a call to appScanConfirm(), since the scanning process is done.">mac_scanConfirm</a>(<span class="keywordtype">void</span>)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     <span class="comment">// logicalChannel is used as flag to show that we received a valid beacon</span>
<a name="l00355"></a>00355     u8 gotbeacon = (panDescriptor.<a class="code" href="structpanDescriptor__t.html#b88b47c58d2b004636b25fb75557b32a" title="Channel that the PAN operates on.">logicalChannel</a> != 0xff);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (gotbeacon)
<a name="l00358"></a>00358     {
<a name="l00359"></a>00359         <span class="comment">// Save the panDescriptor data to the PIB's.</span>
<a name="l00360"></a>00360         <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a> = panDescriptor.<a class="code" href="structpanDescriptor__t.html#e5e6733835d7a7422dba04e8aed655cc" title="PAN ID for the coordinator.">coorPANId</a>;
<a name="l00361"></a>00361         <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a> = panDescriptor.<a class="code" href="structpanDescriptor__t.html#ef9073f37c69898f538332fba8052d03" title="Short address of the node that sent the beacon.">coordAddr</a>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="comment">// Need to reset the PAN ID in the radio.</span>
<a name="l00364"></a>00364         <a class="code" href="group__radio.html#g8480a533bb1ba14171147bc1aeb78c7d" title="This function will set the PANID used by the address filter.">radioSetPanId</a>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <a class="code" href="group__mac.html#g62d975ef98590e2c23229df7b6d041c6" title="Set the radio&amp;#39;s operating channel, and saves that channel to the MAC&amp;#39;s global...">macSetOperatingChannel</a>(panDescriptor.<a class="code" href="structpanDescriptor__t.html#b88b47c58d2b004636b25fb75557b32a" title="Channel that the PAN operates on.">logicalChannel</a>);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <span class="comment">// We are one hop more than our (prospective) parent</span>
<a name="l00369"></a>00369         <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#33aa707181985abbf83a6bcaa8537009" title="Number of hops from this node to the coordinator.">hopsToCoord</a> = panDescriptor.<a class="code" href="structpanDescriptor__t.html#8ceeebc221ca893c3a7e322c84f8f19b" title="Number of hops from the beaconing node to the coordinator.">hopsToCoord</a> + 1;
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371     <span class="comment">// Confirm the scan, only if we have a valid coordinator</span>
<a name="l00372"></a>00372     <a class="code" href="group__app.html#g43fb16d48be1908e0a007eaccb6280c9" title="Callback function, called when the MAC has completed its channel scan.">appScanConfirm</a>(gotbeacon);
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00380"></a><a class="code" href="group__mac__scan.html#g419e8b2f87034aa835a01d150e516f52">00380</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#g419e8b2f87034aa835a01d150e516f52" title="Callback function, called from timer set in macFindClearChannel().">energyScanCallback</a>(<span class="keywordtype">void</span>)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00383"></a>00383     {
<a name="l00384"></a>00384         <span class="comment">// This function is a callback for macFindClearChannel()</span>
<a name="l00385"></a>00385         u8 maxChan = (<a class="code" href="group__mac.html#g036a88551664cfe893bc3f51a64ba179" title="When CHINA_MODE is set, there are only 4 channels (1-4).">CHINA_MODE</a> ? 4 : MAX_CHANNEL);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387         <span class="comment">// Check to see if we're done</span>
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (energy.currentChannel &gt;= maxChan)
<a name="l00389"></a>00389         {
<a name="l00390"></a>00390             <span class="comment">// Done scanning, pick a channel</span>
<a name="l00391"></a>00391             <a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a> = <span class="keyword">false</span>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393             <span class="comment">// Disable the energy detect interrupt</span>
<a name="l00394"></a>00394             u8 i;
<a name="l00395"></a>00395             i = <a class="code" href="group__arm.html#gfd58b0cad5bbd45b1c4a8d30be4bc11c" title="This function reads data from one of the radio transceiver&amp;#39;s registers.">hal_register_read</a>(<a class="code" href="group__radio__registers.html#g905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>);
<a name="l00396"></a>00396             <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>, i &amp; ~<a class="code" href="group__radio.html#g3b8f96ad72728a0a39d64efa2984ad46" title="Mask for the ED_READY interrupt.">HAL_ED_READY_MASK</a>);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398             <span class="comment">// Find lowest energy for a channel</span>
<a name="l00399"></a>00399             u16 bestEnergy = ~0;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401             <span class="keywordflow">for</span> (i=MIN_CHANNEL;i&lt;=maxChan;i++)
<a name="l00402"></a>00402             {
<a name="l00403"></a>00403                 <span class="comment">// find MIN energy on a channel</span>
<a name="l00404"></a>00404                 <span class="keywordflow">if</span> (energy.energy[i] &lt; bestEnergy)
<a name="l00405"></a>00405                     bestEnergy = energy.energy[i];
<a name="l00406"></a>00406             }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408             <span class="comment">// Make a list of channels with this energy level</span>
<a name="l00409"></a>00409             <span class="comment">// Use energy array as temp space.</span>
<a name="l00410"></a>00410             u8 ndx=0;
<a name="l00411"></a>00411             u8 channels[maxChan];
<a name="l00412"></a>00412             <span class="keywordflow">for</span> (i=MIN_CHANNEL;i&lt;=maxChan;i++)
<a name="l00413"></a>00413             {
<a name="l00414"></a>00414                 <span class="keywordflow">if</span> (energy.energy[i] == bestEnergy)
<a name="l00415"></a>00415                 {
<a name="l00416"></a>00416                     <span class="comment">// save to list</span>
<a name="l00417"></a>00417                     channels[ndx++] = i;
<a name="l00418"></a>00418                 }
<a name="l00419"></a>00419             }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 
<a name="l00422"></a>00422             <span class="comment">// Now pick a random channel from the list</span>
<a name="l00423"></a>00423             <span class="keywordflow">if</span> (ndx)
<a name="l00424"></a>00424             {
<a name="l00425"></a>00425                 u8 bestCh = channels[energy.randomVal%ndx];
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                 <span class="comment">// Call the app callback function</span>
<a name="l00428"></a>00428                 <a class="code" href="group__app.html#g8f71d0c0ed4dfe867f3cd0208a1299b6" title="Callback function, called when macFindClearChannel() completes.">appClearChanFound</a>(bestCh);
<a name="l00429"></a>00429             }
<a name="l00430"></a>00430             <span class="keywordflow">return</span>;
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433         <span class="comment">// Set new channel</span>
<a name="l00434"></a>00434         <a class="code" href="group__radio.html#g14d426a54ebfc9514e5f6c23eb7fc736" title="This function will change the operating channel.">radioSetOperatingChannel</a>(++energy.currentChannel);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="comment">// Send beacon request</span>
<a name="l00437"></a>00437         <a class="code" href="group__mac__scan.html#ge0a3ffbab485718432db4a80c86c87db" title="Send a beacon request frame.">sendBeaconRequest</a>();
<a name="l00438"></a>00438 
<a name="l00439"></a>00439         <span class="comment">// Start the energy detect scanning process (this will result in</span>
<a name="l00440"></a>00440         <span class="comment">// an IRQ, see macEdCallback)</span>
<a name="l00441"></a>00441         <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g4caa8e52e3f9ad2217864df65fdfd501" title="Offset for register PHY_ED_LEVEL.">RG_PHY_ED_LEVEL</a>, 0);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <span class="comment">// Set timer for next channel</span>
<a name="l00444"></a>00444         energy.timerID = <a class="code" href="group__timer__module.html#g0155e5192956b3cd498751d8652f7773" title="Sets a general purpose timer.">macSetAlarm</a>(<a class="code" href="group__mac__scan.html#g4c1c323d6bc3387b2c3fab879cf4d87e" title="Duration of scanning for each channel, in mSec.">SCANDURATION</a>, <a class="code" href="group__mac__scan.html#g419e8b2f87034aa835a01d150e516f52" title="Callback function, called from timer set in macFindClearChannel().">energyScanCallback</a>);
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 
<a name="l00453"></a><a class="code" href="group__mac__scan.html#ga219513a4f1154944e13866938508692">00453</a> <span class="keywordtype">void</span> <a class="code" href="group__arm.html#ga219513a4f1154944e13866938508692" title="Callback function, called by the radio ISR function when the radio issues an energy...">macEdCallback</a>(<span class="keywordtype">void</span>)
<a name="l00454"></a>00454 {
<a name="l00455"></a>00455     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00456"></a>00456     {
<a name="l00457"></a>00457         <span class="comment">// We have received an energy detect IRQ (ED_READY)</span>
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <span class="comment">// Accumulate the ED values.</span>
<a name="l00460"></a>00460         u8 e = <a class="code" href="group__arm.html#gfd58b0cad5bbd45b1c4a8d30be4bc11c" title="This function reads data from one of the radio transceiver&amp;#39;s registers.">hal_register_read</a>(<a class="code" href="group__radio__registers.html#g4caa8e52e3f9ad2217864df65fdfd501" title="Offset for register PHY_ED_LEVEL.">RG_PHY_ED_LEVEL</a>);
<a name="l00461"></a>00461         energy.energy[energy.currentChannel] += e;
<a name="l00462"></a>00462         <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g4caa8e52e3f9ad2217864df65fdfd501" title="Offset for register PHY_ED_LEVEL.">RG_PHY_ED_LEVEL</a>, 0);
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464 }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 
<a name="l00478"></a><a class="code" href="group__mac__scan.html#g26cb107f1a13ba8b3ba4008d00eb6b54">00478</a> <span class="keywordtype">void</span> <a class="code" href="group__mac__scan.html#g26cb107f1a13ba8b3ba4008d00eb6b54" title="This function is used by the coordinator to find a clear channel to use for the PAN...">macFindClearChannel</a>(<span class="keywordtype">void</span>)
<a name="l00479"></a>00479 {
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00481"></a>00481     {
<a name="l00482"></a>00482         <span class="keywordflow">if</span> (<a class="code" href="group__mac__associate.html#g339b747fe4e5bb7e7f252ba56727e3f5" title="Channel used for the PAN.">PAN_CHANNEL</a> != CHANNEL255)
<a name="l00483"></a>00483             <span class="comment">// In this mode, don't scan</span>
<a name="l00484"></a>00484             <a class="code" href="group__app.html#g8f71d0c0ed4dfe867f3cd0208a1299b6" title="Callback function, called when macFindClearChannel() completes.">appClearChanFound</a>(<a class="code" href="group__mac__associate.html#g339b747fe4e5bb7e7f252ba56727e3f5" title="Channel used for the PAN.">PAN_CHANNEL</a>);
<a name="l00485"></a>00485         <span class="keywordflow">else</span>
<a name="l00486"></a>00486         {
<a name="l00487"></a>00487             u8 i;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489             <span class="comment">// Clear channels array</span>
<a name="l00490"></a>00490             <span class="keywordflow">for</span> (i=0;i&lt;MAX_CHANNEL+1;i++)
<a name="l00491"></a>00491                 energy.energy[i] = 0;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493             <span class="comment">// Set first channel</span>
<a name="l00494"></a>00494             energy.currentChannel = MIN_CHANNEL - 1;
<a name="l00495"></a>00495             energy.timerID = 0;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497             <span class="comment">// Init radio</span>
<a name="l00498"></a>00498             <a class="code" href="group__mac.html#gaa0748a32ee5741afc6a5078d92158bb" title="Init the mac, which includes initializing the radio chip.">macInit</a>(0xff);
<a name="l00499"></a>00499             <a class="code" href="group__radio.html#g9c32d026c082234626f5f900077221bc" title="This function will change the current state of the radio transceiver&amp;#39;s internal...">radioSetTrxState</a>(<a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>);
<a name="l00500"></a>00500             energy.randomVal = <a class="code" href="group__radio.html#g301044554e9d047bf22935d01c615884" title="Returns a random number, composed of bits from the radio&amp;#39;s random number generator...">radioRandom</a>(8);
<a name="l00501"></a>00501             <a class="code" href="group__radio.html#g14d426a54ebfc9514e5f6c23eb7fc736" title="This function will change the operating channel.">radioSetOperatingChannel</a>(MIN_CHANNEL);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 
<a name="l00504"></a>00504             <span class="comment">// Scan through channels, using callback function</span>
<a name="l00505"></a>00505             <span class="comment">// This is tricky, since we need to do both an energy</span>
<a name="l00506"></a>00506             <span class="comment">// detect scan and a beacon scan</span>
<a name="l00507"></a>00507             <span class="comment">// Steps in the process</span>
<a name="l00508"></a>00508             <span class="comment">// 1. Issue a beacon request</span>
<a name="l00509"></a>00509             <span class="comment">//    (If any beacon comes, knock this channel off list)</span>
<a name="l00510"></a>00510             <span class="comment">// 2. Begin energy scan</span>
<a name="l00511"></a>00511             <span class="comment">//    Using macAlarm, do a bunch of scans</span>
<a name="l00512"></a>00512             <span class="comment">//      Issue scan command</span>
<a name="l00513"></a>00513             <span class="comment">//      Process IRQ's for ED ready</span>
<a name="l00514"></a>00514             <span class="comment">//      Average ED value</span>
<a name="l00515"></a>00515             <span class="comment">// 3. When scan duration time is up, move to next channel</span>
<a name="l00516"></a>00516 
<a name="l00517"></a>00517             <span class="comment">// Enable the Energy Detect interrupt</span>
<a name="l00518"></a>00518             i = <a class="code" href="group__arm.html#gfd58b0cad5bbd45b1c4a8d30be4bc11c" title="This function reads data from one of the radio transceiver&amp;#39;s registers.">hal_register_read</a>(<a class="code" href="group__radio__registers.html#g905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>);
<a name="l00519"></a>00519             <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>, i | <a class="code" href="group__radio.html#g3b8f96ad72728a0a39d64efa2984ad46" title="Mask for the ED_READY interrupt.">HAL_ED_READY_MASK</a>);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521             <span class="comment">// Start the scanning process</span>
<a name="l00522"></a>00522             <a class="code" href="group__mac__scan.html#g6ce4b7cec053bf6fc7dd474663b2db76" title="Flag to prevent re-entrancy in scanning.">scanInProcess</a> = <span class="keyword">true</span>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524             <a class="code" href="group__mac__scan.html#g419e8b2f87034aa835a01d150e516f52" title="Callback function, called from timer set in macFindClearChannel().">energyScanCallback</a>();
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jun 8 18:38:19 2009 for RUM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
