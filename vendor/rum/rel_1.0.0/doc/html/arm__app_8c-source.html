<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>RUM: rum_src/arm_app.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>rum_src/arm_app.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) 2008  ATMEL Corporation</span>
<a name="l00002"></a>00002 <span class="comment">   All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">   Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment">   modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">   * Redistributions of source code must retain the above copyright</span>
<a name="l00008"></a>00008 <span class="comment">     notice, this list of conditions and the following disclaimer.</span>
<a name="l00009"></a>00009 <span class="comment">   * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00010"></a>00010 <span class="comment">     notice, this list of conditions and the following disclaimer in</span>
<a name="l00011"></a>00011 <span class="comment">     the documentation and/or other materials provided with the</span>
<a name="l00012"></a>00012 <span class="comment">     distribution.</span>
<a name="l00013"></a>00013 <span class="comment">   * Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment">     contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment">     from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span>
<a name="l00018"></a>00018 <span class="comment">  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00019"></a>00019 <span class="comment">  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00020"></a>00020 <span class="comment">  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="l00021"></a>00021 <span class="comment">  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00022"></a>00022 <span class="comment">  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00023"></a>00023 <span class="comment">  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00024"></a>00024 <span class="comment">  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00025"></a>00025 <span class="comment">  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00026"></a>00026 <span class="comment">  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00027"></a>00027 <span class="comment">  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00028"></a>00028 <span class="comment">*/</span>
<a name="l00029"></a>00029 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00036"></a>00036 <span class="comment">// Utasker include</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "config.h"</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include "mac_event.h"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "arm_app.h"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "system.h"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "arm_timer.h"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "sensors.h"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "rum_types.h"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "mac_associate.h"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "radio.h"</span>
<a name="l00047"></a>00047 <span class="comment">// UIP include</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "net/uip-netif.h"</span>
<a name="l00049"></a>00049 <span class="comment">// EFSL includes</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "file.h"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "interfaces/sd.h"</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">// ---------- Local Macros and Globals ----------</span>
<a name="l00055"></a>00055 File sd_file;
<a name="l00056"></a>00056 eint8 sd_filename[20];
<a name="l00057"></a>00057 u8 files_sys_active;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">// Global stored ping address.</span>
<a name="l00060"></a>00060 u16 ping_address = 0;
<a name="l00061"></a>00061 <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> table_count;
<a name="l00062"></a>00062 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * nt;
<a name="l00063"></a>00063 <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> previous_TxLength = 0;
<a name="l00064"></a>00064 <span class="keyword">const</span> CHAR            cBuildInformation[] =
<a name="l00065"></a>00065                                     {<span class="charliteral">'B'</span>,<span class="charliteral">'A'</span>,<span class="charliteral">'N'</span>,<span class="charliteral">'D'</span>,<span class="charliteral">'='</span>,
<a name="l00066"></a>00066 <span class="preprocessor">#if (BAND == BAND2400)</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>                                     <span class="charliteral">'2'</span>,<span class="charliteral">'.'</span>,<span class="charliteral">'4'</span>,<span class="charliteral">'G'</span>,<span class="charliteral">'H'</span>,<span class="charliteral">'z'</span>,
<a name="l00068"></a>00068 <span class="preprocessor">#elif (BAND == BAND900)</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>                                     <span class="charliteral">'9'</span>,<span class="charliteral">'0'</span>,<span class="charliteral">'0'</span>,<span class="charliteral">'M'</span>,<span class="charliteral">'H'</span>,<span class="charliteral">'z'</span>,
<a name="l00070"></a>00070 <span class="preprocessor">#else</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>                                     <span class="charliteral">'?'</span>,
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>                                     <span class="charliteral">' '</span>,<span class="charliteral">'S'</span>,<span class="charliteral">'L'</span>,<span class="charliteral">'E'</span>,<span class="charliteral">'E'</span>,<span class="charliteral">'P'</span>,<span class="charliteral">'='</span>,
<a name="l00074"></a>00074 <span class="preprocessor">#if (RUMSLEEP)</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>                                     <span class="charliteral">'1'</span>,
<a name="l00076"></a>00076 <span class="preprocessor">#else</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>                                     <span class="charliteral">'0'</span>,
<a name="l00078"></a>00078 <span class="preprocessor">#endif</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>                                    <span class="charliteral">' '</span>, <span class="charliteral">'H'</span>,<span class="charliteral">'W'</span>,<span class="charliteral">'='</span>,
<a name="l00080"></a>00080 <span class="preprocessor">#ifdef SAM7X_EVAL</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>                                    <span class="charliteral">'A'</span>,<span class="charliteral">'T'</span>,<span class="charliteral">'9'</span>,<span class="charliteral">'1'</span>,<span class="charliteral">'S'</span>,<span class="charliteral">'A'</span>,<span class="charliteral">'M'</span>,<span class="charliteral">'7'</span>,<span class="charliteral">'X'</span>,<span class="charliteral">'-'</span>,<span class="charliteral">'E'</span>,<span class="charliteral">'K'</span>,
<a name="l00082"></a>00082 <span class="preprocessor">#else</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>                                    <span class="charliteral">'?'</span>,
<a name="l00084"></a>00084 <span class="preprocessor">#endif</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>                                    0};
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">// Turn on and off reading print out.</span>
<a name="l00088"></a>00088 u8 telPrintReading = 0;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 stored_readings_t stored_data[MAX_STORED_READINGS];
<a name="l00091"></a>00091 
<a name="l00100"></a>00100 CHAR *armAppBuildInfo(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *usLengthToSend)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     *usLengthToSend = (<span class="keyword">sizeof</span>(cBuildInformation)-1);
<a name="l00103"></a>00103     <span class="keywordflow">return</span> (CHAR *)cBuildInformation;
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00112"></a>00112 <span class="keywordtype">void</span> armAppPingReq(CHAR *ptrData)
<a name="l00113"></a>00113 {
<a name="l00114"></a>00114     <span class="comment">// This is a ping command.</span>
<a name="l00115"></a>00115     <span class="keywordflow">if</span>(*ptrData == <span class="charliteral">'1'</span>)
<a name="l00116"></a>00116     {
<a name="l00117"></a>00117         <span class="comment">// Check that the field is not empty.</span>
<a name="l00118"></a>00118         <span class="keywordflow">if</span>(*(ptrData + 2) != <span class="charliteral">' '</span>)
<a name="l00119"></a>00119         {
<a name="l00120"></a>00120             ping_address = (<span class="keywordtype">unsigned</span> short)fnHexStrHex(ptrData + 2);
<a name="l00121"></a>00121             <a class="code" href="group__mac__data.html#g7e4c5d07ec7a2622dabbcf51b1fe4ba9" title="Send a ping packet (either request or response) to another node.">macPing</a>(<a class="code" href="group__mac.html#g85ba6c45557eb0369e606452f9d902e6" title="Ping request frame.">PING_REQ_FRAME</a>, ping_address);
<a name="l00122"></a>00122         }
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00135"></a>00135 <span class="keywordtype">void</span> armAppPingHandler(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ptrBuffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *usLengthToSend, CHAR *cValue, CHAR *cPtr)
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137     <span class="keywordflow">switch</span> (*ptrBuffer)
<a name="l00138"></a>00138     {
<a name="l00139"></a>00139         <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
<a name="l00140"></a>00140             <span class="keywordflow">if</span>(ping_address == 0)
<a name="l00141"></a>00141                 cPtr = (uStrcpy(cValue, <span class="stringliteral">""</span>) - 1);
<a name="l00142"></a>00142             <span class="keywordflow">else</span>
<a name="l00143"></a>00143                 cPtr = (fnBufferHex(ping_address, (2 | NO_LEADIN | CODE_CAPITALS), cValue) - 1);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145             *usLengthToSend = (cPtr - cValue);
<a name="l00146"></a>00146         <span class="keywordflow">break</span>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <span class="keywordflow">case</span> <span class="charliteral">'2'</span>:
<a name="l00149"></a>00149             <span class="keywordflow">if</span>(ping_address == 0)
<a name="l00150"></a>00150                 cPtr = (uStrcpy(cValue, <span class="stringliteral">""</span>) - 1);
<a name="l00151"></a>00151             <span class="keywordflow">else</span>
<a name="l00152"></a>00152                 cPtr = (fnBufferHex(ping_address, (2 | WITH_LEADIN | CODE_CAPITALS), cValue) - 1);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154             *usLengthToSend = (cPtr - cValue);
<a name="l00155"></a>00155         <span class="keywordflow">break</span>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157         <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
<a name="l00158"></a>00158             <a class="code" href="group__mac__event.html#g9b4bd3c99bd01a997dfbf36de2db14ae" title="This is the main loop task for the MAC.">macTask</a>();
<a name="l00159"></a>00159             <span class="keywordflow">if</span>(ping_address == 0)
<a name="l00160"></a>00160                 cPtr = (uStrcpy(cValue, <span class="stringliteral">""</span>) - 1);
<a name="l00161"></a>00161             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(gotPanCoordPing == 1)
<a name="l00162"></a>00162             {
<a name="l00163"></a>00163                 cPtr = (uStrcpy(cValue, <span class="stringliteral">"Ping Success"</span>) - 1);
<a name="l00164"></a>00164                 gotPanCoordPing = 0;
<a name="l00165"></a>00165             }
<a name="l00166"></a>00166             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(gotPanCoordPing == 0)
<a name="l00167"></a>00167                 cPtr = (uStrcpy(cValue, <span class="stringliteral">"Ping Failed"</span>) - 1);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169             *usLengthToSend = (cPtr - cValue);
<a name="l00170"></a>00170         <span class="keywordflow">break</span>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         <span class="keywordflow">default</span>:
<a name="l00173"></a>00173         <span class="keywordflow">break</span>;
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00189"></a>00189 CHAR *armAppNetworkTable(LENGTH_CHUNK_COUNT TxLength, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *usLengthToSend, CHAR *cValue, CHAR *cPtr, HTTP *http_session)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <a class="code" href="structassociatedNodes__t.html" title="This is the structure for each element of the table of the associated nodes.">associatedNodes_t</a> *node;
<a name="l00192"></a>00192 <span class="preprocessor">#if IPV6LOWPAN</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>    <span class="keywordtype">char</span> ipv6_addr[60]; <span class="comment">/* Store IPv6 Address: worst-case size */</span>
<a name="l00194"></a>00194 <span class="preprocessor">#endif // IPV6LOWPAN</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>
<a name="l00196"></a>00196     <span class="comment">// Check if we need to regenerate un-transmitted data.</span>
<a name="l00197"></a>00197     <span class="keywordflow">if</span>(previous_TxLength == TxLength)
<a name="l00198"></a>00198     {
<a name="l00199"></a>00199         table_count--;
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment">// Store last chunk TXLength.</span>
<a name="l00203"></a>00203     previous_TxLength = TxLength;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="keywordflow">if</span>(table_count == 0)
<a name="l00206"></a>00206     {
<a name="l00207"></a>00207         http_session-&gt;ucDynamicFlags |= GENERATING_DYNAMIC_BINARY;   <span class="comment">// ensure the HTTP server knows that we are generating binary content</span>
<a name="l00208"></a>00208         cPtr = (uStrcpy(cValue, <span class="stringliteral">"&lt;TABLE cellspacing=\"5\" bgcolor=\"#FFFFFF\" border=\"border\" align=\"center\"&gt; \</span>
<a name="l00209"></a>00209 <span class="stringliteral">        &lt;TR&gt;&lt;TD align=\"center\" style=\"width: 150px\"&gt;Node Short Address&lt;/TD&gt;&lt;TD \</span>
<a name="l00210"></a>00210 <span class="stringliteral">        align=\"center\" style=\"width: 114px\"&gt;Node Type&lt;/TD&gt;&lt;TD align=\"center\" style=\"width: 220px\" \</span>
<a name="l00211"></a>00211 <span class="stringliteral">        &gt;Node Long Address&lt;/TD&gt;&lt;TD align=\"center\" style=\"width: 163px\"&gt;Parent Short Address&lt;/TD&gt;&lt;TD  \</span>
<a name="l00212"></a>00212 <span class="stringliteral">        align=\"center\" style=\"width: 162px\"&gt;Last Routed Address&lt;/TD&gt;&lt;TD align=\"center\" \</span>
<a name="l00213"></a>00213 <span class="stringliteral">        style=\"width: 220px\"&gt;IP Address&lt;/TD&gt;&lt;TD align=\"center\" style=\"width: 111px\"&gt;Node Data&lt;/TD&gt;&lt;/TR&gt;"</span>) - 1);
<a name="l00214"></a>00214         *usLengthToSend = (cPtr - cValue);
<a name="l00215"></a>00215         table_count++;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(table_count == 1)
<a name="l00218"></a>00218     {
<a name="l00219"></a>00219         http_session-&gt;ucDynamicFlags |= GENERATING_DYNAMIC_BINARY;   <span class="comment">// ensure the HTTP server knows that we are generating binary content</span>
<a name="l00220"></a>00220         cPtr = (uStrcpy(cValue, <span class="stringliteral">"&lt;TR&gt;&lt;TD align=\"center\" style=\"width: 150px\"&gt;"</span>) - 1);
<a name="l00221"></a>00221         cPtr = (fnBufferHex((table_count-1), (2 | WITH_LEADIN | CODE_CAPITALS), cPtr) - 1);
<a name="l00222"></a>00222         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00223"></a>00223         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 114px\"&gt;COORD&lt;/TD&gt;"</span>) - 1);
<a name="l00224"></a>00224         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 220px\"&gt;"</span>) - 1);
<a name="l00225"></a>00225         u32 low = (u32)DEFAULT_ARM_COORD_LONG;
<a name="l00226"></a>00226         u32 high = (u32)(DEFAULT_ARM_COORD_LONG &gt;&gt; 32);
<a name="l00227"></a>00227         cPtr = (fnBufferHex(high, (4 | WITH_LEADIN | CODE_CAPITALS), cPtr) - 1);
<a name="l00228"></a>00228         cPtr = (fnBufferHex(low, (4 | CODE_CAPITALS), cPtr) - 1);
<a name="l00229"></a>00229         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00230"></a>00230         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 163px\"&gt;0xFFFF&lt;/TD&gt;"</span>) - 1);
<a name="l00231"></a>00231         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 162px\"&gt;0xFFFF&lt;/TD&gt;"</span>) - 1);
<a name="l00232"></a>00232         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 220px\"&gt;"</span>) -1);
<a name="l00233"></a>00233         cPtr = fnIPStr(&amp;network.ucOurIP[0], cPtr);
<a name="l00234"></a>00234 <span class="preprocessor">#if IPV6LOWPAN</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(uip_netif_physical_if[INTERFACE_ETHERNET].addresses[1].state != NOT_USED)
<a name="l00236"></a>00236         {
<a name="l00237"></a>00237             sprint_ip(ipv6_addr, uip_netif_physical_if[INTERFACE_ETHERNET].addresses[1].ipaddr.u16);
<a name="l00238"></a>00238             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;br&gt;IPv6 Ethernet IF&lt;br&gt;"</span>) - 1);
<a name="l00239"></a>00239             cPtr = (uStrcpy(cPtr, ipv6_addr) - 1);
<a name="l00240"></a>00240             sprint_ip(ipv6_addr, uip_netif_physical_if[INTERFACE_802154].addresses[1].ipaddr.u16);
<a name="l00241"></a>00241             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;br&gt;IPv6 6LoWPAN IF&lt;br&gt;"</span>) - 1);
<a name="l00242"></a>00242             cPtr = (uStrcpy(cPtr, ipv6_addr) - 1);
<a name="l00243"></a>00243         }
<a name="l00244"></a>00244 <span class="preprocessor">#endif // IPV6LOWPAN</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span>        cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00246"></a>00246         cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 111px\"&gt;N/A&lt;/TD&gt;&lt;/TR&gt;"</span>) - 1);
<a name="l00247"></a>00247         *usLengthToSend = (cPtr - cValue);
<a name="l00248"></a>00248         table_count++;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     <span class="keywordflow">else</span> <span class="keywordflow">if</span>((table_count-1) &lt; MAXNODES)
<a name="l00251"></a>00251     {
<a name="l00252"></a>00252         http_session-&gt;ucDynamicFlags |= GENERATING_DYNAMIC_BINARY;   <span class="comment">// ensure the HTTP server knows that we are generating binary content</span>
<a name="l00253"></a>00253         <span class="comment">// Start at index 1.</span>
<a name="l00254"></a>00254         node = <a class="code" href="group__mac__associate.html#g553b1ee14bf13a99a122ff51176477fd" title="Gets one entry in the table of nodes.">macGetNode</a>(table_count-1);
<a name="l00255"></a>00255         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structassociatedNodes__t.html#00c2b0c5a9e3216e2b3e8eac93049bcb" title="Type of node, see COORD for types.">nodeType</a>)
<a name="l00256"></a>00256         {
<a name="l00257"></a>00257             cPtr = (uStrcpy(cValue, <span class="stringliteral">"&lt;TR&gt;&lt;TD align=\"center\" style=\"width: 150px\"&gt;"</span>) - 1);
<a name="l00258"></a>00258             cPtr = (fnBufferHex((table_count-1), (2 | WITH_LEADIN | CODE_CAPITALS), cPtr) - 1);
<a name="l00259"></a>00259             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00260"></a>00260             <span class="keywordflow">if</span>(node-&gt;<a class="code" href="structassociatedNodes__t.html#00c2b0c5a9e3216e2b3e8eac93049bcb" title="Type of node, see COORD for types.">nodeType</a> == <a class="code" href="group__mac.html#gfa11cf93bface598cd7a0fa88a71285c" title="End node.">ENDDEVICE</a>)
<a name="l00261"></a>00261                 cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 114px\"&gt;ENDNODE&lt;/TD&gt;"</span>) - 1);
<a name="l00262"></a>00262             <span class="keywordflow">else</span>
<a name="l00263"></a>00263                 cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 114px\"&gt;ROUTER&lt;/TD&gt;"</span>) - 1);
<a name="l00264"></a>00264             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 220px\"&gt;"</span>) - 1);
<a name="l00265"></a>00265             u32 low = (u32)node-&gt;<a class="code" href="structassociatedNodes__t.html#9d7346120085e6baba3ad139798e965c" title="The long (MAC) address of the node.">nodeLongAddress</a>;
<a name="l00266"></a>00266             u32 high = (u32)(node-&gt;<a class="code" href="structassociatedNodes__t.html#9d7346120085e6baba3ad139798e965c" title="The long (MAC) address of the node.">nodeLongAddress</a> &gt;&gt; 32);
<a name="l00267"></a>00267             cPtr = (fnBufferHex(high, (4 | WITH_LEADIN | CODE_CAPITALS), cPtr) - 1);
<a name="l00268"></a>00268             cPtr = (fnBufferHex(low, (4 | CODE_CAPITALS), cPtr) - 1);
<a name="l00269"></a>00269             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00270"></a>00270             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 163px\"&gt;"</span>) - 1);
<a name="l00271"></a>00271             cPtr = (fnBufferHex((node-&gt;<a class="code" href="structassociatedNodes__t.html#c68e2fd1506c487b6420092296e47f6f" title="The short address of the parent of this node.">parentShortAddress</a>), (2 | WITH_LEADIN | CODE_CAPITALS), cPtr) - 1);
<a name="l00272"></a>00272             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00273"></a>00273             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 162px\"&gt;"</span>) - 1);
<a name="l00274"></a>00274             cPtr = (fnBufferHex((node-&gt;<a class="code" href="structassociatedNodes__t.html#91bdd515ac749496dfc61130d24eb0fa" title="The short address of the last route from this node.">lastRoutedAddress</a>), (2 | WITH_LEADIN | CODE_CAPITALS), cPtr) - 1);
<a name="l00275"></a>00275             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00276"></a>00276             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 220px\"&gt;"</span>) -1);
<a name="l00277"></a>00277 <span class="preprocessor">#if IPV6LOWPAN</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ipv6_lookup_addr(ipv6_addr, (table_count-1)))
<a name="l00279"></a>00279             {
<a name="l00280"></a>00280                 cPtr = (uStrcpy(cPtr, ipv6_addr) - 1);
<a name="l00281"></a>00281             }
<a name="l00282"></a>00282             <span class="keywordflow">else</span> <span class="comment">// Copy new IPv6 address into buffer.</span>
<a name="l00283"></a>00283 <span class="preprocessor">#endif // IPV6LOWPAN</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>            {
<a name="l00285"></a>00285                 cPtr = (uStrcpy(cPtr, <span class="stringliteral">"Unknown"</span>) - 1);
<a name="l00286"></a>00286             }
<a name="l00287"></a>00287             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;/TD&gt;"</span>) - 1);
<a name="l00288"></a>00288             cPtr = (uStrcpy(cPtr, <span class="stringliteral">"&lt;TD align=\"center\" style=\"width: 111px\"&gt;N/A&lt;/TD&gt;&lt;/TR&gt;"</span>) - 1);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290             *usLengthToSend = (cPtr - cValue);
<a name="l00291"></a>00291             table_count++;
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293         <span class="keywordflow">else</span>
<a name="l00294"></a>00294         {
<a name="l00295"></a>00295             *usLengthToSend = 0;
<a name="l00296"></a>00296             table_count++;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300     <span class="keywordflow">else</span> <span class="keywordflow">if</span>((table_count-1) == MAXNODES)
<a name="l00301"></a>00301     {
<a name="l00302"></a>00302         http_session-&gt;ucDynamicFlags |= LAST_DYNAMIC_CONTENT_DATA;
<a name="l00303"></a>00303         cPtr = uStrcpy(cValue, <span class="stringliteral">"&lt;/TABLE&gt;"</span>);
<a name="l00304"></a>00304         *usLengthToSend = (cPtr - cValue);
<a name="l00305"></a>00305         table_count++;
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     <span class="keywordflow">else</span>
<a name="l00308"></a>00308     {
<a name="l00309"></a>00309         http_session-&gt;ucDynamicFlags = NO_DYNAMIC_CONTENT_TO_ADD;<span class="comment">// inform that we don't want to generate anything this time</span>
<a name="l00310"></a>00310         previous_TxLength = 0;
<a name="l00311"></a>00311         table_count = 0;
<a name="l00312"></a>00312         <span class="keywordflow">return</span> 0;
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="keywordflow">return</span> cValue;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00329"></a>00329 <span class="keywordtype">int</span> tcpListener(USOCKET Socket, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ucEvent, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ucIp_Data, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> usPortLen)
<a name="l00330"></a>00330 {
<a name="l00331"></a>00331     <span class="keyword">volatile</span> s16 queue;
<a name="l00332"></a>00332     <span class="keyword">volatile</span> u8 local_evt;
<a name="l00333"></a>00333     <span class="keyword">volatile</span> u8 buf[100];
<a name="l00334"></a>00334     <span class="keyword">volatile</span> <span class="keywordtype">int</span> iReturn = APP_ACCEPT;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     local_evt = ucEvent;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="keywordflow">switch</span> (local_evt)
<a name="l00339"></a>00339     {
<a name="l00340"></a>00340     <span class="keywordflow">case</span> TCP_EVENT_CONREQ:
<a name="l00341"></a>00341     <span class="keywordflow">case</span> TCP_EVENT_CONNECTED:
<a name="l00342"></a>00342         uStrcpy((CHAR *)buf, <span class="stringliteral">"Hi!!\r\n"</span>);
<a name="l00343"></a>00343         queue = fnSendBufTCP(Socket, (u8 *)buf, 6, (TCP_BUF_SEND | TCP_BUF_SEND_REPORT_COPY));
<a name="l00344"></a>00344         iReturn =  APP_SENT_DATA;
<a name="l00345"></a>00345         <span class="keywordflow">break</span>;
<a name="l00346"></a>00346     <span class="keywordflow">case</span> TCP_EVENT_CLOSE:
<a name="l00347"></a>00347     <span class="keywordflow">case</span> TCP_EVENT_ACK:
<a name="l00348"></a>00348         <span class="comment">// Send next buffered (if waiting)</span>
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (fnSendBufTCP(Socket, 0, 0, TCP_BUF_NEXT))
<a name="l00350"></a>00350         {
<a name="l00351"></a>00351             iReturn = APP_SENT_DATA;    <span class="comment">// Mark that data has been transmitted</span>
<a name="l00352"></a>00352         }
<a name="l00353"></a>00353         <span class="keywordflow">break</span>;
<a name="l00354"></a>00354     <span class="keywordflow">case</span> TCP_EVENT_ARP_RESOLUTION_FAILED:
<a name="l00355"></a>00355 <span class="preprocessor">    #ifdef SUPPORT_PEER_WINDOW</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span>    <span class="keywordflow">case</span> TCP_EVENT_PARTIAL_ACK:
<a name="l00357"></a>00357         <span class="comment">// Possible ack to a part of a transmission received</span>
<a name="l00358"></a>00358         <span class="comment">// Send next buffered (if waiting)</span>
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (fnSendBufTCP(Socket, 0, usPortLen, TCP_BUF_NEXT))
<a name="l00360"></a>00360         {
<a name="l00361"></a>00361             iReturn =  APP_SENT_DATA;
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363         <span class="keywordflow">break</span>;
<a name="l00364"></a>00364 <span class="preprocessor">    #endif</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>    <span class="keywordflow">case</span> TCP_EVENT_REGENERATE:
<a name="l00366"></a>00366         <span class="keywordflow">if</span> (fnSendBufTCP(Socket, 0, 0, TCP_BUF_REP) != 0) <span class="comment">// repeat send buffered</span>
<a name="l00367"></a>00367         {
<a name="l00368"></a>00368 <span class="preprocessor">          #ifdef SUPPORT_PEER_WINDOW</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>            <span class="comment">// Kick off any following data as long as windowing allows it</span>
<a name="l00370"></a>00370             fnSendBufTCP(Socket, 0, 0, (TCP_BUF_NEXT | TCP_BUF_KICK_NEXT));
<a name="l00371"></a>00371 <span class="preprocessor">          #endif</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>            iReturn =  APP_SENT_DATA;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374         <span class="keywordflow">break</span>;
<a name="l00375"></a>00375     <span class="keywordflow">case</span> TCP_EVENT_DATA:
<a name="l00376"></a>00376         memset((CHAR *)buf, 0, 100);
<a name="l00377"></a>00377         uStrcpy((CHAR *)buf, <span class="stringliteral">"Eat at Joe's\r\n"</span>);
<a name="l00378"></a>00378         queue = fnSendBufTCP(Socket, (u8 *)buf, 14, (TCP_BUF_SEND | TCP_BUF_SEND_REPORT_COPY));
<a name="l00379"></a>00379         tcp_parse_command(Socket, ucIp_Data, usPortLen);
<a name="l00380"></a>00380         iReturn =  APP_SENT_DATA;
<a name="l00381"></a>00381         <span class="keywordflow">break</span>;
<a name="l00382"></a>00382     <span class="keywordflow">case</span> TCP_EVENT_ABORT:
<a name="l00383"></a>00383     <span class="keywordflow">case</span> TCP_EVENT_CLOSED:
<a name="l00384"></a>00384         <span class="comment">// Go back to listening state on the same port number</span>
<a name="l00385"></a>00385         fnTCP_Listen(Socket, TCP_PORT, 0);
<a name="l00386"></a>00386         <span class="keywordflow">break</span>;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388     <span class="keywordflow">return</span> iReturn;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00398"></a>00398 <span class="keywordtype">void</span> tcp_parse_command(USOCKET Socket, u8 * data, <span class="keywordtype">int</span> len)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400     <span class="keyword">volatile</span> u16 addr;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="keywordflow">switch</span>(data[0])
<a name="l00403"></a>00403     {
<a name="l00404"></a>00404         <span class="comment">// Ping Request</span>
<a name="l00405"></a>00405         <span class="keywordflow">case</span> 0x01:
<a name="l00406"></a>00406             <span class="comment">// Send ping request to node address.</span>
<a name="l00407"></a>00407             addr = data[2];
<a name="l00408"></a>00408             addr &lt;&lt;= 8;
<a name="l00409"></a>00409             addr |= data[1];
<a name="l00410"></a>00410             <a class="code" href="group__mac__data.html#g7e4c5d07ec7a2622dabbcf51b1fe4ba9" title="Send a ping packet (either request or response) to another node.">macPing</a>(<a class="code" href="group__mac.html#g85ba6c45557eb0369e606452f9d902e6" title="Ping request frame.">PING_REQ_FRAME</a>, (u16)addr);
<a name="l00411"></a>00411             fnDebugMsg(<span class="stringliteral">"\r\nTCP Ping to"</span>);
<a name="l00412"></a>00412             fnDebugHex(addr, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00413"></a>00413             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00414"></a>00414             <span class="keywordflow">break</span>;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="comment">// Remove Node</span>
<a name="l00417"></a>00417         <span class="keywordflow">case</span> 0x02:
<a name="l00418"></a>00418             <span class="comment">// STUB FUNCTION</span>
<a name="l00419"></a>00419             <span class="keywordflow">break</span>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="preprocessor">#if APP == SENSOR</span>
<a name="l00422"></a>00422 <span class="preprocessor"></span>        u8 calpoint;
<a name="l00423"></a>00423         <span class="comment">// Send Cal Data</span>
<a name="l00424"></a>00424         <span class="keywordflow">case</span> 0x03:
<a name="l00425"></a>00425             <span class="comment">// Send request for cal info to node address.</span>
<a name="l00426"></a>00426             calpoint = data[1];
<a name="l00427"></a>00427             <span class="keywordtype">char</span> <span class="keywordtype">string</span>[10];
<a name="l00428"></a>00428             strncpy(<span class="keywordtype">string</span>, (<span class="keywordtype">char</span> *)&amp;data[2], 8);
<a name="l00429"></a>00429             <span class="keywordtype">string</span>[8] = 0;
<a name="l00430"></a>00430             sensorSendCalPoint(calpoint, <span class="keywordtype">string</span>);
<a name="l00431"></a>00431             fnDebugMsg(<span class="stringliteral">"\r\nTCP Set Cal Data to"</span>);
<a name="l00432"></a>00432             fnDebugHex(addr, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00433"></a>00433             fnDebugMsg(<span class="stringliteral">" with data "</span>);
<a name="l00434"></a>00434             fnDebugMsg(<span class="keywordtype">string</span>);
<a name="l00435"></a>00435             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00436"></a>00436             <span class="keywordflow">break</span>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438         <span class="comment">// Get Cal Data</span>
<a name="l00439"></a>00439         <span class="keywordflow">case</span> 0x04:
<a name="l00440"></a>00440             <span class="comment">// Send request for cal info to node address.</span>
<a name="l00441"></a>00441             addr = data[2];
<a name="l00442"></a>00442             addr &lt;&lt;= 8;
<a name="l00443"></a>00443             addr |= data[1];
<a name="l00444"></a>00444             <a class="code" href="group__sensors.html#g7be640146ea956f71c4540c1b247567c" title="Request an end node to send its calibration information.">sensorRequestCalInfo</a>((u16)addr);
<a name="l00445"></a>00445             fnDebugMsg(<span class="stringliteral">"\r\nTCP Get Cal Data from"</span>);
<a name="l00446"></a>00446             fnDebugHex(addr, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00447"></a>00447             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00448"></a>00448             <span class="keywordflow">break</span>;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="comment">// Set Name</span>
<a name="l00451"></a>00451         <span class="keywordflow">case</span> 0x05:
<a name="l00452"></a>00452             <span class="comment">// Send set name request to node address.</span>
<a name="l00453"></a>00453             addr = data[2];
<a name="l00454"></a>00454             addr &lt;&lt;= 8;
<a name="l00455"></a>00455             addr |= data[1];
<a name="l00456"></a>00456             strncpy(<span class="keywordtype">string</span>, (<span class="keywordtype">char</span> *)&amp;data[3], 8);
<a name="l00457"></a>00457             <span class="keywordtype">string</span>[8] = 0;
<a name="l00458"></a>00458             <a class="code" href="group__sensors.html#g0717b6140ef26cb1daa46ac31113f034" title="Set the name of the sensor name.">sensorSendSetNodeName</a>((u16)addr, <span class="keywordtype">string</span>);
<a name="l00459"></a>00459             fnDebugMsg(<span class="stringliteral">"\r\nTCP Set Name of"</span>);
<a name="l00460"></a>00460             fnDebugHex(addr, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00461"></a>00461             fnDebugMsg(<span class="stringliteral">"  to  "</span>);
<a name="l00462"></a>00462             fnDebugMsg(<span class="keywordtype">string</span>);
<a name="l00463"></a>00463             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00464"></a>00464             <span class="keywordflow">break</span>;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466         <span class="comment">// Get Name</span>
<a name="l00467"></a>00467         <span class="keywordflow">case</span> 0x06:
<a name="l00468"></a>00468             <span class="comment">// Send get name request to node address.</span>
<a name="l00469"></a>00469             addr = data[2];
<a name="l00470"></a>00470             addr &lt;&lt;= 8;
<a name="l00471"></a>00471             addr |= data[1];
<a name="l00472"></a>00472             <a class="code" href="group__sensors.html#g32bb0a72bd1635959ac4397db317edae" title="Request a reading from a sensor node.">sensorRequestReading</a>((u16)addr, 20);
<a name="l00473"></a>00473             fnDebugMsg(<span class="stringliteral">"\r\nTCP Get Name from"</span>);
<a name="l00474"></a>00474             fnDebugHex(addr, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00475"></a>00475             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00476"></a>00476             <span class="keywordflow">break</span>;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478         <span class="comment">// Send Data</span>
<a name="l00479"></a>00479         <span class="keywordflow">case</span> 0x07:
<a name="l00480"></a>00480             <span class="comment">// Tell node to send data on periodic interval.</span>
<a name="l00481"></a>00481             addr = data[2];
<a name="l00482"></a>00482             addr &lt;&lt;= 8;
<a name="l00483"></a>00483             addr |= data[1];
<a name="l00484"></a>00484             u16 time = data[3];
<a name="l00485"></a>00485             <a class="code" href="group__sensors.html#g32bb0a72bd1635959ac4397db317edae" title="Request a reading from a sensor node.">sensorRequestReading</a>((u16)addr, time);
<a name="l00486"></a>00486             fnDebugMsg(<span class="stringliteral">"\r\nTCP Send Data Cmd to"</span>);
<a name="l00487"></a>00487             fnDebugHex(addr, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00488"></a>00488             fnDebugMsg(<span class="stringliteral">" with interval "</span>);
<a name="l00489"></a>00489             fnDebugHex(time, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 2));
<a name="l00490"></a>00490             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00491"></a>00491             <span class="keywordflow">break</span>;
<a name="l00492"></a>00492 <span class="preprocessor">#endif // APP == SENSOR</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>
<a name="l00494"></a>00494         <span class="comment">// Send network table info.</span>
<a name="l00495"></a>00495         <span class="keywordflow">case</span> 0x08:
<a name="l00496"></a>00496             <span class="comment">// Send all the data in the network table.</span>
<a name="l00497"></a>00497             get_nwk_table(host_socket);
<a name="l00498"></a>00498             fnDebugMsg(<span class="stringliteral">"\r\nTCP Send Network Table from coord"</span>);
<a name="l00499"></a>00499             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00500"></a>00500             <span class="keywordflow">break</span>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="keywordflow">default</span>:
<a name="l00503"></a>00503             <span class="keywordflow">break</span>;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00512"></a>00512 <span class="keywordtype">void</span> get_nwk_table(USOCKET Socket)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514     u16 i;
<a name="l00515"></a>00515     <a class="code" href="structassociatedNodes__t.html" title="This is the structure for each element of the table of the associated nodes.">associatedNodes_t</a> *node;
<a name="l00516"></a>00516     u8 hostbuf[50];
<a name="l00517"></a>00517     u8 temp = 0;
<a name="l00518"></a>00518     s16 queue;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     queue = fnSendBufTCP(host_socket, (u8 *)<span class="stringliteral">"WIRELESST"</span>, 9, TCP_BUF_SEND);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <span class="keywordflow">if</span>(telPrintReading &amp;&amp; (queue &gt; 0))
<a name="l00523"></a>00523         fnDebugMsg(<span class="stringliteral">"\r\nWIRELESST buffered for TCP\r\n"</span>);
<a name="l00524"></a>00524     <span class="keywordflow">else</span>
<a name="l00525"></a>00525         fnDebugMsg(<span class="stringliteral">"\r\nWIRELESST buffer problem\r\n"</span>);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="keywordflow">for</span>(i=0; i&lt;MAXNODES; i++)
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529         node = <a class="code" href="group__mac__associate.html#g553b1ee14bf13a99a122ff51176477fd" title="Gets one entry in the table of nodes.">macGetNode</a>(i);
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structassociatedNodes__t.html#00c2b0c5a9e3216e2b3e8eac93049bcb" title="Type of node, see COORD for types.">nodeType</a>)
<a name="l00531"></a>00531         {
<a name="l00532"></a>00532             memset(hostbuf, 0, 50);
<a name="l00533"></a>00533             memcpy(hostbuf, node, <span class="keyword">sizeof</span>(<a class="code" href="structassociatedNodes__t.html" title="This is the structure for each element of the table of the associated nodes.">associatedNodes_t</a>));
<a name="l00534"></a>00534 <span class="comment">//            ipv6_lookup_addr((char *)&amp;hostbuf[sizeof(associatedNodes_t)], i);</span>
<a name="l00535"></a>00535             queue = fnSendBufTCP(host_socket, hostbuf, 50, TCP_BUF_SEND);
<a name="l00536"></a>00536             <span class="keywordflow">if</span>(telPrintReading &amp;&amp; (queue &lt;= 0))
<a name="l00537"></a>00537                 fnDebugMsg(<span class="stringliteral">"\r\nTable buffer problem"</span>);
<a name="l00538"></a>00538             temp++;
<a name="l00539"></a>00539         }
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541     hostbuf[0]=0xFF;
<a name="l00542"></a>00542     fnSendBufTCP(host_socket, hostbuf, 1, 0);
<a name="l00543"></a>00543     fnDebugMsg(<span class="stringliteral">"node count = "</span>);
<a name="l00544"></a>00544     fnDebugDec(temp, 0, 0);
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00552"></a>00552 u8 rf2xxregnames[][16] =
<a name="l00553"></a>00553     {<span class="stringliteral">"TRX_STATUS"</span>, <span class="stringliteral">"TRX_STATE"</span>, <span class="stringliteral">"TRX_CTRL_0"</span>, <span class="stringliteral">"TRX_CTRL_1"</span>, <span class="stringliteral">"PHY_TX_PWR"</span>,
<a name="l00554"></a>00554      <span class="stringliteral">"PHY_RSSI"</span>, <span class="stringliteral">"PHY_ED_LEVEL"</span>, <span class="stringliteral">"PHY_CC_CCA"</span>, <span class="stringliteral">"CCA_THRES"</span>, <span class="stringliteral">"IRQ_MASK"</span>,
<a name="l00555"></a>00555      <span class="stringliteral">"IRQ_STATUS"</span>, <span class="stringliteral">"VREG_CTRL"</span>, <span class="stringliteral">"BATMON"</span>, <span class="stringliteral">"XOSC_CTRL"</span>, <span class="stringliteral">"RX_SYN"</span>, <span class="stringliteral">"XAH_CTRL_1"</span>,
<a name="l00556"></a>00556      <span class="stringliteral">"FTN_CTRL"</span>, <span class="stringliteral">"PLL_CF"</span>, <span class="stringliteral">"PLL_DCU"</span>, <span class="stringliteral">"PART_NUM"</span>, <span class="stringliteral">"VERSION_NUM"</span>, <span class="stringliteral">"MAN_ID_0"</span>,
<a name="l00557"></a>00557      <span class="stringliteral">"MAN_ID_1"</span>, <span class="stringliteral">"SHORT_ADDR_0"</span>, <span class="stringliteral">"SHORT_ADDR_1"</span>, <span class="stringliteral">"PAN_ID_0"</span>, <span class="stringliteral">"PAN_ID_1"</span>,
<a name="l00558"></a>00558      <span class="stringliteral">"IEEE_ADDR_0"</span>, <span class="stringliteral">"IEEE_ADDR_1"</span>, <span class="stringliteral">"IEEE_ADDR_2"</span>, <span class="stringliteral">"IEEE_ADDR_3"</span>, <span class="stringliteral">"IEEE_ADDR_4"</span>,
<a name="l00559"></a>00559      <span class="stringliteral">"IEEE_ADDR_5"</span>, <span class="stringliteral">"IEEE_ADDR_6"</span>, <span class="stringliteral">"IEEE_ADDR_7"</span>, <span class="stringliteral">"XAH_CTRL_0"</span>, <span class="stringliteral">"CSMA_SEED_0"</span>,
<a name="l00560"></a>00560      <span class="stringliteral">"CSMA_SEED_1"</span>, <span class="stringliteral">"CSMA_BE"</span>};
<a name="l00561"></a>00561 
<a name="l00566"></a>00566 u8 rf2xxregenum[] =
<a name="l00567"></a>00567     {<a class="code" href="group__radio__registers.html#g3ef224e06f9b07c132b98daeb089f9ae" title="Offset for register TRX_STATUS.">RG_TRX_STATUS</a>, <a class="code" href="group__radio__registers.html#g9154e18a2399240c300da352be8c14c5" title="Offset for register TRX_STATE.">RG_TRX_STATE</a>, <a class="code" href="group__radio__registers.html#g5025f89755df39a2fdede980b2907eff" title="Offset for register TRX_CTRL_0.">RG_TRX_CTRL_0</a>, <a class="code" href="group__radio__registers.html#g1d1e66a62e8f748c93a2143ebc262d15" title="Offset for register TRX_CTRL_1.">RG_TRX_CTRL_1</a>, <a class="code" href="group__radio__registers.html#g102bbda4e4354e6c5d42d73a8202476d" title="Offset for register PHY_TX_PWR.">RG_PHY_TX_PWR</a>,
<a name="l00568"></a>00568      <a class="code" href="group__radio__registers.html#gd1d60be2e5a79f872e2da65ff35dd90a" title="Offset for register PHY_RSSI.">RG_PHY_RSSI</a>, <a class="code" href="group__radio__registers.html#g4caa8e52e3f9ad2217864df65fdfd501" title="Offset for register PHY_ED_LEVEL.">RG_PHY_ED_LEVEL</a>, <a class="code" href="group__radio__registers.html#g16019b8196d6eb4a2bbf28c3bfe9112d" title="Offset for register PHY_CC_CCA.">RG_PHY_CC_CCA</a>, <a class="code" href="group__radio__registers.html#g363aeed705736bd833f6c66e101c2e65" title="Offset for register CCA_THRES.">RG_CCA_THRES</a>, <a class="code" href="group__radio__registers.html#g905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>,
<a name="l00569"></a>00569      <a class="code" href="group__radio__registers.html#g7dec4b1e3d3bfd3e9f6c243abc4f008e" title="Offset for register IRQ_STATUS.">RG_IRQ_STATUS</a>, <a class="code" href="group__radio__registers.html#g5f8811938f2f1f073d35ff0a54ee830a" title="Offset for register VREG_CTRL.">RG_VREG_CTRL</a>, <a class="code" href="group__radio__registers.html#gb47fb56bf39aa80785b9c803ac68bdcd" title="Offset for register BATMON.">RG_BATMON</a>, <a class="code" href="group__radio__registers.html#gcc9cb84a4de2da69f74351048c08d5c5" title="Offset for register XOSC_CTRL.">RG_XOSC_CTRL</a>, <a class="code" href="group__radio__registers.html#gf72185a3c627bf76403dc38f3c356a26" title="Offset for register RX_SYN.">RG_RX_SYN</a>, <a class="code" href="group__radio__registers.html#ge9477feb3c263ec41f78b52c22ea863d" title="Offset for register XAH_CTRL_1.">RG_XAH_CTRL_1</a>,
<a name="l00570"></a>00570      <a class="code" href="group__radio__registers.html#g6e1e5bbc54be46b1bba0cf16868a9922" title="Offset for register FTN_CTRL.">RG_FTN_CTRL</a>, <a class="code" href="group__radio__registers.html#ga6916dc7c962c78af9a11fa86388c097" title="Offset for register PLL_CF.">RG_PLL_CF</a>, <a class="code" href="group__radio__registers.html#gcd8356b2e26de3de8ce5df0bc8ac52b6" title="Offset for register PLL_DCU.">RG_PLL_DCU</a>, <a class="code" href="group__radio__registers.html#g72ebcdb3490edf9a0af95c5feba492fc" title="Offset for register PART_NUM.">RG_PART_NUM</a>, <a class="code" href="group__radio__registers.html#gc1888aaec44899f2a3d7856b757533e8" title="Offset for register VERSION_NUM.">RG_VERSION_NUM</a>, <a class="code" href="group__radio__registers.html#g3514dae6641c832c5223c74151544f17" title="Offset for register MAN_ID_0.">RG_MAN_ID_0</a>,
<a name="l00571"></a>00571      <a class="code" href="group__radio__registers.html#g6c961f3a2c267656eb8d90c103ab96aa" title="Offset for register MAN_ID_1.">RG_MAN_ID_1</a>, <a class="code" href="group__radio__registers.html#g7eb78713946ea45d4b96dea4fdfd635b" title="Offset for register SHORT_ADDR_0.">RG_SHORT_ADDR_0</a>, <a class="code" href="group__radio__registers.html#ga60598fa1041cdf9caa245cc9fbd52cd" title="Offset for register SHORT_ADDR_1.">RG_SHORT_ADDR_1</a>, <a class="code" href="group__radio__registers.html#g7e9a100296620bd87365a5355e3ff28d" title="Offset for register PAN_ID_0.">RG_PAN_ID_0</a>, <a class="code" href="group__radio__registers.html#g30cf03f218f9c36554315f737abbedd5" title="Offset for register PAN_ID_1.">RG_PAN_ID_1</a>,
<a name="l00572"></a>00572      <a class="code" href="group__radio__registers.html#g15e749d4ff747c1066a644142088c354" title="Offset for register IEEE_ADDR_0.">RG_IEEE_ADDR_0</a>, <a class="code" href="group__radio__registers.html#g1446d842abbb6236c0cc6e81aa55afd5" title="Offset for register IEEE_ADDR_1.">RG_IEEE_ADDR_1</a>, <a class="code" href="group__radio__registers.html#gddc18e32ea6a4e7090d003a065325a07" title="Offset for register IEEE_ADDR_2.">RG_IEEE_ADDR_2</a>, <a class="code" href="group__radio__registers.html#g4363d1043e3ca7fd103c8671a7bb816c" title="Offset for register IEEE_ADDR_3.">RG_IEEE_ADDR_3</a>, <a class="code" href="group__radio__registers.html#g0af60fe759f1fb20a5fd1f1a6485ef55" title="Offset for register IEEE_ADDR_4.">RG_IEEE_ADDR_4</a>,
<a name="l00573"></a>00573      <a class="code" href="group__radio__registers.html#g51e16dcb63978ac7f2da04f1d22f64d5" title="Offset for register IEEE_ADDR_5.">RG_IEEE_ADDR_5</a>, <a class="code" href="group__radio__registers.html#g7a08fe5c18ce6b6aab8258e60437dbbd" title="Offset for register IEEE_ADDR_6.">RG_IEEE_ADDR_6</a>, <a class="code" href="group__radio__registers.html#gfc4833334492f3f1ca57d51f96a4a925" title="Offset for register IEEE_ADDR_7.">RG_IEEE_ADDR_7</a>, <a class="code" href="group__radio__registers.html#g965e63c5144865f3e88d85a714362e68" title="Offset for register XAH_CTRL.">RG_XAH_CTRL_0</a>, <a class="code" href="group__radio__registers.html#g0be03a19a6b1cf46a550cd0a5dc1b55b" title="Offset for register CSMA_SEED_0.">RG_CSMA_SEED_0</a>,
<a name="l00574"></a>00574      <a class="code" href="group__radio__registers.html#gd13c7575f9673b164a24725b3046afd3" title="Offset for register CSMA_SEED_1.">RG_CSMA_SEED_1</a>, <a class="code" href="group__radio__registers.html#g27a2452254bf5ec820d5f60254cc5c80" title="Offset for register CSMA_BE.">RG_CSMA_BE</a>};
<a name="l00575"></a>00575 
<a name="l00582"></a>00582 <span class="keywordtype">void</span> rf2xxregdump(<span class="keywordtype">void</span>)
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584     {
<a name="l00585"></a>00585         u8 i,j,k,val, x, z;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         fnDebugMsg(<span class="stringliteral">"\r\n\r\nREG DUMP\r\n"</span>);
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         k = <span class="keyword">sizeof</span>(rf2xxregenum);
<a name="l00590"></a>00590         <span class="keywordflow">for</span>(i=0;i&lt;k;i++)
<a name="l00591"></a>00591         {
<a name="l00592"></a>00592             val =  <a class="code" href="group__arm.html#gfd58b0cad5bbd45b1c4a8d30be4bc11c" title="This function reads data from one of the radio transceiver&amp;#39;s registers.">hal_register_read</a>(rf2xxregenum[i]);
<a name="l00593"></a>00593             fnDebugMsg((<span class="keywordtype">char</span> *)rf2xxregnames[i]);
<a name="l00594"></a>00594             x = 12 - strlen((<span class="keywordtype">char</span> *)rf2xxregnames[i] );
<a name="l00595"></a>00595             <span class="keywordflow">for</span>(z=0; z&lt;x; z++)
<a name="l00596"></a>00596             {
<a name="l00597"></a>00597                 fnDebugMsg(<span class="stringliteral">" "</span>);
<a name="l00598"></a>00598             }
<a name="l00599"></a>00599             fnDebugHex(val, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | <span class="keyword">sizeof</span>(val)));
<a name="l00600"></a>00600             fnDebugMsg(<span class="stringliteral">" "</span>);
<a name="l00601"></a>00601             <span class="keywordflow">for</span> (j=7;j&lt;8;j--)
<a name="l00602"></a>00602                 <span class="comment">// Print a bit</span>
<a name="l00603"></a>00603                 <span class="keywordflow">if</span>((val &gt;&gt; j) &amp; 1)
<a name="l00604"></a>00604                 fnDebugMsg(<span class="stringliteral">"1"</span>);
<a name="l00605"></a>00605                 <span class="keywordflow">else</span>
<a name="l00606"></a>00606                 fnDebugMsg(<span class="stringliteral">"0"</span>);
<a name="l00607"></a>00607             fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609         fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 }
<a name="l00613"></a>00613 
<a name="l00617"></a>00617 <span class="keywordtype">void</span> armAppInit(<span class="keywordtype">void</span>)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619     <span class="keyword">volatile</span> s8 val;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621     <span class="comment">// Open up a file for writing.</span>
<a name="l00622"></a>00622     val = file_fopen(&amp;sd_file, &amp;(efs.myFs), sd_filename, MODE_APPEND);
<a name="l00623"></a>00623     <span class="keywordflow">if</span>(val == -1)
<a name="l00624"></a>00624         fnDebugMsg(<span class="stringliteral">"\r\nfopen failed!\r\n"</span>);
<a name="l00625"></a>00625     <span class="keywordflow">else</span>
<a name="l00626"></a>00626     {
<a name="l00627"></a>00627         <span class="comment">// Create a directory.</span>
<a name="l00628"></a>00628         mkdir(&amp;(efs.myFs), <span class="stringliteral">"/data"</span>);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         <span class="comment">// concatenate the directory and name</span>
<a name="l00631"></a>00631         uStrcpy((CHAR *)sd_filename, <span class="stringliteral">"/data/log.txt"</span>);
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="comment">// Global to use in terminalArmAppTask in case a user enters a new ile name.</span>
<a name="l00635"></a>00635     files_sys_active = <span class="keyword">true</span>;
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 
<a name="l00644"></a>00644 <span class="keywordtype">void</span> armAppRcvData(<a class="code" href="structsftSensorReading.html" title="Sensor reading packet, sent by sensor node to report its data to the coordinator...">sftSensorReading</a> *frame)
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646     <span class="comment">// SD card is good if "1" returned. Error if "-1".</span>
<a name="l00647"></a>00647     <span class="keywordflow">if</span>((sd_State(&amp;(efs.myCard)) == 1) &amp;&amp; (files_sys_active))
<a name="l00648"></a>00648     {
<a name="l00649"></a>00649         file_fopen(&amp;sd_file, &amp;(efs.myFs), sd_filename, MODE_APPEND);
<a name="l00650"></a>00650         <span class="comment">// NULL terminate the string buffers.</span>
<a name="l00651"></a>00651         stored_data[0].c1 = <span class="charliteral">','</span>;
<a name="l00652"></a>00652         stored_data[0].c2 = <span class="charliteral">','</span>;
<a name="l00653"></a>00653         stored_data[0].c3 = <span class="charliteral">','</span>;
<a name="l00654"></a>00654         stored_data[0].c4 = <span class="charliteral">','</span>;
<a name="l00655"></a>00655         stored_data[0].c5 = <span class="charliteral">'\n'</span>;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657         fnDebugDec(frame-&gt;<a class="code" href="structsftSensorReading.html#419fdd9519cfd9f255f651c7c13b429c" title="Short address of node sending reading.">addr</a>, 0, (CHAR *)&amp;stored_data[0].addr);
<a name="l00658"></a>00658         strncpy((<span class="keywordtype">char</span> *)stored_data[0].reading, (<span class="keywordtype">char</span> *)frame-&gt;<a class="code" href="structsftSensorReading.html#6af0b41f38cd5f98a3a70676475cc0ba" title="Calculated sensor reading, as an ASCII string.">reading</a>, 6);
<a name="l00659"></a>00659         strncpy((<span class="keywordtype">char</span> *)stored_data[0].units, (<span class="keywordtype">char</span> *)frame-&gt;<a class="code" href="structsftSensorReading.html#ac5a59b80df839161a69a7dd341d290b" title="Units of sensor reading, as an ASCII string.">units</a>, 5);
<a name="l00660"></a>00660         strncpy((<span class="keywordtype">char</span> *)stored_data[0].name, (<span class="keywordtype">char</span> *)frame-&gt;<a class="code" href="structsftSensorReading.html#de3ea62dbae1b37c042d391ff49eb7c2" title="Name of sensor.">name</a>, 8);
<a name="l00661"></a>00661         <span class="comment">//strcpy((char *)stored_data[0].time, (char *)time);</span>
<a name="l00662"></a>00662         <span class="comment">//    data_i++;</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         file_write(&amp;sd_file, <span class="keyword">sizeof</span>(stored_readings_t), (euint8 *)stored_data);
<a name="l00665"></a>00665         file_fclose(&amp;sd_file);
<a name="l00666"></a>00666         fs_flushFs(&amp;(efs.myFs));
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668 }
<a name="l00669"></a>00669 
<a name="l00673"></a>00673 <span class="keywordtype">void</span> armCalReset(<span class="keywordtype">void</span>)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     fnDebugMsg(<span class="stringliteral">"\r\nCalibration timed out.\r\n"</span>);
<a name="l00676"></a>00676     telState = 0;
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00691"></a>00691 telType_t telState = 0;
<a name="l00692"></a>00692 <span class="keywordtype">int</span> fnHandleTelnetInput(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *telBuf, <span class="keywordtype">int</span> telBufLen, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> usTelnet_state)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694     <span class="keyword">static</span> u16 addr=0;
<a name="l00695"></a>00695     <span class="keyword">static</span> u16 channel;
<a name="l00696"></a>00696     <span class="keyword">static</span> <span class="keywordtype">char</span> str[102];
<a name="l00697"></a>00697     <span class="keyword">static</span> CHAR cBuf[16];
<a name="l00698"></a>00698     <span class="keyword">static</span> u8 timer_id;
<a name="l00699"></a>00699     CHAR new_rum_ip[15];
<a name="l00700"></a>00700 <span class="preprocessor">#if IPV6LOWPAN</span>
<a name="l00701"></a>00701 <span class="preprocessor"></span>    <span class="keywordtype">char</span> ipv6_addr[60]; <span class="comment">/* Store IPv6 Address: worst-case size */</span>
<a name="l00702"></a>00702 <span class="preprocessor">#endif // IPV6LOWPAN</span>
<a name="l00703"></a>00703 <span class="preprocessor"></span>
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#41e5b4ad93b57a3da564efa92e72a909" title="Is the mac busy? Used to protect mac_buffer_tx.">busy</a>)
<a name="l00705"></a>00705     {
<a name="l00706"></a>00706         <span class="comment">// try again when mac is not busy</span>
<a name="l00707"></a>00707         <span class="keywordflow">return</span> usTelnet_state;
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="comment">// We were in the middle of things and had to grab data from the user.</span>
<a name="l00711"></a>00711     <span class="comment">// Data is available to process now.</span>
<a name="l00712"></a>00712     <span class="keywordflow">if</span>(telState != 0)
<a name="l00713"></a>00713     {
<a name="l00714"></a>00714         <span class="keywordflow">switch</span>(telState)
<a name="l00715"></a>00715         {
<a name="l00716"></a>00716             <span class="keywordflow">case</span> TEL_FILE_NAME:
<a name="l00717"></a>00717                 memset(sd_filename, 0, 20);
<a name="l00718"></a>00718                 <span class="comment">// Always use the same directory.</span>
<a name="l00719"></a>00719                 uStrcpy((CHAR *)sd_filename, <span class="stringliteral">"/data/"</span>);
<a name="l00720"></a>00720                 <span class="comment">// A file name can be max 8.3 format</span>
<a name="l00721"></a>00721 
<a name="l00722"></a>00722                 <span class="comment">// The file system was closed in the initial call.</span>
<a name="l00723"></a>00723                 <span class="keywordflow">if</span>(!files_sys_active)
<a name="l00724"></a>00724                 {
<a name="l00725"></a>00725                   <span class="comment">// Has a char been received?</span>
<a name="l00726"></a>00726                   <span class="keywordflow">if</span>(telBufLen)
<a name="l00727"></a>00727                   {
<a name="l00728"></a>00728                       uMemcpy((CHAR *)&amp;sd_filename[6], telBuf, telBufLen);
<a name="l00729"></a>00729                   }
<a name="l00730"></a>00730                   <span class="comment">// Write the fle name.</span>
<a name="l00731"></a>00731                   uMemcpy((CHAR *)&amp;sd_filename[6+telBufLen], <span class="stringliteral">".txt"</span>, 4);
<a name="l00732"></a>00732                   efs_init(&amp;efs,0);
<a name="l00733"></a>00733                   file_fopen(&amp;sd_file, &amp;(efs.myFs), sd_filename, MODE_APPEND);
<a name="l00734"></a>00734                 }
<a name="l00735"></a>00735                 telState = 0;
<a name="l00736"></a>00736             <span class="keywordflow">break</span>;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738             <span class="keywordflow">case</span> TEL_PING_NODE:
<a name="l00739"></a>00739                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00740"></a>00740                 telBuf[telBufLen] = 0;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742                 addr = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00743"></a>00743                 <a class="code" href="group__mac__data.html#g7e4c5d07ec7a2622dabbcf51b1fe4ba9" title="Send a ping packet (either request or response) to another node.">macPing</a>(<a class="code" href="group__mac.html#g85ba6c45557eb0369e606452f9d902e6" title="Ping request frame.">PING_REQ_FRAME</a>, addr);
<a name="l00744"></a>00744                 telState = 0;
<a name="l00745"></a>00745             <span class="keywordflow">break</span>;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747             <span class="keywordflow">case</span> TEL_CHANNEL:
<a name="l00748"></a>00748                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00749"></a>00749                 telBuf[telBufLen] = 0;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751                 channel = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753                 <span class="comment">// Re-do the init stuff.</span>
<a name="l00754"></a>00754                 <a class="code" href="group__mac.html#gaa0748a32ee5741afc6a5078d92158bb" title="Init the mac, which includes initializing the radio chip.">macInit</a>(channel);
<a name="l00755"></a>00755                 <a class="code" href="group__mac.html#gd9b6aa9e3aa0f562f49354f26bbf56ba" title="This function will cause a device to become a PAN Coordinator.">macStartCoord</a>();
<a name="l00756"></a>00756                 fnDebugMsg(<span class="stringliteral">"\r\nNew channel selected.\r\n"</span>);
<a name="l00757"></a>00757                 <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b90d9d43eb3ae9d98e9cd556272bf464" title="Is this node associated with a network?">associated</a> = <span class="keyword">true</span>;
<a name="l00758"></a>00758                 telState = 0;
<a name="l00759"></a>00759             <span class="keywordflow">break</span>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="preprocessor">#if APP == SENSOR</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>            <span class="keywordflow">case</span> TEL_REQUEST_DATA_FROM_NODE:
<a name="l00763"></a>00763                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00764"></a>00764                 telBuf[telBufLen] = 0;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766                 addr = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00767"></a>00767                 u16 time;
<a name="l00768"></a>00768                 fnDebugMsg(<span class="stringliteral">"\r\nReport time (100mS intervals):"</span>);
<a name="l00769"></a>00769                 telState = TEL_REPORT_INTERVAL;
<a name="l00770"></a>00770             <span class="keywordflow">break</span>;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772             <span class="keywordflow">case</span> TEL_REPORT_INTERVAL:
<a name="l00773"></a>00773                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00774"></a>00774                 telBuf[telBufLen] = 0;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776                 time = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00777"></a>00777                 <a class="code" href="group__sensors.html#g32bb0a72bd1635959ac4397db317edae" title="Request a reading from a sensor node.">sensorRequestReading</a>(addr, time);
<a name="l00778"></a>00778                 telState = 0;
<a name="l00779"></a>00779             <span class="keywordflow">break</span>;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781             <span class="keywordflow">case</span> TEL_CAL_WHICH_NODE:
<a name="l00782"></a>00782                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00783"></a>00783                 telBuf[telBufLen] = 0;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785                 addr = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00786"></a>00786 
<a name="l00787"></a>00787                 <span class="comment">// Get cal info from node</span>
<a name="l00788"></a>00788                 <a class="code" href="group__sensors.html#g7be640146ea956f71c4540c1b247567c" title="Request an end node to send its calibration information.">sensorRequestCalInfo</a>(addr);
<a name="l00789"></a>00789 
<a name="l00790"></a>00790                 fnDebugMsg(<span class="stringliteral">"\r\nEnter Cal point 1:"</span>);
<a name="l00791"></a>00791                 telState = TEL_CAL_POINT_1;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793                 <span class="comment">// Set a time out.</span>
<a name="l00794"></a>00794                 timer_id = <a class="code" href="group__timer__module.html#g0155e5192956b3cd498751d8652f7773" title="Sets a general purpose timer.">macSetAlarm</a>(5000, armCalReset);
<a name="l00795"></a>00795             <span class="keywordflow">break</span>;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797             <span class="keywordflow">case</span> TEL_CAL_POINT_1:
<a name="l00798"></a>00798                 telBuf[telBufLen] = 0;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800                 <a class="code" href="group__timer__module.html#g424100b5b43a9d709cec3d509ef6f48c" title="End the timer specified by ID, before it is expired.">macTimerEnd</a>(timer_id);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802                 sensorSendCalPoint(0, (<span class="keywordtype">char</span> *)telBuf);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804                 <span class="keywordflow">if</span>(coordCalInfo-&gt;<a class="code" href="structsftCalInfo.html#7fb5c56a7ea6fb1ab552145d556b76cf" title="Calibration type, 1=1point, 2=2point.">calType</a> == 2)
<a name="l00805"></a>00805                 {
<a name="l00806"></a>00806                   fnDebugMsg(<span class="stringliteral">"\r\nEnter Cal point 2:"</span>);
<a name="l00807"></a>00807                   telState = TEL_CAL_POINT_2;
<a name="l00808"></a>00808                 }
<a name="l00809"></a>00809                 <span class="keywordflow">else</span>
<a name="l00810"></a>00810                   telState = 0;
<a name="l00811"></a>00811             <span class="keywordflow">break</span>;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813             <span class="keywordflow">case</span> TEL_CAL_POINT_2:
<a name="l00814"></a>00814                 telBuf[telBufLen] = 0;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816                 sensorSendCalPoint(1, (<span class="keywordtype">char</span> *)telBuf);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818                 telState = 0;
<a name="l00819"></a>00819             <span class="keywordflow">break</span>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821             <span class="keywordflow">case</span> TEL_NAME_WHICH_NODE:
<a name="l00822"></a>00822                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00823"></a>00823                 telBuf[telBufLen] = 0;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825                 addr = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00826"></a>00826                 fnDebugMsg(<span class="stringliteral">"\r\nEnter name:"</span>);
<a name="l00827"></a>00827 
<a name="l00828"></a>00828                 telState = TEL_NEW_NODE_NAME;
<a name="l00829"></a>00829             <span class="keywordflow">break</span>;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831             <span class="keywordflow">case</span> TEL_NEW_NODE_NAME:
<a name="l00832"></a>00832                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00833"></a>00833                 telBuf[telBufLen] = 0;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835                 <a class="code" href="group__sensors.html#g0717b6140ef26cb1daa46ac31113f034" title="Set the name of the sensor name.">sensorSendSetNodeName</a>(addr, (<span class="keywordtype">char</span> *)telBuf);
<a name="l00836"></a>00836                 telState = 0;
<a name="l00837"></a>00837             <span class="keywordflow">break</span>;
<a name="l00838"></a>00838 <span class="preprocessor">#endif // APP == SENSOR</span>
<a name="l00839"></a>00839 <span class="preprocessor"></span>
<a name="l00840"></a>00840             <span class="keywordflow">case</span> TEL_WAKE_NODE:
<a name="l00841"></a>00841                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00842"></a>00842                 telBuf[telBufLen] = 0;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844                 addr = atoi((<span class="keywordtype">char</span> *)telBuf);
<a name="l00845"></a>00845                 <a class="code" href="group__mac__associate.html#g243906ca038a1601687f0aa66aa63973" title="Set a child node&amp;#39;s entry to be woken up.">macWakeChildNode</a>(addr);
<a name="l00846"></a>00846                 telState = 0;
<a name="l00847"></a>00847             <span class="keywordflow">break</span>;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849             <span class="keywordflow">case</span> TEL_NEW_IP:
<a name="l00850"></a>00850                 <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00851"></a>00851                 telBuf[telBufLen] = 0;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853                 uMemset(new_rum_ip, 0, 15);
<a name="l00854"></a>00854                 uMemcpy(new_rum_ip, telBuf, telBufLen);
<a name="l00855"></a>00855 
<a name="l00860"></a>00860                 fnStrIP(new_rum_ip, &amp;network.ucOurIP[0]);   <span class="comment">// set new address for immediate use</span>
<a name="l00861"></a>00861                 fnDeleteArp();  <span class="comment">// delete all ARP entries since they may no longer be valid</span>
<a name="l00862"></a>00862                 uMemcpy(&amp;temp_pars-&gt;temp_network.ucOurIP[0], &amp;network.ucOurIP[0], IPV4_LENGTH); <span class="comment">// copy also to temp parameters since these are the ones saved by next command</span>
<a name="l00863"></a>00863                 fnSaveNewPars(SAVE_NEW_PARAMETERS); <span class="comment">// save these to FLASH with immediate validity</span>
<a name="l00864"></a>00864 
<a name="l00865"></a>00865                 telState = 0;
<a name="l00866"></a>00866             <span class="keywordflow">break</span>;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868             <span class="keywordflow">case</span> TEL_TOUCH:
<a name="l00869"></a>00869                         <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00870"></a>00870                 telBuf[telBufLen] = 0;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                 <span class="comment">// Do the function</span>
<a name="l00873"></a>00873                 <span class="keywordflow">if</span> (telBuf[0] == <span class="charliteral">'p'</span>)
<a name="l00874"></a>00874                 {
<a name="l00875"></a>00875                     <a class="code" href="group__app.html#g294a39a42680ce725580f509c3ab692e" title="When called, this will either Ping or request data from all associated nodes.">allNodes</a>(PING_ALL,0);
<a name="l00876"></a>00876                     telState = 0;
<a name="l00877"></a>00877                 }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879                 <span class="keywordflow">if</span> (telBuf[0] == <span class="charliteral">'r'</span> &amp;&amp; APP == <a class="code" href="group__app.html#g84f1ead330bbcc83a63929c4726080d7" title="Macro to define the sensor application.">SENSOR</a>)
<a name="l00880"></a>00880                 {
<a name="l00881"></a>00881                     fnDebugMsg(<span class="stringliteral">"\r\nReport time (100mS intervals):"</span>);
<a name="l00882"></a>00882                     telState = TEL_TOUCH_INTERVAL;
<a name="l00883"></a>00883                 }
<a name="l00884"></a>00884             <span class="keywordflow">break</span>;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886             <span class="keywordflow">case</span> TEL_TOUCH_INTERVAL:
<a name="l00887"></a>00887               <span class="comment">// The last element in the buffer should be a CR, remove it.</span>
<a name="l00888"></a>00888               telBuf[telBufLen] = 0;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890               <a class="code" href="group__app.html#g294a39a42680ce725580f509c3ab692e" title="When called, this will either Ping or request data from all associated nodes.">allNodes</a>(<a class="code" href="group__sensors.html#gaae5f0c0221a794b41194ff6eede970b" title="Support for changing all node&amp;#39;s interval response time.">REPORT_ALL</a>, atoi((<span class="keywordtype">char</span> *)telBuf));
<a name="l00891"></a>00891 
<a name="l00892"></a>00892               telState = 0;
<a name="l00893"></a>00893             <span class="keywordflow">break</span>;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895             <span class="keywordflow">default</span>:
<a name="l00896"></a>00896             <span class="keywordflow">break</span>;
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898     }
<a name="l00899"></a>00899     <span class="keywordflow">else</span>
<a name="l00900"></a>00900     {
<a name="l00901"></a>00901         fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00902"></a>00902         <span class="keywordflow">switch</span> (telBuf[0])
<a name="l00903"></a>00903         {
<a name="l00904"></a>00904             <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:
<a name="l00905"></a>00905                 <span class="comment">// Toggle reading print out.</span>
<a name="l00906"></a>00906                 telPrintReading ^= 1;
<a name="l00907"></a>00907             <span class="keywordflow">break</span>;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909             <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
<a name="l00910"></a>00910                 <span class="comment">// reg dump</span>
<a name="l00911"></a>00911                 rf2xxregdump();
<a name="l00912"></a>00912                 <span class="keywordflow">break</span>;
<a name="l00913"></a>00913             <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
<a name="l00914"></a>00914                 <span class="comment">// Turn on data file recording to SD card.</span>
<a name="l00915"></a>00915                 <span class="comment">// Close up the file sys if there is a card.</span>
<a name="l00916"></a>00916 
<a name="l00917"></a>00917                 <span class="keywordflow">if</span>((sd_State(&amp;(efs.myCard)) != 1))
<a name="l00918"></a>00918                 {
<a name="l00919"></a>00919                     fnDebugMsg(<span class="stringliteral">"\r\nSD card not installed!\r\n"</span>);
<a name="l00920"></a>00920                     <span class="keywordflow">break</span>;
<a name="l00921"></a>00921                 }
<a name="l00922"></a>00922                 files_sys_active = <span class="keyword">false</span>;
<a name="l00923"></a>00923                 file_fclose(&amp;sd_file);
<a name="l00924"></a>00924                 fs_flushFs(&amp;(efs.myFs));
<a name="l00925"></a>00925 
<a name="l00926"></a>00926                 fnDebugMsg(<span class="stringliteral">"\r\nEnter a file name (8 characters max): "</span>);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928                 <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l00929"></a>00929                 telState = TEL_FILE_NAME;
<a name="l00930"></a>00930             <span class="keywordflow">break</span>;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932             <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
<a name="l00933"></a>00933                 <span class="keywordflow">if</span>((sd_State(&amp;(efs.myCard)) != 1))
<a name="l00934"></a>00934                 {
<a name="l00935"></a>00935                     fnDebugMsg(<span class="stringliteral">"\r\n SD card not installed!\r\n"</span>);
<a name="l00936"></a>00936                     <span class="keywordflow">break</span>;
<a name="l00937"></a>00937                 }
<a name="l00938"></a>00938                 <span class="comment">// Stop logging data to file.</span>
<a name="l00939"></a>00939                 files_sys_active = <span class="keyword">false</span>;
<a name="l00940"></a>00940                 file_fclose(&amp;sd_file);
<a name="l00941"></a>00941                 fs_flushFs(&amp;(efs.myFs));
<a name="l00942"></a>00942             <span class="keywordflow">break</span>;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944             <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
<a name="l00945"></a>00945                 <span class="comment">// Start logging data to file.</span>
<a name="l00946"></a>00946                 <span class="keywordflow">if</span>(efs_init(&amp;efs,0)!=0)
<a name="l00947"></a>00947                 {
<a name="l00948"></a>00948                         fnDebugMsg(<span class="stringliteral">"No SD Card!!\r\n"</span>);
<a name="l00949"></a>00949                         <span class="keywordflow">break</span>;
<a name="l00950"></a>00950                 }
<a name="l00951"></a>00951                 file_fopen(&amp;sd_file, &amp;(efs.myFs), sd_filename, MODE_APPEND);
<a name="l00952"></a>00952                 files_sys_active = <span class="keyword">true</span>;
<a name="l00953"></a>00953             <span class="keywordflow">break</span>;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
<a name="l00956"></a>00956                 <span class="comment">// print table</span>
<a name="l00957"></a>00957                 arm_macPrintTree();
<a name="l00958"></a>00958             <span class="keywordflow">break</span>;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960             <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
<a name="l00961"></a>00961                       <span class="comment">// Do something to all nodes</span>
<a name="l00962"></a>00962                 fnDebugMsg(<span class="stringliteral">"\r\nAll nodes - (r)eading, (p)ping:"</span>);
<a name="l00963"></a>00963                         telState = TEL_TOUCH;
<a name="l00964"></a>00964             <span class="keywordflow">break</span>;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966             <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
<a name="l00967"></a>00967               <span class="comment">// Get new IP address.</span>
<a name="l00968"></a>00968               fnDebugMsg(<span class="stringliteral">"\r\nNew IP = "</span>);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970               <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l00971"></a>00971                telState = TEL_NEW_IP;
<a name="l00972"></a>00972             <span class="keywordflow">break</span>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974             <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
<a name="l00975"></a>00975                 <span class="comment">// print info</span>
<a name="l00976"></a>00976                 fnDebugMsg(<span class="stringliteral">"\r\nshort ="</span>);
<a name="l00977"></a>00977                 fnDebugHex(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | <span class="keyword">sizeof</span>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#410a3539e6e06a2192ef87dfe7ae7424" title="The short address for this node.">shortAddress</a>)));
<a name="l00978"></a>00978                 fnDebugMsg(<span class="stringliteral">"\r\nparent ="</span>);
<a name="l00979"></a>00979                 fnDebugHex(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a>, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | <span class="keyword">sizeof</span>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#8746018dfd92c5ea8b5dcd12e89dd767" title="The short address of the parent&amp;#39;s node.">parentShortAddress</a>)));
<a name="l00980"></a>00980                 fnDebugMsg(<span class="stringliteral">"\r\nroute="</span>);
<a name="l00981"></a>00981                 fnDebugHex(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a>, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | <span class="keyword">sizeof</span>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#ec94dfe288c1f08ea35cdfb34cc518a0" title="Last address we sent a routed packet to.">lastRoute</a>)));
<a name="l00982"></a>00982                 fnDebugMsg(<span class="stringliteral">"\r\nchannel = "</span>);
<a name="l00983"></a>00983                 fnDebugDec(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b18607f3692130bb3da0510749eaeb78" title="The channel number this node is operating on.">currentChannel</a>, 0, 0);
<a name="l00984"></a>00984                 fnDebugMsg(<span class="stringliteral">"\r\nPAN ID ="</span>);
<a name="l00985"></a>00985                 fnDebugHex(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | <span class="keyword">sizeof</span>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#0661aa4bcc924815144446db68168a1f" title="The PAN ID for the network this node is associated with.">panId</a>)));
<a name="l00986"></a>00986                 u32 low = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#7d51df5f7f61e72d42e006e9ca6cf8ce" title="Long (MAC) address of this node.">longAddr</a>;
<a name="l00987"></a>00987                 u32 high = <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#7d51df5f7f61e72d42e006e9ca6cf8ce" title="Long (MAC) address of this node.">longAddr</a> &gt;&gt; 32;
<a name="l00988"></a>00988                 fnDebugMsg(<span class="stringliteral">"\r\nlong ="</span>);
<a name="l00989"></a>00989                 fnDebugHex(high, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 4));
<a name="l00990"></a>00990                 fnDebugHex(low, (CODE_CAPITALS | 4));
<a name="l00991"></a>00991                 <span class="keywordflow">if</span>(<a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b90d9d43eb3ae9d98e9cd556272bf464" title="Is this node associated with a network?">associated</a>)
<a name="l00992"></a>00992                     fnDebugMsg(<span class="stringliteral">"\r\nassoc = true"</span>);
<a name="l00993"></a>00993                 <span class="keywordflow">else</span>
<a name="l00994"></a>00994                     fnDebugMsg(<span class="stringliteral">"\r\nassoc = false"</span>);
<a name="l00995"></a>00995                 fnDebugMsg(<span class="stringliteral">"\r\nrand ="</span>);
<a name="l00996"></a>00996                 u8 rnum = <a class="code" href="group__radio.html#g301044554e9d047bf22935d01c615884" title="Returns a random number, composed of bits from the radio&amp;#39;s random number generator...">radioRandom</a>(8);
<a name="l00997"></a>00997                 fnDebugHex(rnum, (WITH_SPACE | WITH_LEADIN | CODE_CAPITALS | 1));
<a name="l00998"></a>00998                 fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l00999"></a>00999                 <span class="comment">// Radio part number</span>
<a name="l01000"></a>01000                 u16 pn = <a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>();
<a name="l01001"></a>01001                 <span class="keywordflow">switch</span> (pn)
<a name="l01002"></a>01002                 {
<a name="l01003"></a>01003                   <span class="keywordflow">case</span> <a class="code" href="group__radio__registers.html#g4f0b9bf26fdc64cc5e6c640871b050e4" title="Value for AT86RF230.">RF230</a>:
<a name="l01004"></a>01004                       pn = 230;
<a name="l01005"></a>01005                       <span class="keywordflow">break</span>;
<a name="l01006"></a>01006                   <span class="keywordflow">case</span> <a class="code" href="group__radio__registers.html#g5de4d4c246844ae9e84c535b3dc19dde" title="Value for AT86RF231.">RF231</a>:
<a name="l01007"></a>01007                       pn = 231;
<a name="l01008"></a>01008                       <span class="keywordflow">break</span>;
<a name="l01009"></a>01009                   <span class="keywordflow">case</span> <a class="code" href="group__radio__registers.html#ge7fc76de2ff765e0a0ee7273e2f3ec45" title="Value for AT86RF212.">RF212</a>:
<a name="l01010"></a>01010                       pn = 212;
<a name="l01011"></a>01011                       <span class="keywordflow">break</span>;
<a name="l01012"></a>01012                   <span class="keywordflow">default</span>:
<a name="l01013"></a>01013                       <span class="comment">// Just report whatever number the radio chip gives.</span>
<a name="l01014"></a>01014                       <span class="keywordflow">break</span>;
<a name="l01015"></a>01015                 }
<a name="l01016"></a>01016                 fnDebugMsg(<span class="stringliteral">"part = RF"</span>);
<a name="l01017"></a>01017                 fnDebugDec(pn, 0, 0);
<a name="l01018"></a>01018                 fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l01019"></a>01019                 u8 radnum = <a class="code" href="group__arm.html#gfd58b0cad5bbd45b1c4a8d30be4bc11c" title="This function reads data from one of the radio transceiver&amp;#39;s registers.">hal_register_read</a>(<a class="code" href="group__radio__registers.html#gc1888aaec44899f2a3d7856b757533e8" title="Offset for register VERSION_NUM.">RG_VERSION_NUM</a>);
<a name="l01020"></a>01020                 fnDebugMsg(<span class="stringliteral">"version = "</span>);
<a name="l01021"></a>01021                 fnDebugDec(radnum, 0, 0);
<a name="l01022"></a>01022                 fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l01023"></a>01023                 <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a> &amp;&amp; APP == <a class="code" href="group__app.html#g84f1ead330bbcc83a63929c4726080d7" title="Macro to define the sensor application.">SENSOR</a>)
<a name="l01024"></a>01024                 {
<a name="l01025"></a>01025                     fnDebugMsg(<span class="stringliteral">"Name= "</span>);
<a name="l01026"></a>01026                     fnDebugMsg(<a class="code" href="group__sensors.html#g4320310b6bca7d1d72e8e3abc56bc348" title="Returns a pointer to the name of this node.">sensorGetName</a>());
<a name="l01027"></a>01027                     fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l01028"></a>01028                 }
<a name="l01029"></a>01029             <span class="keywordflow">break</span>;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031             <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
<a name="l01032"></a>01032                 <span class="comment">// ping</span>
<a name="l01033"></a>01033                 memset(str, 0, 102);
<a name="l01034"></a>01034                 fnDebugMsg(<span class="stringliteral">"\r\nEnter short addr: "</span>);
<a name="l01035"></a>01035 
<a name="l01036"></a>01036                 <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l01037"></a>01037                 telState = TEL_PING_NODE;
<a name="l01038"></a>01038             <span class="keywordflow">break</span>;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040             <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
<a name="l01041"></a>01041                 <span class="comment">// change coordinator channel</span>
<a name="l01042"></a>01042                 fnDebugMsg(<span class="stringliteral">"\r\nEnter new chan: "</span>);
<a name="l01043"></a>01043 
<a name="l01044"></a>01044                 <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l01045"></a>01045                 telState = TEL_CHANNEL;
<a name="l01046"></a>01046               <span class="keywordflow">break</span>;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048 <span class="preprocessor">#if APP == SENSOR</span>
<a name="l01049"></a>01049 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
<a name="l01050"></a>01050                 <span class="comment">// get address and time</span>
<a name="l01051"></a>01051                 fnDebugMsg(<span class="stringliteral">"\r\nRequest data from node: "</span>);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053                 <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l01054"></a>01054                 telState = TEL_REQUEST_DATA_FROM_NODE;
<a name="l01055"></a>01055             <span class="keywordflow">break</span>;
<a name="l01056"></a>01056 
<a name="l01057"></a>01057             <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
<a name="l01058"></a>01058                 <span class="comment">// calibrate an end node</span>
<a name="l01059"></a>01059                 <span class="comment">// get address of node</span>
<a name="l01060"></a>01060                 fnDebugMsg(<span class="stringliteral">"\r\nCal which node: "</span>);
<a name="l01061"></a>01061 
<a name="l01062"></a>01062                 <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l01063"></a>01063                 telState = TEL_CAL_WHICH_NODE;
<a name="l01064"></a>01064             <span class="keywordflow">break</span>;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066             <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
<a name="l01067"></a>01067                 <span class="comment">// Name a node</span>
<a name="l01068"></a>01068                 fnDebugMsg(<span class="stringliteral">"\r\nName which node: "</span>);
<a name="l01069"></a>01069                 <span class="comment">// We have to leave and let the user enter data via the telnet session.</span>
<a name="l01070"></a>01070                 telState = TEL_NAME_WHICH_NODE;
<a name="l01071"></a>01071             <span class="keywordflow">break</span>;
<a name="l01072"></a>01072 <span class="preprocessor">#endif // APP == SENSOR</span>
<a name="l01073"></a>01073 <span class="preprocessor"></span>
<a name="l01074"></a>01074             <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:
<a name="l01075"></a>01075                 <span class="comment">// wake an end node</span>
<a name="l01076"></a>01076                 fnDebugMsg(<span class="stringliteral">"\r\nWake which node: "</span>);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078                 telState = TEL_WAKE_NODE;
<a name="l01079"></a>01079             <span class="keywordflow">break</span>;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081             <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
<a name="l01082"></a>01082                 <span class="comment">// Print out our IP address.</span>
<a name="l01083"></a>01083                 fnDebugMsg(<span class="stringliteral">"IP address = "</span>);
<a name="l01084"></a>01084                 fnIPStr(&amp;network.ucOurIP[0], cBuf);
<a name="l01085"></a>01085                 fnDebugMsg(cBuf);
<a name="l01086"></a>01086             <span class="keywordflow">break</span>;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 <span class="preprocessor">#if IPV6LOWPAN</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
<a name="l01090"></a>01090                 <span class="comment">// Print out the IPv6 addr info.</span>
<a name="l01091"></a>01091                 <span class="keywordflow">if</span>(uip_netif_physical_if[INTERFACE_ETHERNET].addresses[1].state != NOT_USED)
<a name="l01092"></a>01092                 {
<a name="l01093"></a>01093                     sprint_ip(ipv6_addr, uip_netif_physical_if[INTERFACE_ETHERNET].addresses[1].ipaddr.u16);
<a name="l01094"></a>01094                     fnDebugMsg(<span class="stringliteral">"\r\nIPv6 Ethernet IF = "</span>);
<a name="l01095"></a>01095                     fnDebugMsg(ipv6_addr);
<a name="l01096"></a>01096                     fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l01097"></a>01097                     sprint_ip(ipv6_addr, uip_netif_physical_if[INTERFACE_802154].addresses[1].ipaddr.u16);
<a name="l01098"></a>01098                     fnDebugMsg(<span class="stringliteral">"IPv6 6LoWPAN IF = "</span>);
<a name="l01099"></a>01099                     fnDebugMsg(ipv6_addr);
<a name="l01100"></a>01100                     fnDebugMsg(<span class="stringliteral">"\r\n"</span>);
<a name="l01101"></a>01101                 }
<a name="l01102"></a>01102                 <span class="keywordflow">else</span>
<a name="l01103"></a>01103                     fnDebugMsg(<span class="stringliteral">"\r\nNo IPv6 Addresses Acquired\r\n"</span>);
<a name="l01104"></a>01104             <span class="keywordflow">break</span>;
<a name="l01105"></a>01105 <span class="preprocessor">#endif // IPV6LOWPAN</span>
<a name="l01106"></a>01106 <span class="preprocessor"></span>
<a name="l01107"></a>01107             <span class="keywordflow">case</span> <span class="charliteral">'Q'</span>:
<a name="l01108"></a>01108                 <span class="keywordflow">if</span>(usTelnet_state == ES_NETWORK_COMMAND_MODE)
<a name="l01109"></a>01109                 {
<a name="l01110"></a>01110                     fnDebugMsg(<span class="stringliteral">"\n\rBye Bye\n\r"</span>);
<a name="l01111"></a>01111                     usTelnet_state = ES_TERMINATE_CONNECTION;                  <span class="comment">// now quit the Telnet session</span>
<a name="l01112"></a>01112                     <span class="keywordflow">return</span> usTelnet_state;
<a name="l01113"></a>01113                 }
<a name="l01114"></a>01114             <span class="keywordflow">break</span>;
<a name="l01115"></a>01115             <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
<a name="l01116"></a>01116                 <span class="comment">// Crank up transmit power to ~3dB</span>
<a name="l01117"></a>01117                 <a class="code" href="group__radio.html#g304d72041bb3ee614ac9e5dd0f9cd2bc" title="This function will change the output power level.">radioSetTxPowerLevel</a>(TX_PWR_3DBM);
<a name="l01118"></a>01118                 <span class="keywordflow">break</span>;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120             <span class="keywordflow">default</span>:
<a name="l01121"></a>01121             <span class="keywordflow">break</span>;
<a name="l01122"></a>01122         }
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">// Delay a bit to allow for other messages (ping resp) to print.</span>
<a name="l01126"></a>01126     <span class="keywordflow">if</span>(!telState)
<a name="l01127"></a>01127         <a class="code" href="group__timer__module.html#g0155e5192956b3cd498751d8652f7773" title="Sets a general purpose timer.">macSetAlarm</a>(250,<a class="code" href="group__app.html#g2dbe1cf2d8881afe92c984d67cbf8656" title="Print prompts for debug mode.">printPrompt</a>);
<a name="l01128"></a>01128     <span class="comment">// Clear the buffer.</span>
<a name="l01129"></a>01129     uMemset(telBuf, 0, 32);
<a name="l01130"></a>01130 
<a name="l01131"></a>01131     <span class="keywordflow">return</span> usTelnet_state;
<a name="l01132"></a>01132 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jun 8 18:38:19 2009 for RUM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
