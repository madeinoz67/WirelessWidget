<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>RUM: rum_src/radio.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>rum_src/radio.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) 2008  ATMEL Corporation</span>
<a name="l00002"></a>00002 <span class="comment">   All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">   Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment">   modification, are permitted provided that the following conditions are met:</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">   * Redistributions of source code must retain the above copyright</span>
<a name="l00008"></a>00008 <span class="comment">     notice, this list of conditions and the following disclaimer.</span>
<a name="l00009"></a>00009 <span class="comment">   * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00010"></a>00010 <span class="comment">     notice, this list of conditions and the following disclaimer in</span>
<a name="l00011"></a>00011 <span class="comment">     the documentation and/or other materials provided with the</span>
<a name="l00012"></a>00012 <span class="comment">     distribution.</span>
<a name="l00013"></a>00013 <span class="comment">   * Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment">     contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment">     from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span>
<a name="l00018"></a>00018 <span class="comment">  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00019"></a>00019 <span class="comment">  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00020"></a>00020 <span class="comment">  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="l00021"></a>00021 <span class="comment">  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00022"></a>00022 <span class="comment">  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00023"></a>00023 <span class="comment">  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00024"></a>00024 <span class="comment">  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00025"></a>00025 <span class="comment">  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00026"></a>00026 <span class="comment">  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00027"></a>00027 <span class="comment">  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00028"></a>00028 <span class="comment">*/</span>
<a name="l00029"></a>00029 <span class="comment">/*</span>
<a name="l00030"></a>00030 <span class="comment">  $Id: radio.c,v 1.5.4.4 2009/06/05 23:31:44 mvidales Exp $</span>
<a name="l00031"></a>00031 <span class="comment">*/</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">/*============================ INCLUDE =======================================*/</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "mac.h"</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "radio.h"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "mac_event.h"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "mac_scan.h"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "system.h"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "hal.h"</span>
<a name="l00042"></a>00042 
<a name="l00058"></a>00058 <span class="comment">/*============================ TYPEDEFS ======================================*/</span>
<a name="l00059"></a>00059 
<a name="l00065"></a><a class="code" href="group__radio.html#g7107f1e1a5e3b33325b5f7a489edb08d">00065</a> <span class="keyword">typedef</span> <span class="keyword">enum</span>{
<a name="l00066"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db843ffee3072fd1cb0582955224b6764">00066</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db843ffee3072fd1cb0582955224b6764" title="Transition time from VCC is applied to P_ON.">TIME_TO_ENTER_P_ON</a>               = 510, 
<a name="l00067"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db9de5983d25a9b788432f79eeebbda1f">00067</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db9de5983d25a9b788432f79eeebbda1f" title="Transition time from P_ON to TRX_OFF.">TIME_P_ON_TO_TRX_OFF</a>             = 510, 
<a name="l00068"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d7067e6c59db93ac323c375140eff1c51">00068</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d7067e6c59db93ac323c375140eff1c51" title="Transition time from SLEEP to TRX_OFF.">TIME_SLEEP_TO_TRX_OFF</a>            = 880, 
<a name="l00069"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d7987806807cc7ffc8afcafe42665af0f">00069</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d7987806807cc7ffc8afcafe42665af0f" title="Time to hold the RST pin low during reset.">TIME_RESET</a>                       = 6,   
<a name="l00070"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08dcd603365652239fc2d4cef5c4f2dcf23">00070</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08dcd603365652239fc2d4cef5c4f2dcf23" title="Time it takes to do a ED measurement.">TIME_ED_MEASUREMENT</a>              = 140, 
<a name="l00071"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d40b984895797d7656266f48b724f2206">00071</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d40b984895797d7656266f48b724f2206" title="Time it takes to do a CCA.">TIME_CCA</a>                         = 140, 
<a name="l00072"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08de5b568fca41fce82055b00269565b7ef">00072</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08de5b568fca41fce82055b00269565b7ef" title="Maximum time it should take for the PLL to lock.">TIME_PLL_LOCK</a>                    = 150, 
<a name="l00073"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08dcbada1dc573b954bad0184f6b111c02b">00073</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08dcbada1dc573b954bad0184f6b111c02b" title="Maximum time it should take to do the filter tuning.">TIME_FTN_TUNING</a>                  = 25,  
<a name="l00074"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d60b95807cc5d2690b9ee459c861c6a6c">00074</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d60b95807cc5d2690b9ee459c861c6a6c" title="Transition time from *_NOCLK to being awake.">TIME_NOCLK_TO_WAKE</a>               = 6,   
<a name="l00075"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08df50b81813c269484256d8d02b3751b4f">00075</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08df50b81813c269484256d8d02b3751b4f" title="Time it takes to execute the FORCE_TRX_OFF command.">TIME_CMD_FORCE_TRX_OFF</a>           = 1,   
<a name="l00076"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db69e9ed03883d6e427ea2027fb3daf13">00076</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db69e9ed03883d6e427ea2027fb3daf13" title="Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON.">TIME_TRX_OFF_TO_PLL_ACTIVE</a>       = 180, 
<a name="l00077"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08da68a9b1ecf13ab8095e32d86d35d416b">00077</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08da68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a> = 1,   
<a name="l00078"></a><a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d9fcebaaad9f84d4af5895d4f1821a270">00078</a>     <a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d9fcebaaad9f84d4af5895d4f1821a270" title="Transition time from RESET to TRX_OFF.">TIME_RESET_TRX_OFF</a>               = 37,  
<a name="l00079"></a>00079 }<a class="code" href="group__radio.html#g7107f1e1a5e3b33325b5f7a489edb08d" title="This enumeration defines the necessary timing information for the AT86RF230 radio...">radio_trx_timing_t</a>;
<a name="l00080"></a>00080 <span class="comment">/*============================ VARIABLES =====================================*/</span>
<a name="l00081"></a><a class="code" href="group__radio.html#gcd592f1b54f0dfee5cfb5333693e17dc">00081</a> u8 <a class="code" href="group__arm.html#gcd592f1b54f0dfee5cfb5333693e17dc" title="Flag: are we in RX mode?">rx_mode</a>;         
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="keyword">static</span> u8 rssi_val;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/*============================ PROTOTYPES ====================================*/</span>
<a name="l00086"></a>00086 <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>(<span class="keywordtype">void</span>);
<a name="l00087"></a>00087 <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g828f6014dc84586176b1d8934e7bd5dd" title="Callback function, called when the radio receives an RX_START interrupt.">radioRxStartEvent</a>(u8 <span class="keyword">const</span> <a class="code" href="group__arm.html#ga3a07afe7144b962b3ed8bb0cbc0b892" title="This is the radio ISR handler.">frame_length</a>);
<a name="l00088"></a>00088 <span class="keywordtype">void</span> radioTrxend_event(<span class="keywordtype">void</span>);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 
<a name="l00124"></a><a class="code" href="group__radio.html#g8382b61a38d3757b316352ddbe2b144b">00124</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g8382b61a38d3757b316352ddbe2b144b" title="Initialize the radio chip.">radioInit</a>(<span class="keywordtype">bool</span> cal_rc_osc)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> init_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db843ffee3072fd1cb0582955224b6764" title="Transition time from VCC is applied to P_ON.">TIME_TO_ENTER_P_ON</a>);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">//Initialize Hardware Abstraction Layer.</span>
<a name="l00131"></a>00131     <a class="code" href="group__arm.html#gf5ea8985a12feedc3ac25fbb50712183" title="This function initializes the Hardware Abstraction Layer.">hal_init</a>();
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <a class="code" href="group__radio.html#g828c12db6daeae4369180d52f1cbdffd" title="This function will reset all the registers and the state machine of the radio transceiver...">radioResetTrx</a>(); <span class="comment">//Do HW reset of radio transeiver.</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="comment">//Force transition to TRX_OFF.</span>
<a name="l00136"></a>00136     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="group__radio__registers.html#g8ecc63755abb125691b00426cba7fe41" title="Constant CMD_FORCE_TRX_OFF for sub-register SR_TRX_CMD.">CMD_FORCE_TRX_OFF</a>);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db9de5983d25a9b788432f79eeebbda1f" title="Transition time from P_ON to TRX_OFF.">TIME_P_ON_TO_TRX_OFF</a>); <span class="comment">//Wait for the transition to be complete.</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>, RF2xx_SUPPORTED_INTERRUPT_MASK);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="comment">// Set the CCA ED threshold really low</span>
<a name="l00143"></a>00143     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g5d49fade58407955545f861fc65078b9" title="Access parameters for sub-register CCA_ED_THRES in register RG_CCA_THRES.">SR_CCA_ED_THRES</a>, <a class="code" href="group__app.html#gd5c46706b38c7dc7ebb32e964a24fd13" title="The global demo flag.">DEMO</a> ? 2 : 7);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="comment">// calibrate oscillator</span>
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (cal_rc_osc &amp;&amp; <a class="code" href="group__serial.html#gae3f0b4211ba45d265973d40ccbb5fd1" title="Flag to enable the serial port.">SERIAL</a> &amp;&amp; (<a class="code" href="group__radio.html#g1fa4f1561216be34f745f32aaa38d943" title="Defines the platform for which we are building the firmware.">PLATFORM</a> != <a class="code" href="group__radio.html#gde6b4feb4b13e0a4cc943e66c23e0c67" title="Raven demo board (USB version).">RAVENUSB</a>))
<a name="l00147"></a>00147         calibrate_rc_osc();
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordflow">return</span> init_status;
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00161"></a><a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289">00161</a> u8 <a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>(<span class="keywordtype">void</span>)
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163     <span class="keyword">static</span> u8 radio_part_number;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (!radio_part_number)
<a name="l00166"></a>00166         radio_part_number = <a class="code" href="group__arm.html#gfd58b0cad5bbd45b1c4a8d30be4bc11c" title="This function reads data from one of the radio transceiver&amp;#39;s registers.">hal_register_read</a>(<a class="code" href="group__radio__registers.html#g72ebcdb3490edf9a0af95c5feba492fc" title="Offset for register PART_NUM.">RG_PART_NUM</a>);
<a name="l00167"></a>00167     <span class="keywordflow">return</span> radio_part_number;
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00180"></a>00180 <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g828f6014dc84586176b1d8934e7bd5dd" title="Callback function, called when the radio receives an RX_START interrupt.">radioRxStartEvent</a>(u8 <span class="keyword">const</span> <a class="code" href="group__arm.html#ga3a07afe7144b962b3ed8bb0cbc0b892" title="This is the radio ISR handler.">frame_length</a>)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182     <span class="comment">// save away RSSI</span>
<a name="l00183"></a>00183     rssi_val =  <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>( <a class="code" href="group__radio__registers.html#ge4a0fbc6bd43fdcb0272429f5b6edb86" title="Access parameters for sub-register RSSI in register RG_PHY_RSSI.">SR_RSSI</a> );
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#41e5b4ad93b57a3da564efa92e72a909" title="Is the mac busy? Used to protect mac_buffer_tx.">busy</a> = <span class="keyword">false</span>;
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00198"></a><a class="code" href="group__radio.html#g8a4202486f04e061df72ec19973be447">00198</a> u8 <a class="code" href="group__radio.html#g8a4202486f04e061df72ec19973be447" title="Retrieves the saved RSSI (Received Signal Strength Indication) value.">radioGetSavedRssiValue</a>(<span class="keywordtype">void</span>)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200     <span class="keywordflow">return</span> rssi_val;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00209"></a><a class="code" href="group__radio.html#gb89f723b3d8357a3c254083b36bef539">00209</a> u8 <a class="code" href="group__radio.html#gb89f723b3d8357a3c254083b36bef539" title="Retrieves the saved LQI (Link Quality Indication) value.">radioGetSavedLqiValue</a>(<span class="keywordtype">void</span>)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211     <span class="keywordflow">return</span> ((<a class="code" href="structrx__frame__t.html" title="This struct defines the rx data container.">rx_frame_t</a>*)<a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>)-&gt;lqi;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00218"></a><a class="code" href="group__radio.html#ge03d5aceb33d29231cf12d1d3e0997ae">00218</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#ge03d5aceb33d29231cf12d1d3e0997ae" title="Callback function, called when the radio has received a TRX_END interrupt.">radioTrxEndEvent</a>(<span class="keywordtype">void</span>)
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220     <span class="keyword">volatile</span> u8 status;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment">//if (rx_mode)</span>
<a name="l00223"></a>00223     <span class="keyword">volatile</span> u8 state = <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>();
<a name="l00224"></a>00224     <span class="keywordflow">if</span>((state == <a class="code" href="group__radio__registers.html#gb128af01291fb016509cce7df4de6233" title="Constant BUSY_RX_AACK for sub-register SR_TRX_STATUS.">BUSY_RX_AACK</a>) || (state == <a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>) || (state == <a class="code" href="group__radio__registers.html#g9486d08d26658473840dd55ef9d59783" title="Constant BUSY_RX for sub-register SR_TRX_STATUS.">BUSY_RX</a>) || (state == <a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>))
<a name="l00225"></a>00225     {
<a name="l00226"></a>00226         <span class="comment">/* radio has received frame, store it away */</span>
<a name="l00227"></a>00227         <a class="code" href="group__arm.html#gf0c93eac551707aea7563b32f33fbff3" title="This function will upload a frame from the radio transceiver&amp;#39;s frame buffer.">hal_frame_read</a>();
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         <a class="code" href="structevent__object__t.html" title="Object that defines a single event.">event_object_t</a> event;
<a name="l00230"></a>00230         <span class="keyword">event</span>.event = 0;
<a name="l00231"></a>00231         <span class="keyword">event</span>.data = 0;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <span class="comment">// Figure out which kind of frame we have</span>
<a name="l00234"></a>00234         u16 fcf = <a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>[1] + <a class="code" href="group__mac.html#gfeaf8ffad6487abe7551f66403cf4bae" title="Global MAC buffer (receive).">mac_buffer_rx</a>[2]*0x100;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="comment">// Dump any broadcast frames, except for Beacon/BeaconReq</span>
<a name="l00237"></a>00237         <span class="keywordflow">if</span> (mac_buffer_rx[6] == 0xff &amp;&amp; <span class="comment">// Broadcast src addr</span>
<a name="l00238"></a>00238             mac_buffer_rx[7] == 0xff &amp;&amp;
<a name="l00239"></a>00239             (fcf &amp; 0xf0)) <span class="comment">// Beacon and beacon request have this nibble zero</span>
<a name="l00240"></a>00240             <span class="comment">// Don't bother processing this broadcast frame</span>
<a name="l00241"></a>00241             <span class="keywordflow">return</span>;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="comment">// Look at fcf</span>
<a name="l00245"></a>00245         <span class="keywordflow">switch</span> (fcf)
<a name="l00246"></a>00246         {
<a name="l00247"></a>00247         <span class="keywordflow">case</span> <a class="code" href="group__mac.html#gdb8686066c076d5d45024d1375535b1f" title="Beacon request, no src, short dest, no ack, MAC frame.">FCF_BEACONREQ</a>:
<a name="l00248"></a>00248             <span class="comment">// Beacon request</span>
<a name="l00249"></a>00249             <span class="keywordflow">if</span> ((<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g5794c1a5f0eedfe85aea59330c25848a" title="Router node.">ROUTER</a> &amp;&amp; <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#b90d9d43eb3ae9d98e9cd556272bf464" title="Is this node associated with a network?">associated</a>) ||
<a name="l00250"></a>00250                 <a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> == <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00251"></a>00251                 <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8a3b5fd4ebcce71ceb67f861db3e17b09" title="This node received a beacon request frame.">MAC_EVENT_BEACON_REQ</a>;
<a name="l00252"></a>00252             <span class="keywordflow">break</span>;
<a name="l00253"></a>00253         <span class="keywordflow">case</span> <a class="code" href="group__mac.html#g2426412ac83111d869c05a8314542dda" title="Beacon frame, short src, no dest, beacon frame.">FCF_BEACON</a>:
<a name="l00254"></a>00254             <span class="comment">// Beacon</span>
<a name="l00255"></a>00255             <span class="comment">// Only report beacon frames if we're scanning</span>
<a name="l00256"></a>00256             <span class="keywordflow">if</span> (<a class="code" href="group__mac__scan.html#g92f5262200ca45d25313feb542d9c30b" title="Reports whether the MAC is currently scanning.">macIsScanning</a>())
<a name="l00257"></a>00257                 <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f82cb3614905940da04ed37617f4f691fd" title="This node received a beacon frame.">MAC_EVENT_SCAN</a>;
<a name="l00258"></a>00258             <span class="keywordflow">break</span>;
<a name="l00259"></a>00259         <span class="keywordflow">case</span> <a class="code" href="group__mac.html#gfa03324c606f9efe4838b4d2b95fb798" title="Data frame, short src and dest, ack, data frame.">FCF_DATA</a>:
<a name="l00260"></a>00260             <span class="comment">// Data</span>
<a name="l00261"></a>00261             <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f840ed95f968b7c2745afbf6230910cf24" title="This node has received a packet.">MAC_EVENT_RX</a>;
<a name="l00262"></a>00262             <span class="keywordflow">break</span>;
<a name="l00263"></a>00263         <span class="keywordflow">case</span> <a class="code" href="group__mac.html#g8554c6f65951e156a8385590d36debfd" title="Direct association request, long src, short dest, ack, MAC frame.">FCF_ASSOC_REQ_DIRECT</a>:
<a name="l00264"></a>00264             <span class="comment">// Association Request, direct</span>
<a name="l00265"></a>00265             <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#gfa11cf93bface598cd7a0fa88a71285c" title="End node.">ENDDEVICE</a>)
<a name="l00266"></a>00266                 <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8f9dd86feba30725fbebc732127c504d7" title="Received an association request frame.">MAC_EVENT_ASSOCIATION_REQUEST</a>;
<a name="l00267"></a>00267             <span class="keywordflow">break</span>;
<a name="l00268"></a>00268         <span class="keywordflow">case</span> <a class="code" href="group__mac.html#g58b9c080c01f495671fb859eb86217cd" title="Direct association response, short src, long dest, ack, MAC frame.">FCF_ASSOC_RESP_DIRECT</a>:
<a name="l00269"></a>00269             <span class="comment">// Association response, direct</span>
<a name="l00270"></a>00270             <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00271"></a>00271                 <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8ee76a889d65565078fc1551fb9c8d2e5" title="Received an association response frame.">MAC_EVENT_ASSOCIATION_RESPONSE</a>;
<a name="l00272"></a>00272             <span class="keywordflow">break</span>;
<a name="l00273"></a>00273         <span class="keywordflow">case</span> <a class="code" href="group__mac.html#g1ca7c0002a9db25b651693af6a9ef938" title="Mac Command frame, short src and dest, ack, MAC frame.">FCF_MAC_CMD</a>:
<a name="l00274"></a>00274             <span class="comment">// MAC command frames</span>
<a name="l00275"></a>00275             <span class="keywordflow">switch</span> (((<a class="code" href="structftRouting.html" title="Routing packet, sent by the coordinator and forwarded down a single path of routers...">ftRouting</a>*)(mac_buffer_rx+1))-&gt;cmd)
<a name="l00276"></a>00276             {
<a name="l00277"></a>00277             <span class="keywordflow">case</span> 1:
<a name="l00278"></a>00278                 <span class="comment">// Association request</span>
<a name="l00279"></a>00279                 <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#gfa11cf93bface598cd7a0fa88a71285c" title="End node.">ENDDEVICE</a>)
<a name="l00280"></a>00280                     <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8f9dd86feba30725fbebc732127c504d7" title="Received an association request frame.">MAC_EVENT_ASSOCIATION_REQUEST</a>;
<a name="l00281"></a>00281                 <span class="keywordflow">break</span>;
<a name="l00282"></a>00282             <span class="keywordflow">case</span> 2:
<a name="l00283"></a>00283                 <span class="comment">// Association response</span>
<a name="l00284"></a>00284                 <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00285"></a>00285                     <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8ee76a889d65565078fc1551fb9c8d2e5" title="Received an association response frame.">MAC_EVENT_ASSOCIATION_RESPONSE</a>;
<a name="l00286"></a>00286                 <span class="keywordflow">break</span>;
<a name="l00287"></a>00287             <span class="keywordflow">case</span> <a class="code" href="group__mac.html#g1bad177d49cd2ab85b180af9e34fe24a" title="Routing packet MAC type.">ROUTING_PACKET</a>:
<a name="l00288"></a>00288                 <span class="comment">// Routing packet</span>
<a name="l00289"></a>00289                 <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#g146ff2075038ea93bc2d81bba8df519e" title="Coordinator node.">COORD</a>)
<a name="l00290"></a>00290                     <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8b263e633d64dc7a2f05313f3c9335c72" title="Received a routing packet.">MAC_EVENT_ROUTE</a>;
<a name="l00291"></a>00291                 <span class="keywordflow">break</span>;
<a name="l00292"></a>00292             <span class="keywordflow">default</span>:
<a name="l00293"></a>00293                 <span class="keywordflow">break</span>;
<a name="l00294"></a>00294             }
<a name="l00295"></a>00295         <span class="keywordflow">default</span>:
<a name="l00296"></a>00296             <span class="keywordflow">break</span>;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         <a class="code" href="group__mac__event.html#g546b1497ed4c233b1bbfcc34c0b386be" title="Puts an event into the queue of events.">mac_put_event</a>(&amp;event);
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300     <span class="comment">//if (!rx_mode)</span>
<a name="l00301"></a>00301     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((state == <a class="code" href="group__radio__registers.html#g9cbdb413702bfd45c35773bee53c4cd3" title="Constant BUSY_TX for sub-register SR_TRX_STATUS.">BUSY_TX</a>) || (state == <a class="code" href="group__radio__registers.html#g4480cfa57a0f162471e351fce3ce72da" title="Constant BUSY_TX_ARET for sub-register SR_TRX_STATUS.">BUSY_TX_ARET</a>) || (state == <a class="code" href="group__radio__registers.html#g0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>) || (state == <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>))
<a name="l00302"></a>00302     <span class="comment">//else</span>
<a name="l00303"></a>00303     {
<a name="l00304"></a>00304         <span class="comment">// Not busy any more</span>
<a name="l00305"></a>00305         <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#41e5b4ad93b57a3da564efa92e72a909" title="Is the mac busy? Used to protect mac_buffer_tx.">busy</a> = <span class="keyword">false</span>;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         <span class="comment">// transmit mode, put end-of-transmit event in queue</span>
<a name="l00308"></a>00308         <a class="code" href="structevent__object__t.html" title="Object that defines a single event.">event_object_t</a> event;
<a name="l00309"></a>00309         <span class="keyword">event</span>.event = 0;
<a name="l00310"></a>00310         <span class="keyword">event</span>.data = 0;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         status = <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#g4692d9ea2770ff145d1c35c513cbf1d6" title="Access parameters for sub-register TRAC_STATUS in register RG_TRX_STATE.">SR_TRAC_STATUS</a>);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="keywordflow">switch</span>(status)
<a name="l00315"></a>00315         {
<a name="l00316"></a>00316         <span class="keywordflow">case</span> TRAC_SUCCESS:
<a name="l00317"></a>00317         <span class="keywordflow">case</span> TRAC_SUCCESS_DATA_PENDING:
<a name="l00318"></a>00318             <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f83c364481dd46a97d7e200ba0639b5db2" title="Received an ACK frame.">MAC_EVENT_ACK</a>;
<a name="l00319"></a>00319             <span class="keywordflow">break</span>;
<a name="l00320"></a>00320         <span class="keywordflow">case</span> TRAC_CHANNEL_ACCESS_FAILURE:
<a name="l00321"></a>00321             <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f8091d2580df2f03bbd2dc3d88ede40003" title="Channel access failure.">MAC_EVENT_ACCESS</a>;
<a name="l00322"></a>00322             <span class="keywordflow">break</span>;
<a name="l00323"></a>00323         <span class="keywordflow">case</span> TRAC_NO_ACK:
<a name="l00324"></a>00324             <span class="keyword">event</span>.event = <a class="code" href="group__mac__associate.html#gg2fb9b58e4e5f14f40af8b4a1425841f885c267479467e0c83437bc79b929d5cd" title="Sent frame failed.">MAC_EVENT_NACK</a>;
<a name="l00325"></a>00325             <span class="keywordflow">break</span>;
<a name="l00326"></a>00326         <span class="keywordflow">case</span> TRAC_SUCCESS_WAIT_FOR_ACK:
<a name="l00327"></a>00327             <span class="comment">// should only happen in RX mode</span>
<a name="l00328"></a>00328         <span class="keywordflow">case</span> TRAC_INVALID:
<a name="l00329"></a>00329             <span class="comment">// should never happen here</span>
<a name="l00330"></a>00330         <span class="keywordflow">default</span>:
<a name="l00331"></a>00331             <span class="keywordflow">break</span>;
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (event.<a class="code" href="structevent__object__t.html#6a37405f07f272216ff92f385be1d684" title="Event type, see event_t for details.">event</a>)
<a name="l00335"></a>00335             <a class="code" href="group__mac__event.html#g546b1497ed4c233b1bbfcc34c0b386be" title="Puts an event into the queue of events.">mac_put_event</a>(&amp;event);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="comment">// Put radio back into receive mode.</span>
<a name="l00338"></a>00338         <a class="code" href="group__radio.html#g9c32d026c082234626f5f900077221bc" title="This function will change the current state of the radio transceiver&amp;#39;s internal...">radioSetTrxState</a>(<a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>);
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 
<a name="l00349"></a><a class="code" href="group__radio.html#g1c1b73c569365e457a1d9b9b773eadbb">00349</a> u8 <a class="code" href="group__radio.html#g1c1b73c569365e457a1d9b9b773eadbb" title="This function will return the channel used by the radio transceiver.">radioGetOperatingChannel</a>(<span class="keywordtype">void</span>)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#g4b9bff87f5d63f845e3fad83286624db" title="Access parameters for sub-register CHANNEL in register RG_PHY_CC_CCA.">SR_CHANNEL</a>);
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00366"></a><a class="code" href="group__radio.html#g14d426a54ebfc9514e5f6c23eb7fc736">00366</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g14d426a54ebfc9514e5f6c23eb7fc736" title="This function will change the operating channel.">radioSetOperatingChannel</a>(u8 channel)
<a name="l00367"></a>00367 {
<a name="l00368"></a>00368     <span class="comment">/*Do function parameter and state check.*/</span>
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g036a88551664cfe893bc3f51a64ba179" title="When CHINA_MODE is set, there are only 4 channels (1-4).">CHINA_MODE</a>)
<a name="l00371"></a>00371     {
<a name="l00372"></a>00372         u8 val;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="comment">// Enable direct frequency setting</span>
<a name="l00375"></a>00375         <span class="comment">// Ch1 = 780MHz</span>
<a name="l00376"></a>00376         <span class="comment">// Ch2 = 782MHz</span>
<a name="l00377"></a>00377         <span class="comment">// Ch3 = 784MHz</span>
<a name="l00378"></a>00378         <span class="comment">// Ch4 = 786MHz</span>
<a name="l00379"></a>00379         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(SR_CC_BAND, 4);
<a name="l00380"></a>00380         <span class="keywordflow">if</span> (channel &lt; 1 || channel &gt; 4)
<a name="l00381"></a>00381             <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         val = 9 + 2*channel;
<a name="l00384"></a>00384         <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g6b7353cc2fb7f14b616c59fe073d61ee" title="Channel control register 0.">RG_CC_CTRL_0</a>, val);
<a name="l00385"></a>00385         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <span class="keywordflow">else</span> <span class="comment">// Not china mode</span>
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (((s8)channel &lt; MIN_CHANNEL &amp;&amp; MIN_CHANNEL) ||
<a name="l00390"></a>00390             (channel &gt; MAX_CHANNEL))
<a name="l00391"></a>00391             <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>() == <span class="keyword">true</span>)
<a name="l00394"></a>00394             <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g1c1b73c569365e457a1d9b9b773eadbb" title="This function will return the channel used by the radio transceiver.">radioGetOperatingChannel</a>() == channel)
<a name="l00397"></a>00397             <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <span class="comment">/*Set new operating channel.*/</span>
<a name="l00400"></a>00400         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g4b9bff87f5d63f845e3fad83286624db" title="Access parameters for sub-register CHANNEL in register RG_PHY_CC_CCA.">SR_CHANNEL</a>, channel);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="comment">//Read current state and wait for the PLL_LOCK interrupt if the</span>
<a name="l00403"></a>00403         <span class="comment">//radio transceiver is in either RX_ON or PLL_ON.</span>
<a name="l00404"></a>00404         u8 trx_state = <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>();
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         <span class="keywordflow">if</span> ((trx_state == <a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>) ||
<a name="l00407"></a>00407             (trx_state == <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>))
<a name="l00408"></a>00408             delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08de5b568fca41fce82055b00269565b7ef" title="Maximum time it should take for the PLL to lock.">TIME_PLL_LOCK</a>);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> channel_set_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73c1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         <span class="comment">//Check that the channel was set properly.</span>
<a name="l00413"></a>00413         <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g1c1b73c569365e457a1d9b9b773eadbb" title="This function will return the channel used by the radio transceiver.">radioGetOperatingChannel</a>() == channel)
<a name="l00414"></a>00414             channel_set_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="keywordflow">return</span> channel_set_status;
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 
<a name="l00433"></a><a class="code" href="group__radio.html#g304d72041bb3ee614ac9e5dd0f9cd2bc">00433</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g304d72041bb3ee614ac9e5dd0f9cd2bc" title="This function will change the output power level.">radioSetTxPowerLevel</a>(u8 power_level)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="comment">/*Check function parameter and state.*/</span>
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (power_level &gt; TX_PWR_17_2DBM)
<a name="l00438"></a>00438         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>() == <span class="keyword">true</span>)
<a name="l00441"></a>00441         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="comment">/*Set new power level*/</span>
<a name="l00444"></a>00444     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g34ec89db5926c2c2348dbc587629a9e8" title="Access parameters for sub-register TX_PWR in register RG_PHY_TX_PWR.">SR_TX_PWR</a>, power_level);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 <span class="preprocessor">#if (NODETYPE == COORD)</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>
<a name="l00457"></a><a class="code" href="group__radio.html#g0c689f664f8c670a4bc0d5c014bee03f">00457</a> u8 <a class="code" href="group__radio.html#g0c689f664f8c670a4bc0d5c014bee03f" title="This function will read and return the output power level.">radioGetTxPowerLevel</a>(<span class="keywordtype">void</span>)
<a name="l00458"></a>00458 {
<a name="l00459"></a>00459     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#g34ec89db5926c2c2348dbc587629a9e8" title="Access parameters for sub-register TX_PWR in register RG_PHY_TX_PWR.">SR_TX_PWR</a>);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 
<a name="l00469"></a><a class="code" href="group__radio.html#gfeb6681fcb660830ec7649e049784da9">00469</a> u8 <a class="code" href="group__radio.html#gfeb6681fcb660830ec7649e049784da9" title="This function returns the current CCA mode used.">radioGetCcaMode</a>(<span class="keywordtype">void</span>)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#g5f1683f4ba650a0737bf0a4cce54da51" title="Access parameters for sub-register CCA_MODE in register RG_PHY_CC_CCA.">SR_CCA_MODE</a>);
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00480"></a><a class="code" href="group__radio.html#g6490cdedd0b5c2794dd3c29a6f8acefa">00480</a> u8 <a class="code" href="group__radio.html#g6490cdedd0b5c2794dd3c29a6f8acefa" title="This function returns the current ED threshold used by the CCA algorithm.">radioGetEdThreshold</a>(<span class="keywordtype">void</span>)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#g5d49fade58407955545f861fc65078b9" title="Access parameters for sub-register CCA_ED_THRES in register RG_CCA_THRES.">SR_CCA_ED_THRES</a>);
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00495"></a><a class="code" href="group__radio.html#ge1c88b412735308dfc1901f114a8ca66">00495</a> u8 <a class="code" href="group__radio.html#ge1c88b412735308dfc1901f114a8ca66" title="This function returns the current threshold volatge used by the battery monitor (BATMON_VTH)...">radioBatmonGetVoltageThreshold</a>(<span class="keywordtype">void</span>)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#gf4d8678ff08d67835ed9fde2e063e524" title="Access parameters for sub-register BATMON_VTH in register RG_BATMON.">SR_BATMON_VTH</a>);
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00510"></a><a class="code" href="group__radio.html#g09332abc57dc69b296b23e650324daf6">00510</a> u8 <a class="code" href="group__radio.html#g09332abc57dc69b296b23e650324daf6" title="This function returns if high or low voltage range is used.">radioBatmonGetVoltageRange</a>(<span class="keywordtype">void</span>)
<a name="l00511"></a>00511 {
<a name="l00512"></a>00512     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#gaade16ed1ba624efbf6a71cb66af9d0f" title="Access parameters for sub-register BATMON_HR in register RG_BATMON.">SR_BATMON_HR</a>);
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00526"></a><a class="code" href="group__radio.html#gfc0224268575b799b05e6163dae5456a">00526</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#gfc0224268575b799b05e6163dae5456a" title="This function is used to configure the battery monitor module.">radioBatmonConfigure</a>(<span class="keywordtype">bool</span> range, u8 voltage_threshold)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     <span class="comment">/*Check function parameters and state.*/</span>
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (voltage_threshold &gt; BATTERY_MONITOR_HIGHEST_VOLTAGE)
<a name="l00531"></a>00531         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>() == <span class="keyword">true</span>)
<a name="l00534"></a>00534         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <span class="comment">/*Write new voltage range and voltage level.*/</span>
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (range == <span class="keyword">true</span>)
<a name="l00538"></a>00538         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#gaade16ed1ba624efbf6a71cb66af9d0f" title="Access parameters for sub-register BATMON_HR in register RG_BATMON.">SR_BATMON_HR</a>, BATTERY_MONITOR_HIGH_VOLTAGE);
<a name="l00539"></a>00539     <span class="keywordflow">else</span>
<a name="l00540"></a>00540         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#gaade16ed1ba624efbf6a71cb66af9d0f" title="Access parameters for sub-register BATMON_HR in register RG_BATMON.">SR_BATMON_HR</a>, BATTERY_MONITOR_LOW_VOLTAGE);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#gf4d8678ff08d67835ed9fde2e063e524" title="Access parameters for sub-register BATMON_VTH in register RG_BATMON.">SR_BATMON_VTH</a>, voltage_threshold);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00557"></a><a class="code" href="group__radio.html#g8029b4f59bd19747a3090cf56adfd912">00557</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g8029b4f59bd19747a3090cf56adfd912" title="This function returns the status of the Battery Monitor module.">radioBatmonGetStatus</a>(<span class="keywordtype">void</span>)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> batmon_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73dba268aded546c8ee6aa90fb1b457d09" title="Measured battery voltage is lower than voltage threshold.">RADIO_BAT_LOW</a>;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (<a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#gcff72bdcbf66f9ef80b51797328f04b4" title="Access parameters for sub-register BATMON_OK in register RG_BATMON.">SR_BATMON_OK</a>) !=
<a name="l00563"></a>00563         BATTERY_MONITOR_VOLTAGE_UNDER_THRESHOLD)
<a name="l00564"></a>00564         batmon_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a7312f567282c526bee93379f8a69a60fb3" title="Measured battery voltage is above the voltage threshold.">RADIO_BAT_OK</a>;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="keywordflow">return</span> batmon_status;
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00580"></a><a class="code" href="group__radio.html#ge1c39dc3b5d283a37058861892222fda">00580</a> u8 <a class="code" href="group__radio.html#ge1c39dc3b5d283a37058861892222fda" title="This function returns the current clock setting for the CLKM pin.">radioGetClockSpeed</a>(<span class="keywordtype">void</span>)
<a name="l00581"></a>00581 {
<a name="l00582"></a>00582     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#gc108f260911d536daba845f79a0c7eff" title="Access parameters for sub-register CLKM_CTRL in register RG_TRX_CTRL_0.">SR_CLKM_CTRL</a>);
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 <span class="preprocessor">#endif // if (COORD)</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span>
<a name="l00597"></a><a class="code" href="group__radio.html#g8778c102ebad3e3db714d1d7a6c4c6f0">00597</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g8778c102ebad3e3db714d1d7a6c4c6f0" title="This function returns the Received Signal Strength Indication.">radioGetRssiValue</a>(u8 *rssi)
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     u8 current_state = <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>();
<a name="l00601"></a>00601     <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> retval = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="comment">/*The RSSI measurement should only be done in RX_ON or BUSY_RX.*/</span>
<a name="l00604"></a>00604     <span class="keywordflow">if</span> ((current_state == <a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>) ||
<a name="l00605"></a>00605         (current_state == <a class="code" href="group__radio__registers.html#g9486d08d26658473840dd55ef9d59783" title="Constant BUSY_RX for sub-register SR_TRX_STATUS.">BUSY_RX</a>))
<a name="l00606"></a>00606     {
<a name="l00607"></a>00607         *rssi = <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#ge4a0fbc6bd43fdcb0272429f5b6edb86" title="Access parameters for sub-register RSSI in register RG_PHY_RSSI.">SR_RSSI</a>);
<a name="l00608"></a>00608         retval = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <span class="keywordflow">return</span> retval;
<a name="l00612"></a>00612 }
<a name="l00613"></a>00613 
<a name="l00635"></a><a class="code" href="group__radio.html#g52391d34dfa78c4ad817e3f18b0de579">00635</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g52391d34dfa78c4ad817e3f18b0de579" title="This function changes the prescaler on the CLKM pin.">radioSetClockSpeed</a>(<span class="keywordtype">bool</span> direct, u8 clock_speed)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637     <span class="comment">/*Check function parameter and current clock speed.*/</span>
<a name="l00638"></a>00638     <span class="keywordflow">if</span> (clock_speed &gt; CLKM_16MHZ)
<a name="l00639"></a>00639         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="comment">/*Select to change the CLKM frequency directly or after returning from SLEEP.*/</span>
<a name="l00642"></a>00642     <span class="keywordflow">if</span> (direct == <span class="keyword">false</span>)
<a name="l00643"></a>00643         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g3517409068f4c36eedae73ed8ffead13" title="Access parameters for sub-register CLKM_SHA_SEL in register RG_TRX_CTRL_0.">SR_CLKM_SHA_SEL</a>, 1);
<a name="l00644"></a>00644     <span class="keywordflow">else</span>
<a name="l00645"></a>00645         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g3517409068f4c36eedae73ed8ffead13" title="Access parameters for sub-register CLKM_SHA_SEL in register RG_TRX_CTRL_0.">SR_CLKM_SHA_SEL</a>, 0);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#gc108f260911d536daba845f79a0c7eff" title="Access parameters for sub-register CLKM_CTRL in register RG_TRX_CTRL_0.">SR_CLKM_CTRL</a>, clock_speed);
<a name="l00648"></a>00648     <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00695"></a><a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3">00695</a> u8 <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>(<span class="keywordtype">void</span>)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697     <span class="keywordflow">return</span> <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#gbb9dcc6f85b1154d76645b5de64d4835" title="Access parameters for sub-register TRX_STATUS in register RG_TRX_STATUS.">SR_TRX_STATUS</a>);
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00708"></a><a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c">00708</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>(<span class="keywordtype">void</span>)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710     <span class="keywordtype">bool</span> sleeping = <span class="keyword">false</span>;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="comment">//The radio transceiver will be at SLEEP or one of the *_NOCLK states only if</span>
<a name="l00713"></a>00713     <span class="comment">//the SLP_TR pin is high.</span>
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#gf84d2cf7ef1ceb94be57bc20be328cea" title="Read current state of the SLP_TR pin (High/Low).">hal_get_slptr</a>() != 0)
<a name="l00715"></a>00715         sleeping = <span class="keyword">true</span>;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keywordflow">return</span> sleeping;
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00740"></a><a class="code" href="group__radio.html#g9c32d026c082234626f5f900077221bc">00740</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g9c32d026c082234626f5f900077221bc" title="This function will change the current state of the radio transceiver&amp;#39;s internal...">radioSetTrxState</a>(u8 new_state)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742     u8 original_state;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">/*Check function paramter and current state of the radio transceiver.*/</span>
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (!((new_state == <a class="code" href="group__radio__registers.html#gd9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>)    ||
<a name="l00746"></a>00746           (new_state == <a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>)      ||
<a name="l00747"></a>00747           (new_state == <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>)     ||
<a name="l00748"></a>00748           (new_state == <a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>) ||
<a name="l00749"></a>00749           (new_state == <a class="code" href="group__radio__registers.html#g0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>)))
<a name="l00750"></a>00750         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>() == <span class="keyword">true</span>)
<a name="l00753"></a>00753         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="comment">// Wait for radio to finish previous operation</span>
<a name="l00756"></a>00756     <span class="keywordflow">while</span> (<a class="code" href="group__radio.html#gb18f99759fd3d798150020e91e7b46e9" title="Check whether the radio chip is busy.">radioIsBusy</a>())
<a name="l00757"></a>00757         ;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="comment">// For RF230, don't use auto mode while scanning, because no RX_START</span>
<a name="l00760"></a>00760     <span class="comment">// will be issued.</span>
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>() == <a class="code" href="group__radio__registers.html#g4f0b9bf26fdc64cc5e6c640871b050e4" title="Value for AT86RF230.">RF230</a> &amp;&amp;
<a name="l00762"></a>00762         <a class="code" href="group__mac__scan.html#g92f5262200ca45d25313feb542d9c30b" title="Reports whether the MAC is currently scanning.">macIsScanning</a>() &amp;&amp;
<a name="l00763"></a>00763         new_state == <a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>)
<a name="l00764"></a>00764         new_state = <a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     original_state = <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>();
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (new_state == original_state)
<a name="l00768"></a>00768         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     <span class="comment">//At this point it is clear that the requested new_state is:</span>
<a name="l00771"></a>00771     <span class="comment">//TRX_OFF, RX_ON, PLL_ON, RX_AACK_ON or TX_ARET_ON.</span>
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     <span class="comment">//The radio transceiver can be in one of the following states:</span>
<a name="l00774"></a>00774     <span class="comment">//TRX_OFF, RX_ON, PLL_ON, RX_AACK_ON, TX_ARET_ON.</span>
<a name="l00775"></a>00775     <span class="keywordflow">if</span>(new_state == <a class="code" href="group__radio__registers.html#gd9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>)
<a name="l00776"></a>00776         <a class="code" href="group__radio.html#g847a215246618de0ba072d278f849da0" title="This function will reset the state machine (to TRX_OFF) from any of its states, except...">radioResetStateMachine</a>(); <span class="comment">//Go to TRX_OFF from any state.</span>
<a name="l00777"></a>00777     <span class="keywordflow">else</span>
<a name="l00778"></a>00778     {
<a name="l00779"></a>00779         <span class="comment">//It is not allowed to go from RX_AACK_ON or TX_AACK_ON and directly to</span>
<a name="l00780"></a>00780         <span class="comment">//TX_AACK_ON or RX_AACK_ON respectively. Need to go via RX_ON or PLL_ON.</span>
<a name="l00781"></a>00781         <span class="keywordflow">if</span> ((new_state == <a class="code" href="group__radio__registers.html#g0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>) &amp;&amp;
<a name="l00782"></a>00782             (original_state != <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>))
<a name="l00783"></a>00783         {
<a name="l00784"></a>00784             <span class="comment">//First do intermediate state transition to PLL_ON, then to TX_ARET_ON.</span>
<a name="l00785"></a>00785             <span class="comment">//The final state transition to TX_ARET_ON is handled after the if-else if.</span>
<a name="l00786"></a>00786             <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>);
<a name="l00787"></a>00787 <span class="comment">//#ifdef __AVR__</span>
<a name="l00788"></a>00788             <span class="keywordflow">if</span> (original_state == <a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>)
<a name="l00789"></a>00789                 delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08da68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a>);
<a name="l00790"></a>00790             <span class="keywordflow">else</span>
<a name="l00791"></a>00791                 delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db69e9ed03883d6e427ea2027fb3daf13" title="Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON.">TIME_TRX_OFF_TO_PLL_ACTIVE</a>);
<a name="l00792"></a>00792 <span class="comment">//#endif</span>
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((new_state == <a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>) &amp;&amp;
<a name="l00795"></a>00795                  (original_state != <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>))
<a name="l00796"></a>00796         {
<a name="l00797"></a>00797             <span class="comment">//First do intermediate state transition to PLL_ON, then to RX_AACK_ON.</span>
<a name="l00798"></a>00798             <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="group__radio__registers.html#g77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>);
<a name="l00799"></a>00799 <span class="comment">//#ifdef __AVR__</span>
<a name="l00800"></a>00800             <span class="keywordflow">if</span> (original_state == <a class="code" href="group__radio__registers.html#g0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>)
<a name="l00801"></a>00801                 delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08da68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a>);
<a name="l00802"></a>00802             <span class="keywordflow">else</span>
<a name="l00803"></a>00803                 delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db69e9ed03883d6e427ea2027fb3daf13" title="Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON.">TIME_TRX_OFF_TO_PLL_ACTIVE</a>);
<a name="l00804"></a>00804 <span class="comment">//#endif</span>
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="comment">//Any other state transition can be done directly.</span>
<a name="l00808"></a>00808         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, new_state);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="comment">//When the PLL is active most states can be reached in 1us. However, from</span>
<a name="l00811"></a>00811         <span class="comment">//TRX_OFF the PLL needs time to activate.</span>
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (original_state == <a class="code" href="group__radio__registers.html#gd9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>)
<a name="l00813"></a>00813         {
<a name="l00814"></a>00814 <span class="comment">//#ifdef __AVR__</span>
<a name="l00815"></a>00815             delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08db69e9ed03883d6e427ea2027fb3daf13" title="Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON.">TIME_TRX_OFF_TO_PLL_ACTIVE</a>);
<a name="l00816"></a>00816 <span class="comment">//#endif</span>
<a name="l00817"></a>00817         }
<a name="l00818"></a>00818         <span class="keywordflow">else</span>
<a name="l00819"></a>00819         {
<a name="l00820"></a>00820 <span class="comment">//#ifdef __AVR__</span>
<a name="l00821"></a>00821             delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08da68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a>);
<a name="l00822"></a>00822 <span class="comment">//#endif</span>
<a name="l00823"></a>00823         }
<a name="l00824"></a>00824     } <span class="comment">// end: if(new_state == TRX_OFF) ...</span>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826     <span class="comment">/*Verify state transition.*/</span>
<a name="l00827"></a>00827     <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> set_state_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73c1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>() == new_state)
<a name="l00830"></a>00830         set_state_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <span class="keywordflow">return</span> set_state_status;
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00842"></a><a class="code" href="group__radio.html#g324b48dc10d81456ce6ddd909f1d5e83">00842</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g324b48dc10d81456ce6ddd909f1d5e83" title="This function will put the radio transceiver to sleep.">radioEnterSleepMode</a>(<span class="keywordtype">void</span>)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>() == <span class="keyword">true</span>)
<a name="l00845"></a>00845         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     <a class="code" href="group__radio.html#g847a215246618de0ba072d278f849da0" title="This function will reset the state machine (to TRX_OFF) from any of its states, except...">radioResetStateMachine</a>(); <span class="comment">//Force the device into TRX_OFF.</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d9fcebaaad9f84d4af5895d4f1821a270" title="Transition time from RESET to TRX_OFF.">TIME_RESET_TRX_OFF</a>);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> enter_sleep_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73c1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>() == <a class="code" href="group__radio__registers.html#gd9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>)
<a name="l00854"></a>00854     {
<a name="l00855"></a>00855         <span class="comment">//Enter Sleep.</span>
<a name="l00856"></a>00856         hal_set_slptr_high();
<a name="l00857"></a>00857         enter_sleep_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860     <span class="keywordflow">return</span> enter_sleep_status;
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00871"></a><a class="code" href="group__radio.html#g9b993ad338e639b917540d835079ce84">00871</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g9b993ad338e639b917540d835079ce84" title="This function will take the radio transceiver from sleep mode and put it into the...">radioLeaveSleepMode</a>(<span class="keywordtype">void</span>)
<a name="l00872"></a>00872 {
<a name="l00873"></a>00873     <span class="comment">//Check if the radio transceiver is actually sleeping.</span>
<a name="l00874"></a>00874     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g29bbaf755e336eeec99729db6be0226c" title="This function checks if the radio transceiver is sleeping.">isSleeping</a>() == <span class="keyword">false</span>)
<a name="l00875"></a>00875         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <a class="code" href="group__radio.html#g8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l00878"></a>00878     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d7067e6c59db93ac323c375140eff1c51" title="Transition time from SLEEP to TRX_OFF.">TIME_SLEEP_TO_TRX_OFF</a>);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> leave_sleep_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73c1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     <span class="comment">//Ensure CLKM is OFF</span>
<a name="l00883"></a>00883     <a class="code" href="group__radio.html#g52391d34dfa78c4ad817e3f18b0de579" title="This function changes the prescaler on the CLKM pin.">radioSetClockSpeed</a>(<span class="keyword">true</span>, CLKM_DISABLED);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="comment">//Ensure that the radio transceiver is in the TRX_OFF state.</span>
<a name="l00886"></a>00886     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>() == <a class="code" href="group__radio__registers.html#gd9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>)
<a name="l00887"></a>00887         leave_sleep_status = <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">return</span> leave_sleep_status;
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00897"></a><a class="code" href="group__radio.html#g847a215246618de0ba072d278f849da0">00897</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g847a215246618de0ba072d278f849da0" title="This function will reset the state machine (to TRX_OFF) from any of its states, except...">radioResetStateMachine</a>(<span class="keywordtype">void</span>)
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899     <a class="code" href="group__radio.html#g8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l00900"></a>00900     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d60b95807cc5d2690b9ee459c861c6a6c" title="Transition time from *_NOCLK to being awake.">TIME_NOCLK_TO_WAKE</a>);
<a name="l00901"></a>00901     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="group__radio__registers.html#g8ecc63755abb125691b00426cba7fe41" title="Constant CMD_FORCE_TRX_OFF for sub-register SR_TRX_CMD.">CMD_FORCE_TRX_OFF</a>);
<a name="l00902"></a>00902     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08df50b81813c269484256d8d02b3751b4f" title="Time it takes to execute the FORCE_TRX_OFF command.">TIME_CMD_FORCE_TRX_OFF</a>);
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00910"></a><a class="code" href="group__radio.html#g828c12db6daeae4369180d52f1cbdffd">00910</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g828c12db6daeae4369180d52f1cbdffd" title="This function will reset all the registers and the state machine of the radio transceiver...">radioResetTrx</a>(<span class="keywordtype">void</span>)
<a name="l00911"></a>00911 {
<a name="l00912"></a>00912     <a class="code" href="group__radio.html#ga5044a550f2864bffafc79059e0462a5" title="This macro pulls the RST pin low.">hal_set_rst_low</a>();
<a name="l00913"></a>00913     <a class="code" href="group__radio.html#g8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l00914"></a>00914     delay_us(<a class="code" href="group__radio.html#gg7107f1e1a5e3b33325b5f7a489edb08d7987806807cc7ffc8afcafe42665af0f" title="Time to hold the RST pin low during reset.">TIME_RESET</a>);
<a name="l00915"></a>00915     <a class="code" href="group__radio.html#gfad48edf9109099d92e884cc5456ac9e" title="This macro pulls the RST pin high.">hal_set_rst_high</a>();
<a name="l00916"></a>00916 }
<a name="l00917"></a>00917 
<a name="l00928"></a><a class="code" href="group__radio.html#g8a0922b9e86e9c33c9abe3b4b6203df1">00928</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g8a0922b9e86e9c33c9abe3b4b6203df1" title="This function will enable or disable automatic CRC during frame transmission.">radioUseAutoTxCrc</a>(<span class="keywordtype">bool</span> auto_crc_on)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#gb57e5c97e5d788f048284f1175c757b7" title="The BAND macro is set to one particular band based on which platform selected for...">BAND</a> == BAND2400)
<a name="l00931"></a>00931     {
<a name="l00932"></a>00932         <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>() == <a class="code" href="group__radio__registers.html#g4f0b9bf26fdc64cc5e6c640871b050e4" title="Value for AT86RF230.">RF230</a>)
<a name="l00933"></a>00933             <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g21f800988fc9685274f48e40d662ca34" title="Access parameters for sub-register TX_AUTO_CRC_ON in register RG_PHY_TX_PWR.">SR_TX_AUTO_CRC_ON_230</a>, auto_crc_on == <span class="keyword">true</span>);
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>() == <a class="code" href="group__radio__registers.html#g5de4d4c246844ae9e84c535b3dc19dde" title="Value for AT86RF231.">RF231</a>)
<a name="l00935"></a>00935             <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g61e56cafbddcb3cfae1fa352aa04419b" title="Access parameters for sub-register TX_AUTO_CRC_ON in register RG_PHY_TX_PWR.">SR_TX_AUTO_CRC_ON_231</a>, auto_crc_on == <span class="keyword">true</span>);
<a name="l00936"></a>00936     }
<a name="l00937"></a>00937     <span class="keywordflow">else</span>
<a name="l00938"></a>00938         <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(SR_TX_AUTO_CRC_ON, auto_crc_on == <span class="keyword">true</span>);
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 
<a name="l00950"></a><a class="code" href="group__radio.html#gb18f99759fd3d798150020e91e7b46e9">00950</a> u8 <a class="code" href="group__radio.html#gb18f99759fd3d798150020e91e7b46e9" title="Check whether the radio chip is busy.">radioIsBusy</a>(<span class="keywordtype">void</span>)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952     u8 state;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     state = <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>();
<a name="l00955"></a>00955     <span class="keywordflow">return</span> (state == <a class="code" href="group__radio__registers.html#gb128af01291fb016509cce7df4de6233" title="Constant BUSY_RX_AACK for sub-register SR_TRX_STATUS.">BUSY_RX_AACK</a> ||
<a name="l00956"></a>00956             state == <a class="code" href="group__radio__registers.html#g4480cfa57a0f162471e351fce3ce72da" title="Constant BUSY_TX_ARET for sub-register SR_TRX_STATUS.">BUSY_TX_ARET</a> ||
<a name="l00957"></a>00957             state == <a class="code" href="group__radio__registers.html#g9cbdb413702bfd45c35773bee53c4cd3" title="Constant BUSY_TX for sub-register SR_TRX_STATUS.">BUSY_TX</a> ||
<a name="l00958"></a>00958             state == <a class="code" href="group__radio__registers.html#g9486d08d26658473840dd55ef9d59783" title="Constant BUSY_RX for sub-register SR_TRX_STATUS.">BUSY_RX</a> ||
<a name="l00959"></a>00959             state == <a class="code" href="group__radio__registers.html#g7098eb6f17c3e17810b64e7e420da376" title="Constant BUSY_RX_AACK_NOCLK for sub-register SR_TRX_STATUS.">BUSY_RX_AACK_NOCLK</a>);
<a name="l00960"></a>00960 }
<a name="l00961"></a>00961 
<a name="l00983"></a><a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63">00983</a> <a class="code" href="group__radio.html#gb6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> <a class="code" href="group__radio.html#g73d762673c6af21f4fb6b6ba6c06cc63" title="This function will download a frame to the radio transceiver&amp;#39;s transmit buffer...">radioSendData</a>(u8 data_length, u8 *data)
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985     <span class="comment">// Check function parameters and current state.</span>
<a name="l00986"></a>00986     <span class="keywordflow">if</span> (data_length &gt; RF2xx_MAX_TX_FRAME_LENGTH)
<a name="l00987"></a>00987         <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a739dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     <span class="comment">// Wait for radio to get unbusy</span>
<a name="l00990"></a>00990     <span class="keywordflow">while</span> (<a class="code" href="group__radio.html#gb18f99759fd3d798150020e91e7b46e9" title="Check whether the radio chip is busy.">radioIsBusy</a>())
<a name="l00991"></a>00991         ;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <span class="comment">// Put radio in TX_ARET_ON state</span>
<a name="l00994"></a>00994     <span class="keywordflow">do</span>
<a name="l00995"></a>00995     {
<a name="l00996"></a>00996         <a class="code" href="group__radio.html#g9c32d026c082234626f5f900077221bc" title="This function will change the current state of the radio transceiver&amp;#39;s internal...">radioSetTrxState</a>(<a class="code" href="group__radio__registers.html#g0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>);
<a name="l00997"></a>00997     } <span class="keywordflow">while</span> (<a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>() != <a class="code" href="group__radio__registers.html#g0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>);
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <span class="comment">// save last destination address, which is needed</span>
<a name="l01000"></a>01000     <span class="comment">// to process a send failure later</span>
<a name="l01001"></a>01001     <a class="code" href="group__mac.html#g495ae4288ec139138c9ca2b8de136245" title="MAC config struct, contains state info for the MAC.">macConfig</a>.<a class="code" href="structmacConfig__t.html#76d4f685b3d22a842626cb2a1542d912" title="Used to process send failures.">lastDestAddr</a> = ((<a class="code" href="structftData.html" title="Data packet, used for data and some MAC functions (see type element).">ftData</a>*)data)-&gt;destAddr;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="comment">/*Do frame transmission.*/</span>
<a name="l01004"></a>01004     <a class="code" href="group__arm.html#gfdf1c6a3c3867f6c6f29937e9e01bc3b" title="This function will download a frame to the radio transceiver&amp;#39;s frame buffer.">hal_frame_write</a>(data, data_length+2); <span class="comment">//Then write data to the frame buffer.</span>
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     <span class="keywordflow">return</span> <a class="code" href="group__radio.html#ggb6afacea6a7310707d47839506c30a73e0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l01007"></a>01007 }
<a name="l01008"></a>01008 
<a name="l01017"></a><a class="code" href="group__radio.html#gc2322c500c5cc9d4178d3231cac3aa51">01017</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#gc2322c500c5cc9d4178d3231cac3aa51" title="This function will set the I_AM_COORD sub register.">radioSetDeviceRole</a>(<span class="keywordtype">bool</span> i_am_coordinator)
<a name="l01018"></a>01018 {
<a name="l01019"></a>01019     <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(<a class="code" href="group__radio__registers.html#g0111e087406382c6197244d030b39dac" title="Access parameters for sub-register I_AM_COORD in register RG_CSMA_SEED_1.">SR_I_AM_COORD</a>, i_am_coordinator);
<a name="l01020"></a>01020 }
<a name="l01021"></a>01021 
<a name="l01028"></a><a class="code" href="group__radio.html#g8480a533bb1ba14171147bc1aeb78c7d">01028</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g8480a533bb1ba14171147bc1aeb78c7d" title="This function will set the PANID used by the address filter.">radioSetPanId</a>(u16 new_pan_id)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030 
<a name="l01031"></a>01031     u8 pan_byte = new_pan_id &amp; 0xFF; <span class="comment">// Extract new_pan_id_7_0.</span>
<a name="l01032"></a>01032     <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g7e9a100296620bd87365a5355e3ff28d" title="Offset for register PAN_ID_0.">RG_PAN_ID_0</a>, pan_byte);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     pan_byte = (new_pan_id &gt;&gt; 8*1) &amp; 0xFF;  <span class="comment">// Extract new_pan_id_15_8.</span>
<a name="l01035"></a>01035     <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g30cf03f218f9c36554315f737abbedd5" title="Offset for register PAN_ID_1.">RG_PAN_ID_1</a>, pan_byte);
<a name="l01036"></a>01036 }
<a name="l01037"></a>01037 
<a name="l01044"></a><a class="code" href="group__radio.html#g2d1c441755a5b0f6215692474ae36f9f">01044</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#g2d1c441755a5b0f6215692474ae36f9f" title="This function will set the short address used by the address filter.">radioSetShortAddress</a>(u16 new_short_address)
<a name="l01045"></a>01045 {
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     u8 short_address_byte = new_short_address &amp; 0xFF; <span class="comment">// Extract short_address_7_0.</span>
<a name="l01048"></a>01048     <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g7eb78713946ea45d4b96dea4fdfd635b" title="Offset for register SHORT_ADDR_0.">RG_SHORT_ADDR_0</a>, short_address_byte);
<a name="l01049"></a>01049 
<a name="l01050"></a>01050     short_address_byte = (new_short_address &gt;&gt; 8*1) &amp; 0xFF; <span class="comment">// Extract short_address_15_8.</span>
<a name="l01051"></a>01051     <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#ga60598fa1041cdf9caa245cc9fbd52cd" title="Offset for register SHORT_ADDR_1.">RG_SHORT_ADDR_1</a>, short_address_byte);
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01061"></a><a class="code" href="group__radio.html#gd4c77fb534211f3be22c6b4aa29b561e">01061</a> <span class="keywordtype">void</span> <a class="code" href="group__radio.html#gd4c77fb534211f3be22c6b4aa29b561e" title="This function will set a new extended address to be used by the address filter.">radioSetExtendedAddress</a>(u8 *extended_address)
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063     u8 i;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065     <span class="keywordflow">for</span> (i=0;i&lt;8;i++)
<a name="l01066"></a>01066     {
<a name="l01067"></a>01067        <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g15e749d4ff747c1066a644142088c354" title="Offset for register IEEE_ADDR_0.">RG_IEEE_ADDR_0</a>+i, *extended_address++);
<a name="l01068"></a>01068     }
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 
<a name="l01081"></a><a class="code" href="group__radio.html#g301044554e9d047bf22935d01c615884">01081</a> u8 <a class="code" href="group__radio.html#g301044554e9d047bf22935d01c615884" title="Returns a random number, composed of bits from the radio&amp;#39;s random number generator...">radioRandom</a>(u8 bits)
<a name="l01082"></a>01082 {
<a name="l01083"></a>01083     <span class="keywordflow">if</span> ((<a class="code" href="group__mac.html#g59569ff056c7f0f124222ca0013728d5" title="NODETYPE is defined to be one of the three basic node types: coordinator, router...">NODETYPE</a> != <a class="code" href="group__mac.html#gfa11cf93bface598cd7a0fa88a71285c" title="End node.">ENDDEVICE</a>) || APP)
<a name="l01084"></a>01084     {
<a name="l01085"></a>01085         <span class="keyword">volatile</span> u8 val=0;
<a name="l01086"></a>01086         <span class="keyword">volatile</span> u8 regval;
<a name="l01087"></a>01087         u8 i;
<a name="l01088"></a>01088 
<a name="l01089"></a>01089         i = <a class="code" href="group__radio.html#g80178b680aa26b7a8e1a1ce8a4a824b3" title="This function return the Radio Transceivers current state.">radioGetTrxState</a>();
<a name="l01090"></a>01090         <span class="keywordflow">if</span> ((<a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>() == <a class="code" href="group__radio__registers.html#g5de4d4c246844ae9e84c535b3dc19dde" title="Value for AT86RF231.">RF231</a> ||    <span class="comment">// RF231</span>
<a name="l01091"></a>01091              <a class="code" href="group__radio.html#g2976f50bf538933d7eba0444494d6289" title="Returns the radio part number.">radioGetPartnum</a>() == <a class="code" href="group__radio__registers.html#ge7fc76de2ff765e0a0ee7273e2f3ec45" title="Value for AT86RF212.">RF212</a> ) &amp;&amp;      <span class="comment">// RF212</span>
<a name="l01092"></a>01092             (i == <a class="code" href="group__radio__registers.html#g359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a> ||
<a name="l01093"></a>01093              i == <a class="code" href="group__radio__registers.html#gfddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>))       <span class="comment">// Must be in rx to get random numbers</span>
<a name="l01094"></a>01094         {
<a name="l01095"></a>01095             <span class="comment">// Random number generator on-board</span>
<a name="l01096"></a>01096             <span class="comment">// has two random bits each read</span>
<a name="l01097"></a>01097             <span class="keywordflow">for</span> (i=0;i&lt;bits/2;i++)
<a name="l01098"></a>01098             {
<a name="l01099"></a>01099                 regval = <a class="code" href="group__arm.html#gbe3a54dd0c5f0231fb9ef72abd021486" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="group__radio__registers.html#g3be4cf6d4bde1365ea5f7271de52366f" title="Access parameters for sub-register RND_VALUE in register RG_PHY_RSSI.">SR_RND_VALUE</a>);
<a name="l01100"></a>01100                 val = (val &lt;&lt; 2) | regval;
<a name="l01101"></a>01101             }
<a name="l01102"></a>01102             <span class="keywordflow">return</span> val;
<a name="l01103"></a>01103         }
<a name="l01104"></a>01104         <span class="keywordflow">else</span>
<a name="l01105"></a>01105             <span class="comment">// use library function.</span>
<a name="l01106"></a>01106             <span class="keywordflow">return</span> rand();
<a name="l01107"></a>01107     }
<a name="l01108"></a>01108     <span class="keywordflow">else</span>
<a name="l01109"></a>01109         <span class="keywordflow">return</span> 0;
<a name="l01110"></a>01110 }
<a name="l01111"></a>01111 
<a name="l01118"></a>01118 <span class="keywordtype">void</span> radioSetBoost(u8 boost)
<a name="l01119"></a>01119 {
<a name="l01120"></a>01120     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#gb57e5c97e5d788f048284f1175c757b7" title="The BAND macro is set to one particular band based on which platform selected for...">BAND</a> == BAND900)
<a name="l01121"></a>01121     {
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123 }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125 <span class="keywordtype">void</span> radioSetModulation(u8 modulation)
<a name="l01126"></a>01126 {
<a name="l01127"></a>01127     <span class="comment">// create an enum of monulation types.</span>
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#gb57e5c97e5d788f048284f1175c757b7" title="The BAND macro is set to one particular band based on which platform selected for...">BAND</a> == BAND900)
<a name="l01129"></a>01129     {
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 <span class="keywordtype">void</span> radioSetup900(<span class="keywordtype">void</span>)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135     <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#gb57e5c97e5d788f048284f1175c757b7" title="The BAND macro is set to one particular band based on which platform selected for...">BAND</a> == BAND900)
<a name="l01136"></a>01136     {
<a name="l01137"></a>01137         <a class="code" href="group__radio.html#g9c32d026c082234626f5f900077221bc" title="This function will change the current state of the radio transceiver&amp;#39;s internal...">radioSetTrxState</a>(<a class="code" href="group__radio__registers.html#gd9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>);
<a name="l01138"></a>01138         <span class="comment">// Set datarate for RF212</span>
<a name="l01139"></a>01139         <span class="keywordflow">if</span> (<a class="code" href="group__mac.html#g036a88551664cfe893bc3f51a64ba179" title="When CHINA_MODE is set, there are only 4 channels (1-4).">CHINA_MODE</a>)
<a name="l01140"></a>01140         {
<a name="l01141"></a>01141             <span class="comment">// IEEE says only OQPSK RC at 250KBPS is valid</span>
<a name="l01142"></a>01142             <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g81791c12a60718398f0747eb2e9625d8" title="Offset for register TRX_CTRL_2.">RG_TRX_CTRL_2</a>, <a class="code" href="group__radio__registers.html#g4c2993ad0e3eed266048cbe9312de155" title="250 Kbps, RC filtering">OQPSK_RC_250</a>);
<a name="l01143"></a>01143             <span class="comment">// Max power</span>
<a name="l01144"></a>01144             <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g102bbda4e4354e6c5d42d73a8202476d" title="Offset for register PHY_TX_PWR.">RG_PHY_TX_PWR</a>, 0xe7); <span class="comment">// Plus 5dBm</span>
<a name="l01145"></a>01145             <span class="comment">// Set GC offset for O-QPSK.</span>
<a name="l01146"></a>01146             <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(SR_GC_TX_OFFS, 2);
<a name="l01147"></a>01147         }
<a name="l01148"></a>01148         <span class="keywordflow">else</span>
<a name="l01149"></a>01149         {
<a name="l01150"></a>01150             <span class="comment">// Choose one of many data rates (set in mac.h)</span>
<a name="l01151"></a>01151             <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g81791c12a60718398f0747eb2e9625d8" title="Offset for register TRX_CTRL_2.">RG_TRX_CTRL_2</a>, <a class="code" href="group__radio.html#g14778f0fb49f9a586ceffa5feb1d19b9" title="Define which data rate we are using (900MHz band only).">DATA_RATE_212</a>);
<a name="l01152"></a>01152 
<a name="l01153"></a>01153             <span class="keywordflow">if</span> (<a class="code" href="group__radio.html#g1fa4f1561216be34f745f32aaa38d943" title="Defines the platform for which we are building the firmware.">PLATFORM</a> == <a class="code" href="group__radio.html#g64beb6ec50cde53949697f65f7a024c9" title="TRT Button, model DSK001.">DSK001</a>)
<a name="l01154"></a>01154             {
<a name="l01155"></a>01155                 <span class="comment">// Max power</span>
<a name="l01156"></a>01156                 <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g102bbda4e4354e6c5d42d73a8202476d" title="Offset for register PHY_TX_PWR.">RG_PHY_TX_PWR</a>, 0x41); <span class="comment">//Plus 3 dBm</span>
<a name="l01157"></a>01157             }
<a name="l01158"></a>01158             <span class="keywordflow">else</span>
<a name="l01159"></a>01159             {
<a name="l01160"></a>01160                 <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g102bbda4e4354e6c5d42d73a8202476d" title="Offset for register PHY_TX_PWR.">RG_PHY_TX_PWR</a>, 0xC0); <span class="comment">//Plus 10 dBm</span>
<a name="l01161"></a>01161             }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 
<a name="l01164"></a>01164             <span class="comment">// Set GC offset</span>
<a name="l01165"></a>01165             <span class="keywordflow">if</span> ((<a class="code" href="group__radio.html#g14778f0fb49f9a586ceffa5feb1d19b9" title="Define which data rate we are using (900MHz band only).">DATA_RATE_212</a> == <a class="code" href="group__radio__registers.html#gf74d9e8577be730da66cb68ce7dac1c9" title="40 Kbps">BPSK_40</a>) ||
<a name="l01166"></a>01166                 (<a class="code" href="group__radio.html#g14778f0fb49f9a586ceffa5feb1d19b9" title="Define which data rate we are using (900MHz band only).">DATA_RATE_212</a> == <a class="code" href="group__radio__registers.html#g51aa7ee1cebbfc3c0cf1aea8c98f2b84" title="20 Kbps">BPSK_20</a>))
<a name="l01167"></a>01167             {
<a name="l01168"></a>01168                 <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(SR_GC_TX_OFFS, 3); <span class="comment">//Set to 3 for BPSK</span>
<a name="l01169"></a>01169             }
<a name="l01170"></a>01170             <span class="keywordflow">else</span>
<a name="l01171"></a>01171             {
<a name="l01172"></a>01172                 <a class="code" href="group__arm.html#g4e55279d2a68db6e6127b853baee2127" title="This function writes a new value to one of the radio transceiver&amp;#39;s subregisters...">hal_subregister_write</a>(SR_GC_TX_OFFS, 2); <span class="comment">//Set to 2 for OQPSK</span>
<a name="l01173"></a>01173             }
<a name="l01174"></a>01174         }
<a name="l01175"></a>01175         <span class="comment">// Turn up the backoff times</span>
<a name="l01176"></a>01176         <a class="code" href="group__arm.html#g6e9e307a1b8e39fa9261ee12ced67314" title="This function writes a new value to one of the radio transceiver&amp;#39;s registers...">hal_register_write</a>(<a class="code" href="group__radio__registers.html#g27a2452254bf5ec820d5f60254cc5c80" title="Offset for register CSMA_BE.">RG_CSMA_BE</a>, 0xfa);
<a name="l01177"></a>01177     }
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01183"></a>01183 <span class="comment">/*EOF*/</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jun 8 18:38:19 2009 for RUM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
