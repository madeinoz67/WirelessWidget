#summary WidgetMesh Association Requests with Sequence Diagrams
----
<wiki:toc max_depth="3" />
----
=Requirements=
  * Network Gateway/Coordinator - The Network Gateway manages the network and the join requests.

Join Requests are sent either directly to the Gateway node or Indirectly via other nodes already associated in the network.

Once Associated with the network a WidgetNode will have its TDMA schedule sent to it by the gateway/coordinator node as part of the association request.  The Gateway can also update nodes TDMA schedules in the network with additional neighbour links based on link quality / battery life etc, to create a fully meshed network.

==Association Request Parent Selection==
Association Request Parent selection could be be determined by:
  * RSSI - Stronger RSSI is better than lower RSSI. 
  * NodeId - Lowest NodeId is first choice.  Gateway/Coordinator always has NodeId of 0x0000 so is always the lowest and therefore 1st choice if detected.

==Node Routing==
All nodes in the network can act as a routing device, but depending on their power requirements, i.e. very low battery life through to mains connected, will determine how they route packets.  i.e. a low powered devices may only route packets in the event there is no other paths back to the gateway.  While a mains connected devices will always route packets.

=Example=
In the following example Widgets W2 and W3 are not associated with the network.

|| UnAssociated || Associated || Meshing|| Meshed||
||http://strobit.googlecode.com/svn/wiki/images/widgetmesh/networkAssociation.png||http://strobit.googlecode.com/svn/wiki/images/widgetmesh/networkAssociation2.png || http://strobit.googlecode.com/svn/wiki/images/widgetmesh/networkAssociation3.png || http://strobit.googlecode.com/svn/wiki/images/widgetmesh/networkAssociation4.png ||

==Direct Association==

http://strobit.googlecode.com/svn/wiki/images/widgetmesh/DirectNetworkAssociation.png

  # Node W2 Powers up in "Provisioned" state
  # Node W2 Listens for Parent/Neighbour candidates. It detects devices GW and W1 as likely candidates. 
  # W2 determines that GW is the best Node for a parent.
  # W2 Sends a DirectJoinRequest to GW and state changes to "Joining" state.
  # GW Adds W2 to the Network Node table
     # Assigns TDMA Slots.
     # Assigns Short Address.
     # Assigns Parent Node as itself(GW).
  # GW sends a DirectJoinResponse Packet containing above information to W2
  # W2 updates Neighbour Table with Join Response data and in now in "Associated" State

==Indirect Association==
http://strobit.googlecode.com/svn/wiki/images/widgetmesh/IndirectNetworkAssociation.png
  # Node W3 Powers up in "Provisioned" state
  # Node W3 Listens for Parent/Neighbour candidates.  It detects devices W1 and W2 as likely candidates. GW is not detected.
  # W3 determines that W1 is the best Node for a parent due to RSSI strength.
  # W3 Sends a direct Join request to W1 and stae changes to "Joining" state.
  # W1 Receives DirectJoinRequest and changes it to Type IndirectJoinRequest and requeues Packet for GW  
  # GW receives IndirectJoinRequest and adds W3 to the Network Node table
     # Assigns TDMA Slots.
     # Assigns Short Address.
     # Assigns Parent Node(W1).
  # GW sends an IndirectJoinResponse Packet containing above information to W1
  # W1 receives IndirectJoinResponse packet and changes type to DirectResponsePacket and requeues to W3
  # W3 updates Neighbour Table with Join Response data and in now in "Associated" State